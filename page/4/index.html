<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>土豆不好吃</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="土豆不好吃">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="土豆不好吃">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Benny小土豆">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="土豆不好吃" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">土豆不好吃</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-linux-lipo/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/13/linux-lipo/index/" class="article-date">
  <time class="dt-published" datetime="2022-09-13T00:00:00.000Z" itemprop="datePublished">2022-09-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/13/linux-lipo/index/">在Linux下使用lipo创建 universal macOS binary</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>macOS的应用程序可以同时包含多种架构，最常见的是包含arm64和amd64这两种。操作系统会自动选择执行最合适的架构，避免使用rosetta 2.</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/09/2022091220433923.png"><img src="/images/2022091220433923.png"></a></p>
<h2 id="创建universal-binary"><a href="#创建universal-binary" class="headerlink" title="创建universal binary"></a>创建universal binary</h2><p>在macOS中，自带一个工具 <code>lipo</code>，可以用来合并、提取、显示这种universal binary的信息。</p>
<p>比如我想创建一个universal binary，可以这样做</p>
<p># lipo -create -output universal amd64 arm64</p>
<h1 id="file-universal"><a href="#file-universal" class="headerlink" title="file universal"></a>file universal</h1><p>universal: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64Mach-O 64-bit executable x86_64] [arm64]<br>universal (for architecture x86_64): Mach-O 64-bit executable x86_64<br>universal (for architecture arm64): Mach-O 64-bit executable arm64</p>
<p>可以把某个架构的binary提取出来，<code>-extract</code></p>
<p># lipo -extract x86_64 -output amd universal</p>
<h1 id="file-amd"><a href="#file-amd" class="headerlink" title="file amd"></a>file amd</h1><p>amd: Mach-O universal binary with 1 architecture: [x86_64:Mach-O 64-bit executable x86_64Mach-O 64-bit executable x86_64]<br>amd (for architecture x86_64): Mach-O 64-bit executable x86_64</p>
<p>也可以用来显示binary的一些信息</p>
<p>&gt; $ lipo -detailed_info universal<br>Fat header in: universal<br>fat_magic 0xcafebabe<br>nfat_arch 2<br>architecture x86_64<br>    cputype CPU_TYPE_X86_64<br>    cpusubtype CPU_SUBTYPE_X86_64_ALL<br>    capabilities 0x0<br>    offset 4096<br>    size 1181264<br>    align 2^12 (4096)<br>architecture arm64<br>    cputype CPU_TYPE_ARM64<br>    cpusubtype CPU_SUBTYPE_ARM64_ALL<br>    capabilities 0x0<br>    offset 1196032<br>    size 1190706<br>    align 2^14 (16384)</p>
<h2 id="Linux下创建universal-binary替代品"><a href="#Linux下创建universal-binary替代品" class="headerlink" title="Linux下创建universal binary替代品"></a>Linux下创建universal binary替代品</h2><p>可惜Linux上竟然没有对应的lipo。对于那些用Go写的应用程序，天生就支持交叉编译，那为了在release发布一个universal binary，还得自己合并，或者GitHub Actions跑一个macOS？也不是不行，就是太麻烦啦！</p>
<p>但是不怕，universal binary的技术细节是公开的，并且Apple开源了lipo对应的代码，可以看<a target="_blank" rel="noopener" href="https://github.com/apple-oss-distributions/cctools">cctools</a>. 非常幸运的是还有一个人给port到了Linux，<a target="_blank" rel="noopener" href="https://github.com/tpoechtrager/cctools-port">https://github.com/tpoechtrager/cctools-port</a></p>
<p>那么为了在Linux下创建这样的universal binary，要么就去读技术细节，参考官方的C语言实践，自己用其他语言写一个；要么就直接用现成的cctools-port，编译一个lipo，直接用即可。</p>
<h2 id="Linux-lipo"><a href="#Linux-lipo" class="headerlink" title="Linux-lipo"></a>Linux-lipo</h2><p>我比较菜，大概读不懂那些难度很高的文档，还得看十六进制，因此我选择直接用官方的代码。</p>
<p>于是我就做了一个docker image，只要传递过来参数，就可以创建universal binary</p>
<p>比如我写了这样的简单的Go代码，打印出运行时的架构</p>
<p>package main</p>
<p>import “runtime”</p>
<p>func main() {<br>    &#x2F;&#x2F; print architecture info<br>    println(“Architecture:”, runtime.GOARCH)<br>}</p>
<p>然后编译两个不同架构的binary</p>
<p>GOOS&#x3D;darwin GOARCH&#x3D;amd64 go build -o amd64 .<br>GOOS&#x3D;darwin GOARCH&#x3D;arm64 go build -o arm64 .</p>
<blockquote>
<p>$ file amd64 arm64<br>amd64: Mach-O 64-bit executable x86_64<br>arm64: Mach-O 64-bit executable arm64</p>
</blockquote>
<p>然后就可以这样创建出来universal binary</p>
<p>docker run –rm -v $(pwd):&#x2F;app&#x2F; bennythink&#x2F;lipo-linux -create -output universal amd64 arm64</p>
<p>或者extract啊什么的都行的。只要你想，甚至可以把这个docker image里的lipo提取出来用，问题不大。</p>
<p> </p>
<h2 id="也许可以……"><a href="#也许可以……" class="headerlink" title="也许可以……"></a>也许可以……</h2><p>如果你的Mac的存储空间严重不足，也许可以考虑把那些fat binary给瘦身一下。毕竟两个架构，体积翻倍。framework之类的也可以瘦身，就看能不能找到。比如说word的话……可以考虑瘦身一下这个文件，80M变40M🤣</p>
<p>Microsoft Word.app&#x2F;Contents&#x2F;MacOS&#x2F;Microsoft Word</p>
<p>效果还是有的，70%左右吧😂 <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/09/2022091623192693.png"><img src="/images/2022091623192693.png"></a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>A deep dive on macOS universal binaries</p>
<p><a target="_blank" rel="noopener" href="https://www.jviotti.com/2021/07/23/a-deep-dive-on-macos-universal-binaries.html">https://www.jviotti.com/2021/07/23/a-deep-dive-on-macos-universal-binaries.html</a></p>
<p>Building a Universal macOS Binary</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/apple-silicon/building-a-universal-macos-binary">https://developer.apple.com/documentation/apple-silicon/building-a-universal-macos-binary</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/09/13/linux-lipo/index/" data-id="clhp7rthe004os2qra61g0589" data-title="在Linux下使用lipo创建 universal macOS binary" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-m1-aom/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/26/m1-aom/index/" class="article-date">
  <time class="dt-published" datetime="2022-08-26T00:00:00.000Z" itemprop="datePublished">2022-08-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/26/m1-aom/index/">在M1 Mac下开发WebP Server Go</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近换了M1的Mac，成为了ARM芯片的受害者。在尝试用Go运行WebP Server Go的时候出错了</p>
<p><img src="/images/2022082608305257.jpeg" alt="图形用户界面, 文本, 应用程序 描述已自动生成"></p>
<p>看起来是没有安装aom，但是<code>brew install</code>了一下还是有的啊。另一边的Intel Mac就没这个问题。</p>
<p>╰─$ ls &#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;aom<br>aom.h aom_external_partition.h aomcx.h<br>aom_codec.h aom_frame_buffer.h aomdx.h<br>aom_decoder.h aom_image.h<br>aom_encoder.h aom_integer.h</p>
<p>头文件明明是有的！</p>
<p>想了一下， 原因可能是因为M1的homebrew会把相关的依赖安装到 <code>/opt/homebrew</code>下，而不像Intel的版本会丢在<code>/usr/local/</code>下，而<code>/usr/local/</code>大概率是gcc默认的搜索路径。所以gcc compiler找不到对应的头文件了。</p>
<p>创建了一个简单的<code>test.c</code> 验证一下</p>
<p>#include<br>#include<br>#include &lt;aom&#x2F;aom_encoder.h&gt;<br>int main() {<br>   &#x2F;&#x2F; printf() displays the string inside quotation<br>   printf(“Hello, World!”);<br>   return 0;<br>}</p>
<p>╰─$ gcc test.c test.c:3:10: fatal error: ‘aom&#x2F;aom_encoder.h’ file not found #include &lt;aom&#x2F;aom_encoder.h&gt; ^~~~~~~~~~~~~~~~~~~ 1 error generated.</p>
<p>果真如此，那么就export一下CFLAGS吧</p>
<p>╰─$ export CFLAGS&#x3D;I&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F; 1 ↵<br>╭─benny@MBP ~&#x2F;Downloads<br>╰─$ gcc test.c<br>test.c:3:10: fatal error: ‘aom&#x2F;aom_encoder.h’ file not found<br>#include &lt;aom&#x2F;aom_encoder.h&gt;<br>^~~~~~~~~~~~~~~~~~~<br>1 error generated.</p>
<p>依旧报错。为什么CFLAGS不生效呢？</p>
<p>试试把aom符号连接到 <code>/usr/local/include</code>？ 这个目录应该是默认搜索的。</p>
<p>❯ ln -s &#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;aom &#x2F;usr&#x2F;local&#x2F;include<br>~&#x2F;Downloads<br>❯ gcc test.c</p>
<p>没有报错，证明我的推断是正确的。</p>
<p>突然想到，macOS的这个gcc，其实是clang啊，那么是不是和正常的gcc用的环境变量不同？搜了一下还真是，clang应该用<code>CPATH</code>，<code>C_INCLUDE_PATH</code> 和<code>CPLUS_PATH</code>之类的，具体可以参考这里 <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/CommandGuide/clang.html">https://clang.llvm.org/docs/CommandGuide/clang.html</a></p>
<p>把符号连接删掉，再试试看！</p>
<p>└&gt; gcc test.c<br>test.c:3:10: fatal error: ‘aom&#x2F;aom_encoder.h’ file not found<br>#include &lt;aom&#x2F;aom_encoder.h&gt;<br>^~~~~~~~~~~~~~~~~~~<br>1 error generated.<br>┌[kiwish-4.2]-(<del>&#x2F;Downloads)-<br>└&gt; export CPATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;<br>┌[kiwish-4.2]-(</del>&#x2F;Downloads)-<br>└&gt; gcc test.c</p>
<p>果真如此！于是Goland加一个环境变量，再次编译</p>
<p>&#x2F;opt&#x2F;homebrew&#x2F;Cellar&#x2F;go&#x2F;1.19&#x2F;libexec&#x2F;pkg&#x2F;tool&#x2F;darwin_arm64&#x2F;link: running clang failed: exit status 1<br>ld: library not found for -laom<br>clang: error: linker command failed with exit code 1 (use -v to see invocation)</p>
<p>看起来是LDFLAGS的问题，猜测clang还是用的奇奇怪怪的环境变量。先link一下看看</p>
<p>ln -s &#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;lib&#x2F;* &#x2F;usr&#x2F;local&#x2F;lib&#x2F;</p>
<p>再运行，果真好了。那么如何用环境变量解决问题呢？我不太喜欢在系统目录里link来link去的。</p>
<p>搜了一圈，正确的环境变量的名字叫<code>LIBRARY_PATH</code></p>
<p>LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;lib&#x2F;</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Clang真坑</p>
<p>设置两个环境变量就好了</p>
<p>CPATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;include&#x2F;;LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;homebrew&#x2F;opt&#x2F;aom&#x2F;lib&#x2F;</p>
<p><img src="/images/2022082608305373.png" alt="文本 中度可信度描述已自动生成"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/26/m1-aom/index/" data-id="clhp7rthi004ss2qr85fk9fvn" data-title="在M1 Mac下开发WebP Server Go" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-go-selenium/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/23/go-selenium/index/" class="article-date">
  <time class="dt-published" datetime="2022-07-23T00:00:00.000Z" itemprop="datePublished">2022-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/23/go-selenium/index/">Go 使用selenium截图</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今天想给<a target="_blank" rel="noopener" href="https://t.me/wayback_machine_bot">wayback machine bot</a>增加一个截图的功能，难度不大，用selenium打开浏览器，截图，再发给用户就可以了。</p>
<p>网上随便就可以找到教程，比如说这样</p>
<p>package main</p>
<p>import (<br>    “fmt”<br>    log “github.com&#x2F;sirupsen&#x2F;logrus”<br>    “github.com&#x2F;tebeka&#x2F;selenium”<br>    “io&#x2F;ioutil”<br>)</p>
<p>const (<br>    chromeDriverPath &#x3D; “&#x2F;usr&#x2F;local&#x2F;bin&#x2F;chromedriver”<br>    port &#x3D; 9515<br>)</p>
<p>func main() {<br>    var opts []selenium.ServiceOption<br>    selenium.SetDebug(false)<br>    service, err :&#x3D; selenium.NewChromeDriverService(chromeDriverPath, port, opts…)<br>    if err !&#x3D; nil {<br>        panic(err) &#x2F;&#x2F; panic is used only as an example and is not otherwise recommended.<br>    }<br>    defer service.Stop()</p>
<pre><code>caps := selenium.Capabilities&#123;&quot;browserName&quot;: &quot;chrome&quot;&#125;
wd, err := selenium.NewRemote(caps, fmt.Sprintf(&quot;http://localhost:%d/wd/hub&quot;, port))
if err != nil &#123;
    panic(err)
&#125;

defer wd.Quit()
if err := wd.Get(&quot;https://github.com/tgbot-collection/archiver&quot;); err != nil &#123;
    panic(err)
&#125;

screenshot, err := wd.Screenshot()
if err != nil &#123;
    log.Errorln(err)

&#125;
ioutil.WriteFile(&quot;screenshot.png&quot;, screenshot, 0644)
</code></pre>
<p>}</p>
<p><img src="/images/2022072320584942.png"></p>
<p>但是问题来了，这里的截屏只有当前窗口，怎么把整个页面都截屏了呢？</p>
<h2 id="整页截屏"><a href="#整页截屏" class="headerlink" title="整页截屏"></a>整页截屏</h2><p>方法还是有的，一个简单的办法就是获取到网页的宽高，然后把浏览器的窗口设置成这么大，然后再截图就好了！需要注意的是只有headless模式可以任意设置窗口大小，否则最大高度不能超过你的显示器分辨率</p>
<p>设置headless只需要加个参数就好了，如下</p>
<p>caps :&#x3D; selenium.Capabilities{“browserName”: “chrome”}<br>    chromeCaps :&#x3D; chrome.Capabilities{<br>        Path: “”,<br>        Args: []string{<br>            “–headless”,<br>        },<br>    }<br>    caps.AddChrome(chromeCaps)<br>    wd, err :&#x3D; selenium.NewRemote(caps, fmt.Sprintf(“<a href="http://localhost:%d/wd/hub">http://localhost:%d/wd/hub</a>“, port))</p>
<p>获取网课宽高很容易，偷懒的话只要获取网页的高就可以了，宽我们可以固定成固定的像素，比如1920.</p>
<p>在chrome的控制台里，输入这么一串神秘代码可获得网页的高</p>
<p>document.body.parentNode.scrollHeight</p>
<p>在selenium中使用<code>ExecuteScript</code>就可以执行JavaScript代码，需要注意返回值是interface，所以要类型断言成float，然后再转成int</p>
<p>height, _ :&#x3D; wd.ExecuteScript(“return document.body.parentNode.scrollHeight”, nil)<br>var realHeight &#x3D; int(height.(float64))</p>
<p>然后我们需要设置窗口大小</p>
<p>wd.ResizeWindow(“”, 1920, realHeight)</p>
<p>运行一下看看，果然正确且完美</p>
<h2 id="在服务器中运行"><a href="#在服务器中运行" class="headerlink" title="在服务器中运行"></a>在服务器中运行</h2><p>必然这个东西是要在某台服务器中跑起来的，也没什么不同的，下载自己的webdriver，安装浏览器，照样headless启动就好了。应该不会遇到大问题</p>
<h2 id="在容器中运行"><a href="#在容器中运行" class="headerlink" title="在容器中运行"></a>在容器中运行</h2><p>理论上来说，在容器中运行和在某个Linux发行版运行是没什么太大差别的。无非就是找到对应的webdriver。比如我经常用的alpine恰巧提供了chrome和chrome-webdriver，并且有amd64和arm64(aarch64)的预编译包</p>
<p>直接运行 <code>apk add chromium-chromedriver</code> 浏览器和webdriver会一起安装好</p>
<p>要注意一件事情，如果你是root用户运行的，那么要加上<code>--no-sandbox</code> 参数</p>
<p>一运行却发现结果不如人意，总是写入0大小的文件，或者报错</p>
<p><img src="/images/2022072320585057.png"></p>
<p>强行加一行sleep，会有比较大的概率会避免这个问题，但是这不是个办法嘛。</p>
<p>if err :&#x3D; wd.Get(“<a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a>“); err !&#x3D; nil {<br>    panic(err)<br>}<br>time.Sleep(10 * time.Second)</p>
<p>后来搜了一下，是Chrome和 container的兼容性问题，Chrome需要比较大的<code>/dev/shm</code>，然而容器中的<code>/dev/shm</code>往往都比较小，对于Chrome这种内大户来说不太行。</p>
<p><img src="/images/2022072320585144.png"></p>
<p>解决方法要么就增大容器里的<code>/dev/shm</code>，可以通过run时额外参数<code>--shm-size=256m</code></p>
<p><img src="/images/2022072320585236.png"></p>
<p>也可以直接把宿主机的共享进去</p>
<p>docker run –rm -v &#x2F;dev&#x2F;shm:&#x2F;dev&#x2F;shm -it alpine sh</p>
<p>也可以禁用Chrome的shm功能，加一个参数</p>
<p>“–disable-dev-shm-usage”,</p>
<p>还有一种办法，换Firefox也许也有救。</p>
<h2 id="中文乱码"><a href="#中文乱码" class="headerlink" title="中文乱码"></a>中文乱码</h2><p>alpine里没带中文字体，所以中文会乱码。可以用alpine自带的一个，这样安装就好，也可以自己偷字体，然后放到<code>/usr/share/fonts/</code> 就好了</p>
<p>apk add wqy-zenhei –update-cache –repository <a target="_blank" rel="noopener" href="https://nl.alpinelinux.org/alpine/edge/testing">https://nl.alpinelinux.org/alpine/edge/testing</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/53970825/10264400">https://stackoverflow.com/a/53970825/10264400</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/archiver/blob/master/screenshot.go">https://github.com/tgbot-collection/archiver/blob/master/screenshot.go</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/23/go-selenium/index/" data-id="clhp7rtge0038s2qr3i7g30pn" data-title="Go 使用selenium截图" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-change-git-user/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/13/change-git-user/index/" class="article-date">
  <time class="dt-published" datetime="2022-06-13T00:00:00.000Z" itemprop="datePublished">2022-06-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/13/change-git-user/index/">如何更改git commit user？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>乔治·奥威尔有言</p>
<blockquote>
<p>历史不是一面镜子，而是黑板上的记号，可以随时擦去，随时填补。更为可怕的是，一旦涂改了，你找不到证据去证明这是篡改历史的行为。</p>
</blockquote>
<p>Git会追踪每一次commit的历史记录，如果之前不小心配置错了用户名，那么有办法改掉吗？</p>
<p>当然了办法是有的，改掉commit username和email是很容易的，不就是这么几行嘛？</p>
<p>git rebase -i f25f719f7c2333d310696c3ed41e5a90ed078e55</p>
<p>弹出的交互式窗口，把要改的commit从<code>pick</code>改成<code>edit</code></p>
<p><img src="/images/2022061322415582.png"></p>
<p>然后不停地</p>
<p>git commit –amend –author&#x3D;”Cool <a href="mailto:&#x63;&#111;&#x6f;&#108;&#x40;&#103;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#x6f;&#x6d;">&#x63;&#111;&#x6f;&#108;&#x40;&#103;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#x6f;&#x6d;</a>“ –no-edit &amp;&amp; git rebase –continue</p>
<p>就可以了</p>
<p><img src="/images/2022061322415653.png"></p>
<p>事实果真如此吗？<code>git push -fv</code>试试看？</p>
<p><img src="/images/2022061322415838.png"> <a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/06/2022061322453057.jpg"><img src="/images/2022061322453057.jpg"></a></p>
<hr>
<p>妈勒个巴子，时间不对啊，明明是Feb的怎么就变成了现在的时间了。这不就露馅了吗！</p>
<p>千辛万苦找到一个名字叫<a target="_blank" rel="noopener" href="https://github.com/newren/git-filter-repo">git-filter-repo</a>的东西，试了一下是可以的。</p>
<p>先安装，比如说 <code>apt install git-filter-repo</code></p>
<p>然后创建一个<code>mailmap</code>文件，格式如下</p>
<p>New <a href="mailto:&#x6e;&#101;&#x77;&#64;&#x67;&#109;&#x61;&#105;&#108;&#46;&#x63;&#111;&#x6d;">&#x6e;&#101;&#x77;&#64;&#x67;&#109;&#x61;&#105;&#108;&#46;&#x63;&#111;&#x6d;</a> BennyThink <a href="mailto:&#x62;&#x65;&#110;&#110;&#121;&#46;&#116;&#104;&#x69;&#110;&#107;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#x6f;&#x6d;">&#x62;&#x65;&#110;&#110;&#121;&#46;&#116;&#104;&#x69;&#110;&#107;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#x6f;&#x6d;</a></p>
<p>如有需要可以写多行</p>
<p>然后</p>
<p>git filter-repo –mailmap &#x2F;etc&#x2F;mailmap</p>
<p>然后再push，如果遇到缺失remote的问题，重新添加一下</p>
<p>git remote add origin <a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/history">https://github.com/tgbot-collection/history</a><br>git push –set-upstream origin master -fv</p>
<p>优秀吧！全变成对应的名字和邮箱了，并且commit的时间也没有改变。<code>git log</code>和GitHub是一致的。</p>
<p><img src="/images/2022061322420811.png"></p>
<p>如果想要只改几个commit的邮箱，那怎么办呢？</p>
<p>比如说只想改前两个</p>
<p>git filter-repo –refs master~2..master –mailmap &#x2F;etc&#x2F;mailmap</p>
<p><img src="/images/2022061322420927.png"></p>
<p>如果想改某个中间的一些commit的邮箱为某个人、并且还不改变GitHub上显示的时间呢？甚至不敢确定这种是否可行😂</p>
<p>emmm这个我还不太知道，其实不太知道refs是什么意思，尝试了很久也不行</p>
<p>看到git-filter-repo里写着</p>
<p>git filter-repo … –refs C..H<br>git filter-repo … –refs C..H ^D<br>git filter-repo … –refs D..H ^C</p>
<p>H应该指的是HEAD？</p>
<p>总之，暂时够用了😂</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/13/change-git-user/index/" data-id="clhp7rtek000qs2qrhtvr4bqs" data-title="如何更改git commit user？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-rssbot-down-again/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/27/rssbot-down-again/index/" class="article-date">
  <time class="dt-published" datetime="2022-05-27T00:00:00.000Z" itemprop="datePublished">2022-05-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/05/27/rssbot-down-again/index/">为什么我的rssbot又不好用了？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今晚想在rssbot上订阅一个博客，发现发了消息竟然没反应。心想可能是容器挂了，上去重启一下。</p>
<p><img src="/images/2022052721363834.jpeg"></p>
<p>竟然还没好，而且发现logs里有这么怪的一行</p>
<blockquote>
<p><strong>error:</strong> <strong>Error</strong>(“expected `,` or `}`“, line: 2, column: 2388),</p>
</blockquote>
<p>这啥？</p>
<p><code>rssbot.json</code> 坏了？用<code>json.load</code> 试了一下没问题</p>
<p>程序有问题？触发了一个GitHub actions，从release里下载了binary，也没问题</p>
<p>Rust的json解析有问题？弄了一个空的json文件，也还是同样报错。</p>
<p>网络问题？明明是直接在梯子上运行的。</p>
<p>容器问题？直接跑在alpine的容器里，host OS上，也不行</p>
<p><img src="/images/2022052721363814.jpeg" alt="挠头表情包_抖音熊猫挠头表情包套图下载_游戏吧"></p>
<p>Bot的token失效了？revoke重新生成一个，还不行。</p>
<p>换个其他bot的token，竟然可以了。</p>
<p><img src="/images/2022052721363947.png"></p>
<p>难道是我的rssbot 被Durov扬了？拿起来 bot HTTP api试试看</p>
<p>import telebot<br>from telebot import apihelper<br>import logging</p>
<p>logging.basicConfig(level&#x3D;logging.INFO)<br>apihelper.proxy &#x3D; {‘https’: ‘socks5h:&#x2F;&#x2F;127.0.0.1:1080’}<br>TOKEN &#x3D; “548k4qc”<br>bot &#x3D; telebot.TeleBot(TOKEN)<br>print(bot.get_me())</p>
<p>活着呢啊……</p>
<p>那是不是incoming message被扬了？</p>
<p>@bot.message_handler(commands&#x3D;[‘start’, ‘help’])<br>def send_welcome(message):<br>    bot.reply_to(message, “Howdy, how are you doing?”)</p>
<p>if __name__ &#x3D;&#x3D; ‘__main__‘:<br>    bot.polling()</p>
<p><img src="/images/2022052721364143.png"></p>
<p>也好用啊……</p>
<p>那再跑一次？竟然好了……</p>
<h2 id="推测原因"><a href="#推测原因" class="headerlink" title="推测原因"></a>推测原因</h2><p>不知道为什么莫名其妙的就好了，前前后后花了一个多小时的时间。</p>
<p>推测是，由于这个程序写的有些bug，导致没能处理用户发送的消息，然后telegram Bot API会缓存一定数量的消息，当用户开始polling时会发送updates。但是由于有bug，导致bot无法处理updates，所以所有后续的updates都被block住了。</p>
<p>当我用Python版本开始polling时，updates就被处理完成了，导致rssbot出bug的那个update也被消耗掉了。</p>
<p>🤦‍♂️算了我要切换到inoreader了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/27/rssbot-down-again/index/" data-id="clhp7rtip007vs2qr3d2lef60" data-title="为什么我的rssbot又不好用了？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-who-view-micam/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/30/who-view-micam/index/" class="article-date">
  <time class="dt-published" datetime="2022-04-30T00:00:00.000Z" itemprop="datePublished">2022-04-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/30/who-view-micam/index/">谁看了我的米家摄像头？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>一年前，由于一个有些可笑的原因（别问我为什么，真的），我买了个米家的摄像头，然后分享给了某个人。那个时候我在想，有没有办法随时知道谁看了监控呢？管他是某个人还是其他什么奇奇怪怪的人。</p>
<p>米家本身并不提供这种功能，也不像其他品牌一样在摄像头被查看的时候会有一个特殊的指示灯显示。</p>
<p>既然如此，那作为一名有灵性的工程师，一定能找到办法的！</p>
<p>简单的说，自然就要从网络上下手啦！毕竟这个东西是需要通过网络传输数据的，在其他人查看的时候一定会大量的传输数据，并且根据常识推断，极有可能是UDP，并且有可能通过UDP打洞的方式直接看到查看者的IP地址。</p>
<p>话不多说，说干就干，老子干网络这么多年，还不是 permit any any 通了就走！</p>
<h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p>既然要抓包，那自然也就在路由器上动手脚最好了。此时需要一个刷了padavan、OpenWRT、Merlin之类第三方固件的路由器，然后准备好tcpdump</p>
<p>tcpdump可以使用opkg之类的命令安装，如果你的CPU恰巧是arm的，可以<a target="_blank" rel="noopener" href="https://fw.koolcenter.com/binary/tcpdump/">用这个</a>静态编译的。</p>
<p>假设摄像头的IP是192.168.7.149，然后路由器的网桥是br-lan（有些可能是br0）</p>
<p>tcpdump -i br-lan udp and host 192.168.7.149</p>
<p>此时打开手机，最好用流量来测试IP，查看摄像头，大概率会看到类似如下日志：</p>
<p><img src="/images/2022043021474977.png"></p>
<p>如果没有的话，去掉UDP试试看。再没有就看看接口和IP对不对，有些情况下抓对应的wlan01可能更好。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>此时右侧的那个疯狂刷屏39.xxxx就是我的手机数据流量的出口IP，中国移动的某个IP。有些时候会看到一些金山云的IP，可以直接忽略。</p>
<p>那么接下来问题来了</p>
<ol>
<li>只有刷屏的IP才算是可能的查看记录，有什么办法揪出来吗？</li>
<li>咱也不能时时刻刻盯着tcpdump的输出啊！</li>
</ol>
<h2 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h2><p>只有刷屏的IP才可能是查看记录，那么如何分析统计这个“刷屏频率”？最好的办法就是令牌桶算法啦！</p>
<p>所谓令牌桶，就是设计一个桶，某个组件持续地往里面丢令牌（token），然后每个请求进来的时候去这里拿令牌，拿到了就执行，拿不到就只能等着了。</p>
<p>令牌桶通常用于限流，我们的这个恰巧是“反着来的限流”，反正只要撞了rate limit就是我们要的数据。</p>
<p>记得先写正则表达式过滤一下。</p>
<p>为了方便在路由器上运行，这事必然是要用Go来写的，毕竟交叉编译嘛</p>
<p>package main</p>
<p>import (<br>    log “github.com&#x2F;sirupsen&#x2F;logrus”<br>    “golang.org&#x2F;x&#x2F;time&#x2F;rate”<br>)</p>
<p>const (<br>    bucketSize &#x3D; 70<br>    bucketRate &#x3D; 35<br>)</p>
<p>var limiter &#x3D; rate.NewLimiter(bucketRate, bucketSize)</p>
<p>func main() {</p>
<pre><code>if limiter.Allow() &#123;
    log.Infoln(&quot;Using token...&quot;)
&#125; else &#123;
    log.Warnln(&quot;Potential view, sending alert now...&quot;)
&#125;
</code></pre>
<p>}</p>
<p>很简单，定义了一个桶，大小是70，每秒钟产生35个令牌，说人话：每秒钟抓到35个包，刚好可以抵消令牌桶消耗；每秒抓到40个包，大概8秒会报警。至于这个35和70是怎么设计的嘛，是我从实践与经验中发现这个值最稳妥、最不容易误报。</p>
<h2 id="消息通知"><a href="#消息通知" class="headerlink" title="消息通知"></a>消息通知</h2><p>消息通知就很简单了，当 <code>limiter.Allow()</code> 不满足时，直接telegram bot就行了，这样最方便。</p>
<p>代码太过简单，就不说了</p>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>真挺准的！俗话说知己知彼，百战不殆反正我是认输了，权限也已经撤销了。因为我发现我就是“充话费送的”。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2022/04/2022043021541218.jpeg"><img src="/images/2022043021541218.jpeg"></a></p>
<p>也真的挺不好意思的我这玩意藏着掖着，快一年了才放出来……</p>
<p><img src="/images/2022043021481460.png"></p>
<h2 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/BennyThink/c78cefa446fc492209710796ee342dec">https://gist.github.com/BennyThink/c78cefa446fc492209710796ee342dec</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/30/who-view-micam/index/" data-id="clhp7rtn600b5s2qr13ef50zq" data-title="谁看了我的米家摄像头？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-spring-shanghai/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/23/spring-shanghai/index/" class="article-date">
  <time class="dt-published" datetime="2022-04-23T00:00:00.000Z" itemprop="datePublished">2022-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/23/spring-shanghai/index/">被偷走了春天的上海</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>3月初，在传言华亭宾馆的事件之后，有朋友劝我赶紧跑。道理我是懂的，换成往常我也肯定像香港记者一样跑了。可是在有两只猫的情况下，不知道该怎么带走。送去寄养太不靠谱了，无奈只能选择留下。</p>
<p>虽然人走不了，但是总还是可以做一些准备的。本着我的“没有好下场”理论，我去天猫超市买了很多速冻水饺、手抓饼、水果零食、奶粉什么的。检查了下猫粮，还有一袋半，应该足够坚持两个月了。</p>
<p>3月2日星期三，走了小区门去了一趟公司。谁曾想这竟然是我最后一次踏出小区门呢。</p>
<p>因为害怕猫被杀死，从那天起我就再也没有长时间的出去，即使下楼也都是扔个垃圾然后赶快回来。</p>
<p>3月上旬，我的单元楼内有密接，于是单元楼被封了起来。从此我的铁窗生活正式拉开了帷幕。</p>
<p>3月下旬，事情你们都知道了。沿着黄浦江进行分区域封城，好像鸳鸯锅一样，留给浦东人准备物资的时间只有几个小时。</p>
<p><img src="/images/2022042323554012.jpeg"></p>
<p>往日繁华的陆家嘴突然变得空空荡荡。</p>
<p>4月5日解封的承诺落了空，20日全面清零的目标也没见成效。每天被无数的负面情绪冲击着，已经开始逐渐变得麻木，见怪不怪了。</p>
<p>一个月停工5天，并不意味着损失5&#x2F;30的产能；一年停工一个月，也并不意味着损失1&#x2F;12的产能。这不是简单的数学题。</p>
<p>时至如今，我也看不到有什么可以翘首以待的日子了。心心念念的人生病了，焦虑万分却又无能为力。</p>
<p>这是一个本应该踏青春游的季节，是万物复苏的季节，是不远万里的去见喜欢的人的季节。可是现在却只能被封在家里，看不到解封的可能。</p>
<p>即使解封了，上海人也会被其他省市当作瘟神一样对待吧？恨不得就地正法。</p>
<p>如果没有猫，我是不是早就逃跑了？可是如果没有猫，一个人的铁窗生活也应该会崩溃的吧？</p>
<p>如果没遇见你，我是不是不会这样忧心？可是如果没有遇见你，我又怎样会对未来有了一点点的希望？</p>
<hr>
<p>Lockdown for 89 days.</p>
<p>七年前在加入人人影视的时候，在新人群里被一个姑娘私聊了。也许因为她的名字是A，我的名字是B，在她的下面第一个人就是我，所以就找到了我。无论原因如何，我猜这应该是destiny吧，人和人之间有时候就是这样神奇。</p>
<p> </p>
<p>她的声音非常好听，温柔且细腻，像小孩子一样轻柔，但是又不失成年人的稳重。她的声音有一种能够让人听一次就喜欢上的魔力。</p>
<p>如果说字如其人很夸张的话，那么声如其人至少会恰当一些的吧。</p>
<p> </p>
<p>在刚刚认识的那一年，她送了我好多英文书，在某本书的扉页上她写下了这样的一句话：</p>
<p>Hope is a waking dream.</p>
<p>希望是醒来的梦。</p>
<p>这句话是那个时候一个名字叫做“第十区”的游戏里面的，那个游戏怎么玩已经不记得了，但是记得很清楚她说她很喜欢游戏的配乐。</p>
<p> </p>
<p>也许是6年前的春天吧，那一年我在学校教学楼下透气，看了下日期恰巧是她的生日，于是便和她说了生日快乐。</p>
<p>时光飞快，接下来的几年几乎没有什么联系。</p>
<p> </p>
<p>在思科工作的时候，那一天突然接到了她的吐槽。很短暂的一次交流。虽然很久没有联系，但是也许关系不会变的吧。也许在她的心中，她还是蛮信任我的吧，所以才会和我说出这样比较私密的话题。</p>
<p> </p>
<p>两年前，在我动身来上海之前，在那家日企的茶水间，我再次听到了她的声音。她想跟我借点钱。我犹豫了一下，我知道这其中的风险，我连这个人都没有见过，很有可能会人财两空，哦不对，只有财空。见过很多其他人的例子，几年不说话，上来就借钱，借完人就失踪，欠钱的都是大爷。</p>
<p>转念我又在想，她应该不会是这样的人吧！她的声音那么温柔，对我又很体贴，是受过高等教育的人，应该不会的吧。简单的验证了身份之后，我打消了顾虑，我便把钱转给了她。</p>
<p>当然了，她怎么会骗我呢。事实证明，我的选择果然没有错。Trust is earned.</p>
<p> </p>
<p>一年前的夏天，她和我说她要来上海，我很开心，说好了等她到了请她吃我最喜欢的烤肉和烤鱼。</p>
<p>说来也巧，那段时间因为前女友，恰巧是最郁闷的时候，郁闷到甚至想到了死。</p>
<p>于是我便给自己找个新的散步的理由。在浦东新区，在夏日里，骑着能把屁股捅个洞的共享单车，我去实地考察了几乎所有她想去的地方。更巧的是，每次总是在到家之后就开始瓢泼大雨。是不是她在南方念着咒语守护着我呢。</p>
<p>那几个月，她的这个计划应该是我听到的最好的消息了。</p>
<p> </p>
<p>可是，之后有关她的消息，我就全然不知道了。</p>
<p>完全联系不到，发消息也不回，就仿佛人间蒸发了一样，有些担心她是不是出事了。我们的关系还没有好到可以直接打电话的地步吧？而且她说她接到电话会PTSD，那就更不要打了。</p>
<p>不知道何时，有一次偶然在网易云音乐上看到她分享了几首歌，内心也释然了，人还在，问题应该不大，也许是有什么难言之隐吧。</p>
<p> </p>
<p>按照原计划，今年的劳动节期间，是打算去广东玩一玩的。见两位从未见过面的朋友，包括这位A，还有一个帮我从澳门带回来Xbox的高中同学。</p>
<p> </p>
<p>意料之外、但也是意料之内的封城了。先是深圳，于是我主动联系她。</p>
<p>此时，才知道她已经跑到了江浙一带，已经不在深圳了，才知道她的微信号曾经被封，又不知道我的其他联系方式。所以才这样gone dark</p>
<p>就这样重新建立了联系。</p>
<p> </p>
<p>「我们以后出去工作出去生活怎么样」，我便被这样的一句话彻底打动了。发现了我们是一样的人。直到今天，直到此时此刻。</p>
<p> </p>
<p>《影响力》中说到，我们喜欢那些与我们相似的人。不管他们是在观点上、个性上、背景上，还是生活方式上与我们相似，都会使我们对他们产生好感。也许正是因为这个相似性的心理弱点，我无可救药地被她吸引着。</p>
<p> </p>
<p>你的一言一语，你的每一朵小花花，每一颗小心心，每一句关怀和问候，都像磁性越来越强的磁铁，越来越快、越来越强地吸引着我。我不知道终点是什么，我不知道最终的碰撞会怎样，我只知道这一切仿佛就是物理定律，无法抵抗。</p>
<p>可是，我心里很清楚，这是我不应该做的事情，我不可以喜欢上不应该喜欢的人。我已经在拼命克制了啊。</p>
<p><img src="/images/202204232355407.jpeg"></p>
<p>You came and saved me through the night. So I promise you</p>
<p>I’ll be by your side</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/23/spring-shanghai/index/" data-id="clhp7rtk7008ws2qrclr106kp" data-title="被偷走了春天的上海" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-telegram-cjk-search/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/05/telegram-cjk-search/index/" class="article-date">
  <time class="dt-published" datetime="2022-04-05T00:00:00.000Z" itemprop="datePublished">2022-04-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/05/telegram-cjk-search/index/">让Telegram支持中文搜索！</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>众所周知，Telegram是一款非常优秀的即时通信工具，可比那个不知名的绿色图标的软件好多了。Telegram不仅使用更安全，应用程序也很小，还支持多客户端登录，消息跨平台无限制同步。</p>
<p><img src="/images/2022040513585338.jpeg"></p>
<p>尽管Telegram这么棒，但是对于中国用户来说，最致命的一个缺点就是搜索。这一点对不是用分词的CJK用户来说也是一样的。想要搜索点什么东西，那简直就是要了命了，必须要输入整个句子。</p>
<h2 id="有啥办法可以解决这个问题吗？"><a href="#有啥办法可以解决这个问题吗？" class="headerlink" title="有啥办法可以解决这个问题吗？"></a>有啥办法可以解决这个问题吗？</h2><p>一个最常见的方法是，使用Telegram Desktop，注意是Telegram Desktop，用C++写的那个，导出聊天记录为json，然后搜索。</p>
<p>可这样也太繁琐了吧！有没有什么更好的方案呢……</p>
<p>一个方法是魔改Telegram的客户端，反正也是开源的，能搜本地数据库就搜本地的吧，至于需要请求服务器搜索的，那大概率是没救了。可惜我既不会swift也不会c++，更何况我估计以我的小脑瓜我也看不懂他们的代码……</p>
<p>另一个方法就是自己保存一份！还记得Telegram支持多客户端登录吗，那我们如果拿来一个client用来把文字消息保存到数据库中，后续再从数据库中查询，那不就有了嘛！</p>
<p>[v_error]嗯，这么做像极了某绿色软件：「看了会被开除，我们不保存聊天记录」 [&#x2F;v_error] 说干就干！</p>
<p><img src="/images/2022040513585313.jpeg"></p>
<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><p>需要用MTProto协议，那么最好就是用纯Python实现的pyrogram了，用TDLib什么的太麻烦了。</p>
<p>数据库就用ElasticSearch吧，全文检索更方便。  算了算了，ES惹不起，用MongoDB吧</p>
<p>一个client，登录账号，把收和发的消息保存到数据库中。</p>
<p>一个bot，用于从数据库中检索数据。</p>
<p>加上一些身份验证之类的。</p>
<h2 id="使用截图"><a href="#使用截图" class="headerlink" title="使用截图"></a>使用截图</h2><p>详细功能说明可以移步GitHub</p>
<p><img src="/images/2022040513585435.jpeg"></p>
<p><img src="/images/2022040513585636.png"></p>
<p>从此以后CJK再无烦恼😂</p>
<p>总计代码也就400多行！</p>
<p>由于这种操作涉及到个人聊天记录，是非常敏感且重要的信息，因此不提供任何公开bot，需要自己部署一份。</p>
<p>看这ES跑得多欢快，就像脱缰的野马一样，配合上kibana这个劝退的工具简直天生一对😠</p>
<p><img src="/images/2022040513585967.png"></p>
<h2 id="开源地址"><a href="#开源地址" class="headerlink" title="开源地址"></a>开源地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/SearchGram">https://github.com/tgbot-collection/SearchGram</a></p>
<p>放到了这里，😂还打算做 chat history import的功能，就是今天太累了……蹲一个PR吧。</p>
<p>具体部署方法在那边也有，写的应该比较详细了。这里就不复述了。</p>
<p>能用就行，从此再也不怕搜不到聊天记录了.jpg</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/05/telegram-cjk-search/index/" data-id="clhp7rtl8009is2qr2ov67jsh" data-title="让Telegram支持中文搜索！" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zph01-pm25-voc/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/22/zph01-pm25-voc/index/" class="article-date">
  <time class="dt-published" datetime="2022-02-22T00:00:00.000Z" itemprop="datePublished">2022-02-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/what/">what</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/22/zph01-pm25-voc/index/">在树莓派上使用ZPH01监测PM2.5和VOC</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>前几天发现我的Xbox内置存储空间不足了，希捷的Xbox Expansion Card又太贵了，发现bilibili有人发了一篇文章可以DIY这个扩展卡<a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv13060807">《【全站首发？】自制次世代XBOX专用存储卡（扩容）》</a>。技术原理并不复杂，就是一个CFe到NVMe的转接器+微软定制CH SN530。</p>
<p>但是这个转接器又太贵了，海鲜市场都要100元，在网上搜到了有开源的设计，<a target="_blank" rel="noopener" href="https://github.com/neg2led/cfxsx">https://github.com/neg2led/cfxsx</a>，恰巧国内的嘉立创可以免费给打样，于是我就去打了一个，顺便买了点电子元件回来玩。</p>
<p><img src="/images/2022022221294250.png"></p>
<p>这么好的东西，既能检测PM2.5还能检测VOC（可挥发性有机物），当然要留给树莓派啊</p>
<h2 id="了解ZPH01"><a href="#了解ZPH01" class="headerlink" title="了解ZPH01"></a>了解ZPH01</h2><p>ZPH01有两种输出，PWM和UART，先不管这是什么……</p>
<p>有5个针脚，如下表所示</p>
<table><tbody><tr><td>PIN1</td><td>控制脚，悬空为PWM，接地为UART</td></tr><tr><td>PIN2</td><td>输出脚 OUT2/RXD/PM2.5</td></tr><tr><td>PIN3</td><td>电源正(VCC)</td></tr><tr><td>PIN4</td><td>输出脚 OUT1/TXD/VOC 等级</td></tr><tr><td>PIN5</td><td>电源地(GND)</td></tr></tbody></table>

<h2 id="接线"><a href="#接线" class="headerlink" title="接线"></a>接线</h2><p>于是我就把用杜邦线接上了，两个输出分别接到了16号GPIO23和18号GPIO24</p>
<p><img src="/images/2022022221294661.png"></p>
<h2 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h2><p>import RPi.GPIO as GPIO</p>
<h1 id="BOARD是树莓派上的编号，比如我接的是GPIO23，编号是16。也可以用BCM，那么编号就是23了。"><a href="#BOARD是树莓派上的编号，比如我接的是GPIO23，编号是16。也可以用BCM，那么编号就是23了。" class="headerlink" title="BOARD是树莓派上的编号，比如我接的是GPIO23，编号是16。也可以用BCM，那么编号就是23了。"></a>BOARD是树莓派上的编号，比如我接的是GPIO23，编号是16。也可以用BCM，那么编号就是23了。</h1><p>GPIO.setmode(GPIO.BOARD)</p>
<p>GPIO.setup(16, GPIO.IN, pull_up_down&#x3D;GPIO.PUD_DOWN)<br>GPIO.input(16) # 获取输入，如果想要输出高电压，那就GPIO.OUTPUT(16,GPIO.HIGH)</p>
<p>GPIO.setup(18, GPIO.IN, pull_up_down&#x3D;GPIO.PUD_DOWN)<br>GPIO.input(18)</p>
<p>这样就能够获取到GPIO针脚的输入，要么是0，要么是1，在我看来这玩意就有点随机变化的感觉了。</p>
<p>然后呢？で？</p>
<p><img src="/images/2022022221294735.jpeg" alt="高手看不懂- 斗图发表情包- 斗图王"></p>
<h2 id="PWM"><a href="#PWM" class="headerlink" title="PWM"></a>PWM</h2><p>脉冲宽度调制（英语：Pulse-width modulation，缩写：PWM），简称脉宽调制，是将模拟信号变换为脉冲的一种技术。</p>
<p>emm咋说呢，举例来看，说明书里有这样一个波形，当我从GPIO中读到0度时候，那么就是低脉冲（低电压），读到1的时候，那么就是高脉冲（高电压）。</p>
<p><img src="/images/2022022221294838.png"></p>
<p>这个设备的脉冲周期是1秒，也就是说，如果我在1秒的时间范围内，读到了200ms读低脉冲，那么低脉冲率就是20%。那么这个低脉冲率有什么用？</p>
<p>继续往下看手册，发现了这么一个图</p>
<p><img src="/images/2022022221295069.png"></p>
<p>哟呵，这不是初中学过的一次函数吗？低脉冲率为10%，差不多意味着平均有6000个PM2.5颗粒。</p>
<p>同理，颗粒物浓度也是有一个一次函数图表，可以根据低脉冲率计算出颗粒物浓度。</p>
<p>再次同理，VOC的输出也可以计算低脉冲率，根据说明书10%的低脉冲率就是VOC1级，20%就是2级，也就分别对应优和良。这个设备会输出四个等级，可惜的是无法辨别化合物的类别。</p>
<p>那么也就是说，写一个算法，一秒钟取样，就能拿到环境中的数据了。</p>
<p>emmm我不会写，我太菜了。</p>
<p><img src="/images/2022022221295158.jpeg" alt="我太菜了表情包_表情包_图片_头像_易搜表情包网"></p>
<h2 id="UART"><a href="#UART" class="headerlink" title="UART"></a>UART</h2><p>通用异步收发传输器（Universal Asynchronous Receiver&#x2F;Transmitter，通常称为UART）是一种异步收发传输器，是电脑硬件的一部分，将数据透过串列通信进行传输。</p>
<p>emm就是一种串口啦，恰巧树莓派上的8和10就是UART的TX和RX。TX是发送数据，RX是接收数据。</p>
<p>ZPH01在控制口接地的时候，输出模式会变成UART，1秒输出一次。连接参数是这样的</p>
<table><tbody><tr><td>波特率</td><td>9600</td></tr><tr><td>数据位</td><td>8</td></tr><tr><td>停止位</td><td>1</td></tr><tr><td>校验位</td><td>无</td></tr></tbody></table>

<p>数据格式是这样的</p>
<table><tbody><tr><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td></tr><tr><td>起始位</td><td>检测类型编码</td><td>单位（低脉冲率）</td><td>低脉冲率整数部分</td><td>低脉冲率小数部分</td><td>预留</td><td>模式</td><td>VOC登记</td><td>校验值</td></tr><tr><td>0xFF</td><td>0x18</td><td>0x00</td><td>0x00-0x63</td><td>0x00-0x63</td><td>0x00</td><td>0x01</td><td>0x00-0x03</td><td>0x00-0xFF</td></tr></tbody></table>

<h2 id="树莓派使用串口"><a href="#树莓派使用串口" class="headerlink" title="树莓派使用串口"></a>树莓派使用串口</h2><p>树莓派有两个串口，一个是模拟的<code>ttyS0</code>，一个是硬件的<code>ttyAMA0</code>。硬件的那个更靠谱，波特率不会受到CPU频率的影响。</p>
<p>我用的是Ubuntu，启用串口大概可以<a target="_blank" rel="noopener" href="https://askubuntu.com/a/1325939/1037895">参考这篇问答</a>，简单摘抄如下：</p>
<p>sudo systemctl stop <a href="mailto:&#x73;&#101;&#x72;&#105;&#97;&#108;&#x2d;&#x67;&#101;&#116;&#116;&#121;&#64;&#116;&#x74;&#121;&#x53;&#48;&#46;&#115;&#101;&#x72;&#x76;&#105;&#99;&#x65;">&#x73;&#101;&#x72;&#105;&#97;&#108;&#x2d;&#x67;&#101;&#116;&#116;&#121;&#64;&#116;&#x74;&#121;&#x53;&#48;&#46;&#115;&#101;&#x72;&#x76;&#105;&#99;&#x65;</a><br>sudo systemctl disable <a href="mailto:&#x73;&#101;&#114;&#105;&#97;&#x6c;&#45;&#x67;&#101;&#116;&#x74;&#121;&#64;&#116;&#x74;&#x79;&#x53;&#x30;&#x2e;&#x73;&#x65;&#x72;&#118;&#105;&#x63;&#101;">&#x73;&#101;&#114;&#105;&#97;&#x6c;&#45;&#x67;&#101;&#116;&#x74;&#121;&#64;&#116;&#x74;&#x79;&#x53;&#x30;&#x2e;&#x73;&#x65;&#x72;&#118;&#105;&#x63;&#101;</a><br>sudo systemctl mask <a href="mailto:&#x73;&#101;&#114;&#105;&#x61;&#108;&#x2d;&#x67;&#x65;&#116;&#116;&#x79;&#64;&#116;&#x74;&#121;&#x53;&#x30;&#x2e;&#115;&#101;&#x72;&#x76;&#x69;&#99;&#101;">&#x73;&#101;&#114;&#105;&#x61;&#108;&#x2d;&#x67;&#x65;&#116;&#116;&#x79;&#64;&#116;&#x74;&#121;&#x53;&#x30;&#x2e;&#115;&#101;&#x72;&#x76;&#x69;&#99;&#101;</a></p>
<h1 id="x2F-etc-x2F-udev-x2F-rules-d-x2F-10-local-rules"><a href="#x2F-etc-x2F-udev-x2F-rules-d-x2F-10-local-rules" class="headerlink" title="&#x2F;etc&#x2F;udev&#x2F;rules.d&#x2F;10-local.rules"></a>&#x2F;etc&#x2F;udev&#x2F;rules.d&#x2F;10-local.rules</h1><p>KERNEL&#x3D;&#x3D;”ttyS0”, SYMLINK+&#x3D;”serial0” GROUP&#x3D;”tty” MODE&#x3D;”0660”<br>KERNEL&#x3D;&#x3D;”ttyAMA0”, SYMLINK+&#x3D;”serial1” GROUP&#x3D;”tty” MODE&#x3D;”0660”</p>
<p>sudo udevadm control –reload-rules &amp;&amp; sudo udevadm trigger<br>sudo adduser $USER tty</p>
<h1 id="remove-console-x3D-serial0-115200-from-x2F-boot-x2F-firmware-x2F-cmdline-txt"><a href="#remove-console-x3D-serial0-115200-from-x2F-boot-x2F-firmware-x2F-cmdline-txt" class="headerlink" title="remove console&#x3D;serial0,115200 from &#x2F;boot&#x2F;firmware&#x2F;cmdline.txt"></a>remove console&#x3D;serial0,115200 from &#x2F;boot&#x2F;firmware&#x2F;cmdline.txt</h1><h1 id="add-newline-dtoverlay-x3D-disable-bt-to-x2F-boot-x2F-firmware-x2F-config-txt"><a href="#add-newline-dtoverlay-x3D-disable-bt-to-x2F-boot-x2F-firmware-x2F-config-txt" class="headerlink" title="add newline dtoverlay&#x3D;disable-bt to &#x2F;boot&#x2F;firmware&#x2F;config.txt"></a>add newline dtoverlay&#x3D;disable-bt to &#x2F;boot&#x2F;firmware&#x2F;config.txt</h1><p>重启之后就可以了，ls可以看到串口</p>
<p>lrwxrwxrwx 1 root root 5 Jan 10 04:56 &#x2F;dev&#x2F;serial0 -&gt; ttyS0<br>lrwxrwxrwx 1 root root 7 Jan 10 04:56 &#x2F;dev&#x2F;serial1 -&gt; ttyAMA0</p>
<p>此时我们可以把ZPH01的TXD也就是PIN4接到树莓派的10号口GPIO15</p>
<p>然后打开minicom看下有没有数据：</p>
<p>sudo minicom</p>
<p>Ctrl+A+Z然后再按O可以设置串口</p>
<p><img src="/images/2022022221295236.png"></p>
<p>波特率9600，数据位校验位根据上面的图标设置，8N1就对了</p>
<p>在screen and keyboard中按S可以显示hex（十六进制）</p>
<p><img src="/images/2022022221295352.png"></p>
<p>保存退出之后就会发现，屏幕上出现了神奇的16进制数字，每到一组ff意味着出现了新的一组数据，也就是说<code>ff 18 00 02 3a 00 01 00 ab</code>这便是一组数据了。</p>
<p><img src="/images/2022022221295495.jpeg"></p>
<p>同时用Python也可以读得到这些数据的</p>
<p><img src="/images/2022022221295528.png"></p>
<p>那么VOC等级是7，也就是00，那么就是优；撒点酒精到传感器旁边，</p>
<p><img src="/images/2022022221295723.jpeg"></p>
<p>诚不欺我！</p>
<p>PM2.5的低脉冲率，根据数据格式，是3和4，<code>0x00+0x39/100</code>，也就是</p>
<p>&gt;&gt;&gt; int(data[3], 16) + int(data[4], 16) &#x2F; 100<br>0.57</p>
<p>0.57%，再根据图标计算出一次方程的……公式，就可以得出来值了。</p>
<h2 id="库"><a href="#库" class="headerlink" title="库"></a>库</h2><p>为方便自己搞事情，我写了个<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ZPH01">简单的library</a>，可以用来处理这些数据，同时加上了PM2.5的欧盟标准</p>
<p>具体使用方法如下，先安装 <code>pip install zph01</code></p>
<p>&gt;&gt;&gt; from zph01 import ZPH01</p>
<blockquote>
<blockquote>
<blockquote>
<p>zph &#x3D; ZPH01()<br>zph.output()<br>{‘VOC status’: ‘Good’, ‘PM 2.5 percent’: 1.6, ‘PM 2.5 count’: 960.0, ‘PM 2.5 level’: 32.0, ‘PM 2.5 status’: ‘Poor’}</p>
</blockquote>
</blockquote>
</blockquote>
<p>哈哈哈够用就好</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><ul>
<li>放在角落里吃灰，先不弄InfluxDB+Grafana了。这玩意有啥用啊……真是的😂浪费钱浪费精力，熬了两个晚上哦。</li>
<li>等我的CFe到了，我会再搞一波。不过CH SN530是奇葩的PCIe 4.0x2，竟然只有两个通道，并且国外有小哥测试过PCIe 4.0x4和3.0x4的都不行。CH SN530主控是PS5019-E19。也许等微软开放了限制就可以了？谁知道他们有没有签什么独家协议以及如果有，什么时候到期……</li>
</ul>
<p><img src="/images/2022022221300146.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/22/zph01-pm25-voc/index/" data-id="clhp7rto300c6s2qr6w478dew" data-title="在树莓派上使用ZPH01监测PM2.5和VOC" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-container-hot-patch/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/02/container-hot-patch/index/" class="article-date">
  <time class="dt-published" datetime="2022-02-02T00:00:00.000Z" itemprop="datePublished">2022-02-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/02/container-hot-patch/index/">Docker container热更新</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我的YouTube Download有一个worker是<a target="_blank" rel="noopener" href="https://nova.moe/">麻烦盆友帮我跑的</a>，每次更新代码都要让人家重新pull image然后再up，有没有什么能够让我没有ssh也能自助更新代码吗？</p>
<p>最简单的办法是把docker的socket暴露给容器，这样容器就可以为所欲为了。但是这也太危险而且太麻烦</p>
<p>既然大部分情况下也都是更新代码，不会有太大的变更，那么似乎只要想办法把代码更新一下，然后重启下容器内的进程就可以了。</p>
<h2 id="容器内使用git"><a href="#容器内使用git" class="headerlink" title="容器内使用git"></a>容器内使用git</h2><p>首先，要确保在Dockerfile中安装了git哦。</p>
<p>我的image都是使用GitHub Actions构建的，并且不知道GitHub Actions给我加入了什么神奇的配置项，导致无法无缝pull。毕竟我的仓库是公开的啊🤔</p>
<p>反正image也是公开的，我就不打码了</p>
<p><img src="/images/2022020217083765.jpeg"></p>
<p>所以首先要魔改一下，先给unset掉</p>
<p>git config –unset http.<a target="_blank" rel="noopener" href="https://github.com/.extraheader">https://github.com/.extraheader</a></p>
<p>然后unshallow pull</p>
<p>git pull origin –unshallow</p>
<p>下次就可以正常的git pull了，大概的代码如下，能用就行</p>
<p>git_path &#x3D; “your project root” # or maybe pathlib.Path().cwd().parent.as_posix()<br>logging.info(“Hot patching on path %s…”, git_path)</p>
<p>unset &#x3D; “git config –unset http.<a target="_blank" rel="noopener" href="https://github.com/.extraheader">https://github.com/.extraheader</a>“<br>pull_unshallow &#x3D; “git pull origin –unshallow”<br>pull &#x3D; “git pull”</p>
<p>subprocess.call(unset, shell&#x3D;True, cwd&#x3D;git_path)<br>if subprocess.call(pull_unshallow, shell&#x3D;True, cwd&#x3D;git_path) !&#x3D; 0:<br>    logging.info(“Already unshallow, pulling now…”)<br>    subprocess.call(pull, shell&#x3D;True, cwd&#x3D;git_path)</p>
<h2 id="重启应用程序"><a href="#重启应用程序" class="headerlink" title="重启应用程序"></a>重启应用程序</h2><p>自动重启应用方法很多，只要确保容器不被删除直接restart就可以。然后我们需要用一个守护进程来帮忙拉起来，比如docker的restart policy可以设置成<code>on-failure</code>，或者容器内上supervisor也不是不行。</p>
<p>问题是如何退出进程呢？</p>
<p>并对于运行在主线程中的处理函数来说，类似 <code>sys.exit(1)</code>就可以。注意exit code要和restart policy相配合。比如restart policy是<code>on-failure</code>，那么<code>exit(0)</code> 就不行了</p>
<p>对于运行在子线程中的处理函数，exit只会退出当前线程而不会把主线程退出。那么一个简单有效的办法就是获取到整个进程的PID，然后kill掉，Python的psutil提供了这样的功能：</p>
<p>psutil.Process().kill()</p>
<p>使用<code>kill</code>而不是<code>terminate</code>也是为了避免exit code是0的问题</p>
<p>如果想要通过apscheduler的<code>BackgroundScheduler</code>来让自己完全自杀，那么这样就是比较好的了。</p>
<h2 id="celery-worker-broadcast"><a href="#celery-worker-broadcast" class="headerlink" title="celery worker broadcast"></a>celery worker broadcast</h2><p>我的YouTube Download的整体架构是master+N个worker的模式。因此在热更新的时候不仅要更新master，也要把worker都更新了。</p>
<p>直接发布消息是不行的，除非只有一个worker，所以我们需要发布broadcast来确保所有的worker都会收到并且执行命令。</p>
<p>app.control.broadcast(“ping”)</p>
<p>ping就是表示让worker执行的命令，默认大概有几十个，包括ping、revoke、heartbeat什么的。</p>
<p>我们可以自定义一个command，使用<code>@Panel.register</code>装饰器</p>
<p>from celery.worker.control import Panel<br>@Panel.register<br>def hello (*args):<br>    print(“patch…”)</p>
<p><img src="/images/2022020217083878.png"></p>
<p>然后</p>
<p>app.control.broadcast(“hello”)</p>
<p>所有worker就都能收到这条消息了</p>
<h2 id="更多……"><a href="#更多……" class="headerlink" title="更多……"></a>更多……</h2><p>更有甚者，可以自定义好在热更新的时候要做什么，比如更新代码，更新 Python Packages，更新系统相关工具。反正无非就是在容器内各种subprocess就好了。</p>
<p>当然了别忘了做权限控制，要不然就RCE啦😏😏😏😏😏</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p># tasks.py<br>import psutil<br>from celery.worker.control import Panel</p>
<p>@Panel.register<br>def hot_patch(*args):<br>    git_path &#x3D; “your project root” # or maybe pathlib.Path().cwd().parent.as_posix()<br>    logging.info(“Hot patching on path %s…”, git_path)</p>
<pre><code>unset = &quot;git config --unset http.https://github.com/.extraheader&quot;
pull\_unshallow = &quot;git pull origin --unshallow&quot;
pull = &quot;git pull&quot;

subprocess.call(unset, shell=True, cwd=git\_path)
if subprocess.call(pull\_unshallow, shell=True, cwd=git\_path) != 0:
    logging.info(&quot;Already unshallow, pulling now...&quot;)
    subprocess.call(pull, shell=True, cwd=git\_path)

logging.info(&quot;Code is updated, applying hot patch now...&quot;)
psutil.Process().kill()
</code></pre>
<h1 id="control"><a href="#control" class="headerlink" title="control"></a>control</h1><p>app.control.broadcast(“hot_patch”)</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/ytdlbot/blob/master/ytdlbot/tasks.py#L246">https://github.com/tgbot-collection/ytdlbot/blob/master/ytdlbot/tasks.py#L246</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tgbot-collection/ytdlbot/blob/master/ytdlbot/ytdl_bot.py#L100">https://github.com/tgbot-collection/ytdlbot/blob/master/ytdlbot/ytdl_bot.py#L100</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/q/65204671/10264400">https://stackoverflow.com/q/65204671/10264400</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/02/container-hot-patch/index/" data-id="clhp7rtf6001js2qr348pb9ta" data-title="Docker container热更新" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/azure/">azure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/china/">china</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/china/justsay/">justsay</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloudflare/">cloudflare</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">it</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/">justsay</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/website/">website</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/program/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/security/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">share</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/website/">website</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/website/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/what/">what</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/what/gfw/">gfw</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/10/06/aca-vm-scale/index/">Azure Container Apps 连接到虚拟机并配置CPU自动缩放</a>
          </li>
        
          <li>
            <a href="/2024/09/28/worker-image-metadata/index/">使用 Cloudflare Worker获取图片元数据</a>
          </li>
        
          <li>
            <a href="/2024/09/27/workers-function/index/">将 Cloudflare Workers 迁移到 Azure Function</a>
          </li>
        
          <li>
            <a href="/2024/09/21/one-api-clickhouse/index/">one-api/new-api性能优化：使用 ClickHouse 作为日志系统</a>
          </li>
        
          <li>
            <a href="/2024/08/03/stripe-fraud/index/">Stripe 如何安全收款并避免盗刷与测卡</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Benny小土豆<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>